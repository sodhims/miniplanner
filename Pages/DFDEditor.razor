@page "/"

@using Microsoft.AspNetCore.Components.Web
@using dfd2wasm.Services
@using dfd2wasm.Models

<div class="dfd-container" tabindex="0" @onkeydown="HandleKeyDown">
    <div class="toolbar">
        <h1 @onclick="@(() => showAboutDialog = true)" style="cursor: pointer;" title="Click for About">MiniPlanner</h1>
        
        <div class="zoom-controls">
            <button @onclick="ZoomOut" disabled="@(zoomLevel <= 0.25)" title="Zoom Out">−</button>
            <input type="range" 
                   min="25" max="300" step="5" 
                   value="@((int)(zoomLevel * 100))"
                   @onchange="@(e => zoomLevel = int.Parse(e.Value?.ToString() ?? "100") / 100.0)"
                   class="zoom-slider"
                   title="Zoom: @((int)(zoomLevel * 100))%" />
            <span class="zoom-level">@((int)(zoomLevel * 100))%</span>
            <button @onclick="ZoomIn" disabled="@(zoomLevel >= 3.0)" title="Zoom In">+</button>
            <button @onclick="@(() => zoomLevel = 1.0)" title="Reset Zoom">⟲</button>
            <button @onclick="ZoomToFit" title="Zoom to Fit">⊡</button>
        </div>

        <div class="toolbar-buttons">
            @* Select Mode Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger @(mode == EditorMode.Select && !IsConnectModeActive() ? "active" : "")"
                        @onclick="@(() => { mode = EditorMode.Select; selectMode = SelectModeType.Single; ClearConnectMode(); })"
                        title="Select mode (S)">
                    ✋ Select @(GetSelectModeLabel()) ▾
                </button>
                <div class="dropdown-menu">
                    <button class="@(mode == EditorMode.Select && selectMode == SelectModeType.Single && !IsConnectModeActive() ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; selectMode = SelectModeType.Single; ClearConnectMode(); })">
                        ✋ Single
                    </button>
                    <button class="@(selectMode == SelectModeType.Area ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; selectMode = SelectModeType.Area; ClearConnectMode(); })"
                            title="Drag to select multiple items">
                        ▢ Area Select
                    </button>
                    <div class="dropdown-divider"></div>
                    <button @onclick="@(() => { SelectAllNodes(); ClearConnectMode(); })"
                            title="Select all nodes (Ctrl+A)">
                        ◫ All Nodes
                    </button>
                    <button @onclick="@(() => { SelectAllEdges(); ClearConnectMode(); })"
                            title="Select all edges">
                        ⟷ All Edges
                    </button>
                </div>
            </div>

            @* Connect Mode Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger @(IsConnectModeActive() ? "active" : "")"
                        @onclick="@(() => { mode = EditorMode.Select; ActivateTwoClickMode(); })"
                        title="Connect mode - click source then target (C)">
                    🔗 Connect @(GetConnectModeLabel()) ▾
                </button>
                <div class="dropdown-menu">
                    <button class="@(connectionMode == ConnectionModeType.TwoClick ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; ActivateTwoClickMode(); })"
                            title="Click source, click target, done">
                        🔗 Two-Click (Default)
                    </button>
                    <button class="@(connectionMode == ConnectionModeType.Chain ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; ActivateChainMode(); })"
                            title="Click nodes in sequence to connect them">
                        ⛓ Chain
                    </button>
                    <button class="@(connectionMode == ConnectionModeType.OneToN ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; SetConnectionMode(ConnectionModeType.OneToN); })"
                            title="Click source, then click each target">
                        🔀 1:N Click
                    </button>
                    <button class="@(connectionMode == ConnectionModeType.OneToNArea ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; SetConnectionMode(ConnectionModeType.OneToNArea); })"
                            title="Click source, then drag to select targets">
                        ▢ 1:N Area
                    </button>
                    <div class="dropdown-divider"></div>
                    <button @onclick="@(() => { ClearConnectMode(); })"
                            title="Exit connect mode (Esc)">
                        ✕ Cancel
                    </button>
                </div>
            </div>

            @* Add Shape Button *@
            <button class="@(mode == EditorMode.AddNode ? "active" : "")"
                    @onclick="@(() => { mode = EditorMode.AddNode; chainMode = false; multiConnectMode = false; ClearMultiConnectState(); ClearConnectMode(); })"
                    title="Add shape mode (A)">
                ➕ Add Shape
            </button>

            @* Terminal Mode Checkbox - only for flowchart/circuit/sts templates *@
            @if (selectedTemplateId == "flowchart" || selectedTemplateId == "circuit" || selectedTemplateId == "sts" || selectedTemplateId == "default" || string.IsNullOrEmpty(selectedTemplateId))
            {
                <label class="toolbar-checkbox @(terminalModeEnabled ? "active" : "")" title="Enable STS-style terminals on new shapes (T)">
                    <input type="checkbox" @bind="terminalModeEnabled" />
                    🔌 Terminals
                </label>
            }

            @* Options Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger @(arrayMode || snapToGrid || useOrthoPlacement ? "active" : "")">
                    📐 Options ▾
                </button>
                <div class="dropdown-menu">
                    <button class="@(useOrthoPlacement ? "active" : "")"
                            @onclick="@(() => ToggleOrthoMode())"
                            title="Use orthogonal edges">
                        📐 Ortho Mode @(useOrthoPlacement ? "✓" : "")
                    </button>
                    <button class="@(snapToGrid ? "active" : "")"
                            @onclick="@(() => snapToGrid = !snapToGrid)">
                        🧲 Snap to Grid @(snapToGrid ? "✓" : "")
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="@(arrayMode ? "active" : "")"
                            @onclick="@(() => { arrayMode = !arrayMode; if (arrayMode) mode = EditorMode.AddNode; })"
                            title="Place multiple shapes at once">
                        📊 Array Mode @(arrayMode ? "✓" : "")
                    </button>
                    @if (arrayMode)
                    {
                        <div class="dropdown-submenu">
                            <span class="submenu-label">Orientation:</span>
                            <button class="@(arrayOrientation == "horizontal" ? "active" : "")"
                                    @onclick="@(() => arrayOrientation = "horizontal")">
                                Horizontal ███
                            </button>
                            <button class="@(arrayOrientation == "vertical" ? "active" : "")"
                                    @onclick="@(() => arrayOrientation = "vertical")">
                                Vertical
                            </button>
                            <span class="submenu-label">Count:</span>
                            <select @bind="arrayCount" class="dropdown-select">
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                    }
                </div>
            </div>

            @* Align Dropdown - only when 2+ nodes selected *@
            @if (selectedNodes.Count >= 2)
            {
                <div class="toolbar-dropdown">
                    <button class="dropdown-trigger">
                        📏 Align ▾
                    </button>
                    <div class="dropdown-menu dropdown-menu-wide">
                        <div class="dropdown-row">
                            <span class="submenu-label">Horizontal:</span>
                            <button @onclick="AlignLeft" title="Align Left">⬅ Left</button>
                            <button @onclick="AlignCenterH" title="Align Center">⬌ Center</button>
                            <button @onclick="AlignRight" title="Align Right">➡ Right</button>
                        </div>
                        <div class="dropdown-row">
                            <span class="submenu-label">Vertical:</span>
                            <button @onclick="AlignTop" title="Align Top">⬆ Top</button>
                            <button @onclick="AlignCenterV" title="Align Center">⬍ Center</button>
                            <button @onclick="AlignBottom" title="Align Bottom">⬇ Bottom</button>
                        </div>
                        @if (selectedNodes.Count >= 3)
                        {
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-row">
                                <span class="submenu-label">Distribute:</span>
                                <button @onclick="DistributeH" title="Distribute Horizontally">↔ Horizontal</button>
                                <button @onclick="DistributeV" title="Distribute Vertically">↕ Vertical</button>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-row">
                                <span class="submenu-label">Arrange:</span>
                                <button @onclick="@(() => ArrangeInGrid(0))" title="Arrange in auto grid">⊞ Grid</button>
                                <button @onclick="@(() => ArrangeInGrid(1))" title="Arrange in single row">▤ Row</button>
                                <button @onclick="@(() => ArrangeInGrid(selectedNodes.Count))" title="Arrange in single column">▥ Column</button>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Examples Dropdown - shows different examples based on selected template *@
            @if (selectedTemplateId != "project" && selectedTemplateId != "gantt")
            {
                <div class="toolbar-dropdown">
                    <button class="dropdown-trigger" @onclick="@(() => showExamplesMenu = !showExamplesMenu)">
                        📋 Examples ▾
                    </button>
                    @if (showExamplesMenu)
                    {
                        <div class="dropdown-menu">
                            @foreach (var example in Examples)
                            {
                                <button @onclick="@(() => LoadExample(example.Key))" title="@example.Value.Description">
                                    @example.Value.Name
                                </button>
                            }
                        </div>
                    }
                </div>
            }

            @* Export/Print Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger">
                    🖨️ Print ▾
                </button>
                <div class="dropdown-menu">
                    <button @onclick="TogglePrintAreaSelection"
                            class="@(isPrintAreaSelection ? "active" : "")"
                            title="Draw a box around the area to export">
                        📄 @(isPrintAreaSelection ? "Cancel Selection" : "Select Area")
                    </button>
                    <button @onclick="PrintAll"
                            title="Print entire canvas">
                        🖨️ Print All
                    </button>
                </div>
            </div>


            @* Layout Dropdown - only for flowchart/DFD templates (not project/gantt) *@
            @if (selectedTemplateId != "project" && selectedTemplateId != "gantt")
            {
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger">
                    ⚡ Layout ▾
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section-header">📐 Auto Layout</div>
                    <button @onclick="ApplyForceDirectedLayout" title="Organic layout using physics simulation">
                        🔀 Force-Directed
                    </button>
                    <button @onclick="ApplySugiyamaLayout" title="Hierarchical top-to-bottom layout">
                        📊 Hierarchical
                    </button>
                    <button @onclick="ApplyTreeLayout" title="Tree layout (select a node for root)">
                        🌳 Tree @(selectedNodes.Count == 1 ? "(from selected)" : "")
                    </button>
                    <button @onclick="ApplyCircleLayout" title="Arrange nodes in a circle">
                        ⭕ Circle
                    </button>
                    <button @onclick="ApplyGridLayout" title="Arrange nodes in a grid">
                        ▦ Grid
                    </button>
                    <button @onclick="ApplyRadialLayout" title="Radial layout from center">
                        🎯 Radial @(selectedNodes.Count == 1 ? "(from selected)" : "")
                    </button>
                    <button @onclick="ApplyCompactLayout" title="Reduce graph area - select one node to compact around it, or compact around center">
                        📦 Compact @(selectedNodes.Count == 1 ? "(around selected)" : "(center)")
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🔄 Transform</div>
                    <button @onclick="FlipHorizontal" title="Flip layout horizontally (mirror left-right)">
                        ↔️ Flip Horizontal
                    </button>
                    <button @onclick="FlipVertical" title="Flip layout vertically (mirror top-bottom)">
                        ↕️ Flip Vertical
                    </button>
                    <button @onclick="ApplySymmetricHorizontal" title="Arrange nodes symmetrically left-right">
                        ⚖️ Symmetric H
                    </button>
                    <button @onclick="ApplySymmetricVertical" title="Arrange nodes symmetrically top-bottom">
                        ⚖️ Symmetric V
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🔗 Re-route @(selectedEdges.Count > 0 ? $"({selectedEdges.Count} selected)" : "(all edges)")</div>
                    <button @onclick="RerouteToDirect" title="Convert to straight lines">
                        ➡️ Direct (Straight)
                    </button>
                    <button @onclick="RerouteToSmartL" title="Convert to L-shape based on terminal directions">
                        ⌐ Smart L-Shape
                    </button>
                    <button @onclick="RerouteToOrtho" title="Convert to orthogonal with obstacle avoidance">
                        📐 Orthogonal
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🔧 Edge Tools</div>
                    <button @onclick="MinimizeEdgeCrossings" title="Reduce edge crossings">
                        ✂️ Minimize Crossings (@GetEdgeCrossingCount())
                    </button>
                    <button @onclick="RouteEdgesOrthogonal" title="Route edges at right angles (legacy)">
                        📐 Orthogonal Routing
                    </button>
                    <button @onclick="BundleParallelEdges" title="Bundle parallel edges together">
                        📦 Bundle Edges
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🎨 Edge Style (All)</div>
                    <button @onclick="SetAllEdgesDirect" title="Set all edges to straight lines">
                        ➡️ All Direct
                    </button>
                    <button @onclick="SetAllEdgesOrtho" title="Set all edges to right angles">
                        📐 All Orthogonal
                    </button>
                    <button @onclick="SetAllEdgesBezier" title="Set all edges to smooth curves">
                        〰️ All Bezier
                    </button>
                    <button @onclick="ClearAllWaypoints" title="Remove all edge waypoints">
                        🧹 Clear Waypoints
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🧠 Optimization</div>
                    <button @onclick="OptimizeLayoutSimulatedAnnealing" 
                            disabled="@isOptimizing"
                            title="Simulated annealing optimization">
                        @(isOptimizing ? $"⏳ {optimizationProgress}%" : "🎯 Optimize Layout")
                    </button>
                    <button @onclick="QuickRemoveOverlaps">📦 Remove Overlaps</button>
                    <button @onclick="SnapAllToGrid">📐 Snap to Grid</button>
                    <button @onclick="@(() => showOptimizationSettings = !showOptimizationSettings)">
                        ⚙️ Settings @(showOptimizationSettings ? "▲" : "▼")
                    </button>
                    @if (showOptimizationSettings)
                    {
                        <div class="optimization-settings">
                            <div class="setting-row">
                                <label>Iterations: @annealingIterations</label>
                                <input type="range" min="1000" max="20000" step="1000" @bind="annealingIterations" />
                            </div>
                            <div class="setting-row">
                                <label>Cooling: @annealingCooling.ToString("F3")</label>
                                <input type="range" min="0.9" max="0.999" step="0.001" @bind="annealingCooling" />
                            </div>
                            <div class="preset-buttons">
                                <button @onclick="ApplyQuickPreset">⚡Quick</button>
                                <button @onclick="ApplyBalancedPreset">⚖️Balanced</button>
                                <button @onclick="ApplyThoroughPreset">🔬Thorough</button>
                            </div>
                        </div>
                    }
                </div>
            </div>
            }

            @* View/Theme Dropdown - always visible *@
            <div class="toolbar-dropdown" data-testid="view-dropdown">
                <button class="dropdown-trigger" data-testid="view-trigger">
                    🎨 View ▾
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section-header">🎨 Theme (@dfdTheme.Themes.Count)</div>
                    @foreach (var theme in dfdTheme.GetAvailableThemes())
                    {
                        <button class="@(dfdTheme.CurrentThemeId == theme.Id ? "active" : "")"
                                @onclick="@(() => ApplyTheme(theme.Id))"
                                title="@theme.Description">
                            @theme.Name @(dfdTheme.CurrentThemeId == theme.Id ? "✓" : "") @(theme.IsCustom ? "*" : "")
                        </button>
                    }
                    <div class="dropdown-divider"></div>
                    <button @onclick="@(() => showThemeConfigurator = true)" title="Create or edit themes">
                        ⚙️ Configure Themes...
                    </button>
                </div>
            </div>

            @* Project Chart Dropdown - only visible when project template is selected *@
            @if (selectedTemplateId == "project")
            {
                <div class="toolbar-dropdown">
                    <button class="dropdown-trigger @(isProjectMode ? "active" : "")" @onclick="ToggleProjectMode"
                            title="@(isProjectMode ? "Click to toggle between Timeline and Node view" : "Click to enter Project mode")">
                        📅 Project @(isProjectMode ? (projectViewMode == "timeline" ? "📊" : "🔲") : "")
                    </button>
                    @if (isProjectMode)
                    {
                        <div class="dropdown-menu">
                            <div class="dropdown-section-header">🔗 Dependencies</div>
                            <button @onclick="@(() => isCreatingProjectDependency = !isCreatingProjectDependency)"
                                    class="@(isCreatingProjectDependency ? "active" : "")"
                                    title="Click two tasks to create a dependency">
                                🔗 @(isCreatingProjectDependency ? "Cancel Link" : "Link Tasks")
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">📁 Groups</div>
                            <button @onclick="CreateProjectGroupFromSelection"
                                    disabled="@(!CanCreateProjectGroup())"
                                    title="Group selected tasks into a mini-project (select 2+ tasks)">
                                📦 Group Tasks
                            </button>
                            @{
                                var selectedGroup = GetSelectedProjectGroup();
                            }
                            @if (selectedGroup != null)
                            {
                                <button @onclick="@(() => ToggleProjectGroup(selectedGroup.Id))"
                                        title="@(selectedGroup.IsCollapsed ? "Expand to show child tasks" : "Collapse to hide child tasks")">
                                    @(selectedGroup.IsCollapsed ? "📂 Expand Group" : "📁 Collapse Group")
                                </button>
                                <button @onclick="@(() => UngroupProjectGroup(selectedGroup.Id))"
                                        title="Dissolve the group back into individual tasks">
                                    📤 Ungroup
                                </button>
                            }
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">📐 Schedule</div>
                            <button @onclick="AutoScheduleProject" title="Auto-schedule based on dependencies">
                                ⚡ Auto Schedule
                            </button>
                            <button @onclick="ToggleProjectCriticalPath" title="Highlight the critical path">
                                🔴 Show Critical Path
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">🔍 View</div>
                            <button class="@(projectViewMode == "timeline" ? "active" : "")"
                                    @onclick="@(() => projectViewMode = "timeline")"
                                    title="Show tasks as bars on timeline">
                                📊 Timeline View @(projectViewMode == "timeline" ? "✓" : "")
                            </button>
                            <button class="@(projectViewMode == "node" ? "active" : "")"
                                    @onclick="@(() => { projectViewMode = "node"; LayoutprojectNodesForNodeView(); })"
                                    title="Show tasks as compact nodes for easy connections">
                                🔲 Node View @(projectViewMode == "node" ? "✓" : "")
                            </button>
                            <div class="dropdown-divider"></div>
                            <button @onclick="ProjectZoomIn" title="Zoom in">
                                🔍+ Zoom In
                            </button>
                            <button @onclick="ProjectZoomOut" title="Zoom out">
                                🔍- Zoom Out
                            </button>
                            <button @onclick="ProjectZoomToFit" title="Fit all tasks in view">
                                📐 Fit to View
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">⏱️ Deadline</div>
                            <button @onclick="SetProjectDeadlineToMakespan" title="Set deadline marker at project end date">
                                📍 Set at End Date
                            </button>
                            <button @onclick="ClearProjectDeadline" title="Remove deadline marker" disabled="@(!projectDeadlineDate.HasValue)">
                                ❌ Clear Deadline
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">⚡ Compression Mode</div>
                            <button @onclick="ToggleProjectCompressionMode"
                                    title="Toggle double-click behavior: move task to earliest or latest position">
                                @(projectCompressionMode == ProjectCompressionMode.Earliest ? "◀ Earliest" : "▶ Latest") @(projectCompressionMode == ProjectCompressionMode.Earliest ? "" : "(→ Deadline)")
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">🎨 Theme</div>
                            @foreach (var theme in dfdTheme.GetAvailableThemes())
                            {
                                <button class="@(dfdTheme.CurrentThemeId == theme.Id ? "active" : "")"
                                        @onclick="@(() => ApplyTheme(theme.Id))"
                                        title="@theme.Description">
                                    @theme.Name @(dfdTheme.CurrentThemeId == theme.Id ? "✓" : "") @(theme.IsCustom ? "*" : "")
                                </button>
                            }
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">📂 Examples</div>
                            <button @onclick="@(() => LoadProjectExample("simple"))" title="Basic 3-task project">
                                Simple Project
                            </button>
                            <button @onclick="@(() => LoadProjectExample("software"))" title="2-week development sprint">
                                Software Sprint
                            </button>
                            <button @onclick="@(() => LoadProjectExample("construction"))" title="House building phases">
                                Construction
                            </button>
                            <button @onclick="@(() => LoadProjectExample("marketing"))" title="Product launch campaign">
                                Marketing Campaign
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">💾 Import/Export</div>
                            <button @onclick="@(() => showProjectImportDialog = true)" title="Import from CSV, JSON, or MS Project XML">
                                📥 Import...
                            </button>
                            <button @onclick="ExportProjectToCsv" title="Export to CSV">
                                📤 Export CSV
                            </button>
                            <button @onclick="ExportProjectToJson" title="Export to JSON">
                                📤 Export JSON
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">🔧 Optimization</div>
                            <button @onclick="OpenSolverDialog" title="Optimize schedule with constraints">
                                🔧 Solver...
                            </button>
                            <div class="dropdown-divider"></div>
                            <button @onclick="@(() => showProjectHelpDialog = true)" title="How to use the Project chart">
                                📖 Project Help
                            </button>
                        </div>
                    }
                </div>
            }

            @* Gantt (Machine Scheduling) Mode Button *@
            @if (selectedTemplateId == "gantt")
            {
                <div class="toolbar-dropdown">
                    <button class="dropdown-trigger @(isGanttMode ? "active" : "")" @onclick="ToggleGanttMode"
                            title="@(isGanttMode ? "Click to toggle between Timeline and Node view" : "Click to enter Gantt mode")">
                        ⚙️ Gantt @(isGanttMode ? (ganttViewMode == "timeline" ? "📊" : "🔲") : "")
                    </button>
                    @if (isGanttMode)
                    {
                        <div class="dropdown-menu">
                            <div class="dropdown-section-header">🔗 Precedences</div>
                            <button @onclick="StartGanttPrecedenceCreation"
                                    class="@(isCreatingGanttPrecedence ? "active" : "")"
                                    title="Click two tasks to create a precedence constraint">
                                🔗 @(isCreatingGanttPrecedence ? "Cancel Link" : "Link Tasks")
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">📅 Scheduling</div>
                            <button @onclick="ShowSolverDialog" title="Open job-shop solver with multiple algorithms">
                                🧮 Solver...
                            </button>
                            <button @onclick="ValidateJobShopSchedule" title="Validate current schedule">
                                ✓ Validate
                            </button>
                            <button @onclick="ApplyGanttSPT" title="Apply Shortest Processing Time rule (quick)">
                                📊 Quick SPT
                            </button>
                            <button @onclick="AutoFixGanttViolations" title="Auto-fix precedence violations">
                                🔧 Fix Violations
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">🔍 Zoom</div>
                            <button @onclick="GanttZoomIn" title="Zoom in">
                                🔍+ Zoom In
                            </button>
                            <button @onclick="GanttZoomOut" title="Zoom out">
                                🔍- Zoom Out
                            </button>
                            <button @onclick="GanttZoomToFit" title="Fit all tasks">
                                📐 Fit All
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">⏱️ Deadline</div>
                            <button @onclick="SetGanttDeadlineToMakespan" title="Set deadline marker at current makespan">
                                📍 Set at Makespan
                            </button>
                            <button @onclick="ClearGanttDeadline" title="Remove deadline marker" disabled="@(!ganttDeadlineTime.HasValue)">
                                ❌ Clear Deadline
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">⚡ Compression Mode</div>
                            <button @onclick="ToggleGanttCompressionMode"
                                    title="Toggle double-click behavior: move task to earliest or latest position">
                                @(ganttCompressionMode == GanttCompressionMode.Earliest ? "◀ Earliest" : "▶ Latest") @(ganttCompressionMode == GanttCompressionMode.Earliest ? "" : "(→ Deadline)")
                            </button>
                            <div class="dropdown-section-header">👁️ View</div>
                            <button @onclick="ToggleGanttViewMode"
                                    title="Switch between Timeline and Node view">
                                @(ganttViewMode == "timeline" ? "🔲 Node View" : "📊 Timeline View")
                            </button>
                            <button @onclick="ToggleGanttDashboard"
                                    class="@(showGanttDashboard ? "active" : "")"
                                    title="Show machine utilization dashboard">
                                📈 Dashboard @(showGanttDashboard ? "✓" : "")
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">🏷️ Jobs</div>
                            <button @onclick="ToggleGanttJobFilter" title="Filter jobs visibility">
                                👁️ Filter Jobs...
                            </button>
                            <button @onclick="ShowAllGanttJobs" title="Show all jobs">
                                ✅ Show All
                            </button>
                            <button @onclick="HideAllGanttJobs" title="Hide all jobs">
                                ❌ Hide All
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">📂 Examples</div>
                            <button @onclick="LoadGanttJSP8x5" title="Job-shop scheduling (8 jobs, 5 machines, 36 tasks)">
                                JSP 8x5
                            </button>
                            <button @onclick="LoadGanttTaillard15x15" title="Job-shop scheduling benchmark (15 jobs, 15 machines, 225 tasks)">
                                Taillard 15x15
                            </button>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-section-header">💾 Import/Export</div>
                            <button @onclick="@(() => showGanttImportDialog = true)" title="Import from JSON job-shop format">
                                📥 Import JSON...
                            </button>
                            <button @onclick="ExportGanttToJson" title="Export to JSON">
                                📤 Export JSON
                            </button>
                        </div>
                    }
                </div>
            }

            @* QMaker Template Dropdown *@
            @if (selectedTemplateId == "qmaker")
            {
                <div class="toolbar-dropdown">
                    <button class="dropdown-trigger" title="QMaker queueing network tools">
                        📶 QMaker
                    </button>
                    <div class="dropdown-menu">
                        <div class="dropdown-section-header">📂 Examples</div>
                        <button @onclick="LoadQMakerMM1Example" title="Single-server M/M/1 queue">
                            M/M/1 Queue
                        </button>
                        <button @onclick="LoadQMakerMMCExample" title="Multi-server M/M/c queue">
                            M/M/c Queue
                        </button>
                        <button @onclick="LoadQMakerNetworkExample" title="Queueing network with multiple nodes">
                            Network Example
                        </button>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-section-header">💾 Import/Export</div>
                        <button @onclick="ExportQMakerConfig" title="Export queueing network configuration">
                            📤 Export Config
                        </button>
                    </div>
                </div>
            }

            @* Gantt Job Filter Popup *@
            @if (showGanttJobFilter && isGanttMode)
            {
                @* Drag overlay - captures mouse events during filter drag *@
                @if (isDraggingFilter)
                {
                    <div class="filter-drag-overlay"
                         @onmousemove="HandleFilterDragMove"
                         @onmouseup="StopFilterDrag"
                         @onmouseleave="StopFilterDrag"></div>
                }
                <div class="gantt-job-filter-popup @(isDraggingFilter ? "dragging" : "")"
                     style="top: @(ganttFilterY)px; left: @(ganttFilterX)px;"
                     @onclick:stopPropagation="true">
                    <div class="gantt-job-filter-header"
                         @onmousedown="StartFilterDrag"
                         @onmousedown:stopPropagation="true"
                         style="cursor: move;">
                        <span>Filter Jobs</span>
                        <button @onclick="ToggleGanttJobFilter" class="close-btn" @onclick:stopPropagation="true">×</button>
                    </div>
                    <div class="gantt-job-filter-actions">
                        <button @onclick="ShowAllGanttJobs" title="Show all jobs">All</button>
                        <button @onclick="HideAllGanttJobs" title="Hide all jobs">None</button>
                        <button @onclick="InvertGanttJobVisibility" title="Invert selection">Invert</button>
                    </div>
                    <div class="gantt-job-filter-content">
                        @foreach (var job in GetGanttJobNodes())
                        {
                            <label class="gantt-job-filter-item" style="border-left: 4px solid @(job.FillColor ?? job.GanttJobColor ?? "#3b82f6")">
                                <input type="checkbox"
                                       checked="@IsGanttJobVisible(job.Id)"
                                       @onchange="() => ToggleGanttJobVisibility(job.Id)" />
                                <span>@job.Text</span>
                            </label>
                        }
                        @if (!GetGanttJobNodes().Any())
                        {
                            <div class="gantt-job-filter-empty">No jobs defined</div>
                        }
                    </div>
                </div>
            }

            @* Gantt Machine Utilization Dashboard *@
            @if (showGanttDashboard && isGanttMode)
            {
                @* Drag overlay - captures mouse events during drag *@
                @if (isDraggingDashboard)
                {
                    <div class="dashboard-drag-overlay"
                         @onmousemove="HandleDashboardDragMove"
                         @onmouseup="StopDashboardDrag"
                         @onmouseleave="StopDashboardDrag"></div>
                }
                <div class="gantt-dashboard @(isDraggingDashboard ? "dragging" : "")"
                     style="top: @(ganttDashboardY)px; right: auto; left: @(ganttDashboardX)px;"
                     @onclick:stopPropagation="true">
                    <div class="gantt-dashboard-header"
                         @onmousedown="StartDashboardDrag"
                         @onmousedown:stopPropagation="true"
                         style="cursor: move;">
                        <span>📈 Machine Utilization</span>
                        <button @onclick="ToggleGanttDashboard" class="close-btn" @onclick:stopPropagation="true">×</button>
                    </div>
                    <div class="gantt-dashboard-content">
                        @{
                            var dashboardStats = GetGanttDashboardStats();
                        }
                        <div class="gantt-dashboard-summary">
                            <div class="dashboard-stat">
                                <span class="stat-label">Makespan</span>
                                <span class="stat-value">@dashboardStats.Makespan.TotalMinutes.ToString("F0") min</span>
                            </div>
                            <div class="dashboard-stat">
                                <span class="stat-label">Total Tasks</span>
                                <span class="stat-value">@dashboardStats.TotalTasks</span>
                            </div>
                            <div class="dashboard-stat">
                                <span class="stat-label">Avg Utilization</span>
                                <span class="stat-value">@dashboardStats.AverageUtilization.ToString("F1")%</span>
                            </div>
                        </div>
                        <div class="gantt-dashboard-machines">
                            @foreach (var machine in dashboardStats.MachineStats)
                            {
                                <div class="dashboard-machine-row">
                                    <span class="machine-name" title="@machine.Name">@machine.Name</span>
                                    <div class="utilization-bar-container">
                                        <div class="utilization-bar" style="width: @machine.Utilization.ToString("F0")%; background: @GetUtilizationColor(machine.Utilization)"></div>
                                    </div>
                                    <span class="utilization-value">@machine.Utilization.ToString("F0")%</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            @* Undo Button *@
            <button @onclick="HandleUndo"
                    disabled="@(!UndoService.CanUndo)"
                    title="Undo last action (Ctrl+Z)">
                ↶ Undo
            </button>

            @* Contextual buttons for selected node *@
            @if (selectedNodes.Count == 1)
            {
                <button @onclick="StartEditingSelectedNode"
                        title="Edit the text of the selected node">
                    ✏️ Edit
                </button>
                <button @onclick="RearrangeSelectedNodeEdges"
                        title="Rearrange edges on this node to reduce crossings">
                    🔄 Fix Edges
                </button>
            }

            @if (selectedLabels.Count == 1)
            {
                <button @onclick="StartEditingSelectedLabel"
                        title="Edit the selected label">
                    ✏️ Edit Label
                </button>
            }
        </div>

        @* File Actions *@
        <div class="toolbar-dropdown toolbar-right">
            <button class="dropdown-trigger">
                📁 File ▾
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <button @onclick="SaveDiagram" title="Export diagram as JSON">
                    💾 Save JSON
                </button>
                <button @onclick="@(() => showLoadDialog = true)" title="Import from JSON, Mermaid, or GraphViz">
                    📥 Import
                </button>
                <button @onclick="ExportDiagram" title="Export as Mermaid or DOT">
                    📤 Export Code
                </button>
                <div class="dropdown-divider"></div>
                <button @onclick="@(() => showClearConfirm = true)" class="btn-danger" title="Clear all">
                    🗑️ Clear All
                </button>
            </div>
        </div>
    </div>

    @* Connection Mode Indicators *@
    @if (connectionMode == ConnectionModeType.TwoClick)
    {
        <div class="mode-indicator two-click-indicator">
            @if (!twoClickSourceNode.HasValue)
            {
                <span>🔗 <b>Two-Click:</b> Click the SOURCE node</span>
            }
            else
            {
                <span>🔗 <b>Source selected!</b> Click DESTINATION node to connect • <b>Esc</b> to cancel</span>
            }
        </div>
    }
    @if (connectionMode == ConnectionModeType.OneToN || connectionMode == ConnectionModeType.OneToNArea)
    {
        <div class="mode-indicator multi-connect-indicator">
            @if (multiConnectSourceNode == null)
            {
                <span>🔀 <b>@(connectionMode == ConnectionModeType.OneToN ? "1:N Connect" : "1:N Area"):</b> Click a connection point on the SOURCE node</span>
            }
            else
            {
                <span>🔀 <b>Source selected!</b> Now click @(connectionMode == ConnectionModeType.OneToN ? "nodes" : "and drag to select area") • <b>Esc</b> to finish</span>
            }
        </div>
    }
    @if (connectionMode == ConnectionModeType.Chain || chainMode)
    {
        <div class="mode-indicator chain-indicator">
            <span>🔗 <b>Chain Mode:</b> Click nodes in sequence to connect them • <b>Esc</b> to finish</span>
        </div>
    }

    @* Layout Processing Indicator *@
    @if (isLayoutProcessing)
    {
        <div class="layout-processing-overlay">
            <div class="layout-processing-modal">
                <div class="spinner"></div>
                <span>@layoutStatusMessage</span>
            </div>
        </div>
    }

    <div class="instructions">
        <strong>Instructions:</strong>
        @if (isPrintAreaSelection)
        {
            <span> 📄 Print Selection Mode: Click and drag to draw a box around the area you want to export to PDF</span>
        }
        else if (chainMode)
        {
            <span> 🔗 <strong style="color: #8b5cf6;">Chain Mode:</strong> Click nodes in sequence to connect them. @(lastChainedNodeId.HasValue ? $"Last node: #{lastChainedNodeId}" : "Click first node to start chain") | Click 🔗 Chain again to exit</span>
        }
        else if (arrayMode)
        {
            <span> 📊 Array Mode: Click to place @arrayCount shapes in @arrayOrientation array | Spacing: @arraySpacing px</span>
        }
        else if (pendingConnectionNodeId.HasValue)
        {
            <span> 🎯 Hover over target node to see <strong style="color: #f59e0b;">orange connection points</strong>, then click one to complete the edge | Or click an edge to reattach endpoint</span>
        }
        else if (mode == EditorMode.AddNode)
        {
            <span> 📍 Click canvas to add shape @(useOrthoPlacement ? "(Ortho mode: aligned placement + orthogonal edges)" : "")</span>
        }
        else if (selectedNodes.Count == 0 && selectedEdges.Count == 0)
        {
            <span> <strong>Shift+Click</strong> = multi-select nodes/edges | Click node → node = arrow | <strong>Alt+Click edge</strong> = waypoint | <strong>Ctrl+Shift+Click edge</strong> = label | <strong>Delete</strong> = remove selected</span>
        }
        else if (selectedEdges.Count > 0)
        {
            <span> ✏️ <strong style="color: #3b82f6;">@selectedEdges.Count edge(s) selected</strong> - <strong>Shift+Click</strong> more edges to add | Adjust Edge Style and click <strong>Apply</strong> | <strong style="color: #10b981;">Click green dots</strong> to reconnect | <strong>Delete</strong> to remove</span>
        }
        else
        {
            <span> 🎯 <strong>@selectedNodes.Count node(s) selected</strong> | Press <strong>Delete</strong> to remove | <strong style="color: #10b981;">Green dots</strong> = connection points (5 per side) | <strong>Shift+Click</strong> = multi-select more</span>
        }
    </div>

    <div class="main-content">
        <div class="side-panel left-panel @(isLeftPanelCollapsed ? "collapsed" : "")">
            <button class="panel-collapse-toggle" @onclick="@(() => isLeftPanelCollapsed = !isLeftPanelCollapsed)" title="@(isLeftPanelCollapsed ? "Expand panel" : "Collapse panel")">
                @(isLeftPanelCollapsed ? "▶" : "◀")
            </button>
            @if (!isLeftPanelCollapsed)
            {
            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseCanvas = !collapseCanvas)">
                    <span>🎨 Canvas</span>
                    <span class="collapse-icon">@(collapseCanvas ? "▶" : "▼")</span>
                </button>
                @if (!collapseCanvas)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Background</label>
                            <select @bind="canvasBackground" class="panel-select">
                                <option value="grid">Grid</option>
                                <option value="swimlanes-h">Swimlanes (H)</option>
                                <option value="swimlanes-v">Swimlanes (V)</option>
                                <option value="columns">Columns</option>
                                <option value="none">None</option>
                            </select>
                            @if (canvasBackground.StartsWith("swimlanes") || canvasBackground == "columns")
                            {
                                <button class="panel-btn" @onclick="@(() => showBackgroundConfig = true)">
                                    ⚙️ Configure
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseShape = !collapseShape)">
                    <span>⬡ Shape</span>
                    <span class="collapse-icon">@(collapseShape ? "▶" : "▼")</span>
                </button>
                @if (!collapseShape)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Template</label>
                            <div style="display: flex; gap: 4px;">
                                <select value="@selectedTemplateId" @onchange="OnTemplateChanged" class="panel-select" style="flex: 1;">
                                    <option value="">— Basic Shapes —</option>
                                    @foreach (var tpl in GetAvailableTemplates())
                                    {
                                        <option value="@tpl.Id">@tpl.DisplayName</option>
                                    }
                                </select>
                                <button class="btn-icon" @onclick="OpenTemplateStylesDialog" title="Configure template styles">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v4m0 14v4m-9-9h4m14 0h4m-3.93-7.07l-2.83 2.83m-8.48 8.48l-2.83 2.83m0-14.14l2.83 2.83m8.48 8.48l2.83 2.83"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        @if (string.IsNullOrEmpty(selectedTemplateId))
                        {
                            <div class="property-group">
                                <label>Shape</label>
                                <select @bind="selectedShape" class="panel-select">
                                    <option value="@NodeShape.Rectangle">Rectangle</option>
                                    <option value="@NodeShape.Ellipse">Ellipse</option>
                                    <option value="@NodeShape.Diamond">Diamond</option>
                                    <option value="@NodeShape.Parallelogram">Parallelogram</option>
                                    <option value="@NodeShape.Cylinder">Cylinder</option>
                                </select>
                            </div>
                        }
                        else
                        {
                            <div class="property-group">
                                <label>Shape</label>
                                <select value="@selectedTemplateShapeId" @onchange="OnTemplateShapeChanged" class="panel-select">
                                    @foreach (var shape in GetShapesForTemplate(selectedTemplateId))
                                    {
                                        <option value="@shape.Id">@shape.DisplayName</option>
                                    }
                                </select>
                            </div>
                            @* Template edge configuration *@
                            <div class="template-config">
                                <div class="property-group">
                                    <label>Arrow Style</label>
                                    <select value="@GetCurrentEdgeDefaults().ArrowDirection"
                                            @onchange="@((e) => UpdateTemplateArrowDirection(e))"
                                            class="panel-select">
                                        <option value="@ArrowDirection.None">No Arrows</option>
                                        <option value="@ArrowDirection.End">Forward →</option>
                                        <option value="@ArrowDirection.Start">Backward ←</option>
                                        <option value="@ArrowDirection.Both">Both ↔</option>
                                    </select>
                                </div>
                                <div class="property-group">
                                    <label>Path Style</label>
                                    <select value="@GetCurrentEdgeDefaults().EdgeStyle"
                                            @onchange="@((e) => UpdateTemplateEdgeStyle(e))"
                                            class="panel-select">
                                        <option value="@EdgeStyle.Direct">Direct</option>
                                        <option value="@EdgeStyle.Ortho">Orthogonal</option>
                                        <option value="@EdgeStyle.OrthoRound">Ortho Round</option>
                                        <option value="@EdgeStyle.Bezier">Bezier</option>
                                    </select>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseEdgeStyle = !collapseEdgeStyle)">
                    <span>✏️ @(selectedNodes.Count > 0 ? "Stroke Style" : "Edge Style")</span>
                    <span class="collapse-icon">@(collapseEdgeStyle ? "▶" : "▼")</span>
                </button>
                @if (!collapseEdgeStyle)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Width & Style</label>
                            <div class="property-row">
                                <select @bind="defaultStrokeWidth" class="panel-select-small">
                                    <option value="1">1px</option>
                                    <option value="2">2px</option>
                                    <option value="3">3px</option>
                                    <option value="4">4px</option>
                                    <option value="5">5px</option>
                                </select>
                                <select @bind="defaultStrokeDashArray" class="panel-select-small">
                                    @foreach (var style in lineStyles)
                                    {
                                        <option value="@style.Key">@style.Value</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="property-group">
                            <label>Color</label>
                            <div class="panel-color-picker">
                                @foreach (var color in presetColors)
                                {
                                    <button class="color-swatch-small @(defaultStrokeColor == color ? "selected" : "")"
                                            style="background-color: @color;"
                                            @onclick="@(() => { defaultStrokeColor = color; ApplyStrokeToSelection(); })"
                                            title="@color">
                                    </button>
                                }
                            </div>
                        </div>
                        <div class="property-group">
                            <label class="panel-checkbox">
                                <input type="checkbox" @bind="defaultIsDoubleLine" />
                                Double Line
                            </label>
                        </div>
                        @if (selectedNodes.Count > 0)
                        {
                            <button class="panel-btn-primary" @onclick="ApplyStrokeToSelectedNodes">
                                ✓ Apply to @selectedNodes.Count node(s)
                            </button>
                        }
                        else if (selectedEdges.Count > 0)
                        {
                            <button class="panel-btn-primary" @onclick="ApplyEdgeStylesToSelected">
                                ✓ Apply to @selectedEdges.Count edge(s)
                            </button>
                        }
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseProperties = !collapseProperties)">
                    <span>📋 Properties</span>
                    <span class="collapse-icon">@(collapseProperties ? "▶" : "▼")</span>
                </button>
                @if (!collapseProperties)
                {
                    <div class="section-content">
                        @if (selectedNodes.Count == 1)
                        {
                            var node = nodes.FirstOrDefault(n => n.Id == selectedNodes[0]);
                            @if (node != null)
                            {
                                <div class="property-group">
                                    <label>Position</label>
                                    <div class="property-row">
                                        <span>X:</span>
                                        <input type="number" value="@((int)node.X)" @onchange="@(e => { node.X = double.Parse(e.Value?.ToString() ?? "0"); RecalculateEdgePaths(node.Id); })" />
                                    </div>
                                    <div class="property-row">
                                        <span>Y:</span>
                                        <input type="number" value="@((int)node.Y)" @onchange="@(e => { node.Y = double.Parse(e.Value?.ToString() ?? "0"); RecalculateEdgePaths(node.Id); })" />
                                    </div>
                                </div>
                                <div class="property-group">
                                    <label>Size</label>
                                    <div class="property-row">
                                        <span>W:</span>
                                        <input type="number" value="@((int)node.Width)" @onchange="@(e => { node.Width = double.Parse(e.Value?.ToString() ?? "120"); })" />
                                    </div>
                                    <div class="property-row">
                                        <span>H:</span>
                                        <input type="number" value="@((int)node.Height)" @onchange="@(e => { node.Height = double.Parse(e.Value?.ToString() ?? "60"); })" />
                                    </div>
                                </div>
                                <div class="property-group">
                                    <label>Node Color</label>
                                    <div class="panel-color-picker">
                                        @foreach (var color in presetColors)
                                        {
                                            <button class="color-swatch-small @(node.StrokeColor == color ? "selected" : "")"
                                                    style="background-color: @color;"
                                                    @onclick="@(() => node.StrokeColor = color)"
                                                    title="@color">
                                            </button>
                                        }
                                    </div>
                                </div>
                                @if (node.ShowTerminals)
                                {
                                    <div class="property-group">
                                        <label>Input Terminal</label>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="connectivity-btn @(node.InputTerminalType == TerminalType.Bidirectional ? "active" : "")"
                                                    @onclick="@(() => node.InputTerminalType = TerminalType.Bidirectional)"
                                                    title="Bidirectional">G</button>
                                            <button class="connectivity-btn @(node.InputTerminalType == TerminalType.Input ? "active" : "")"
                                                    @onclick="@(() => node.InputTerminalType = TerminalType.Input)"
                                                    title="Input">I</button>
                                            <button class="connectivity-btn @(node.InputTerminalType == TerminalType.Output ? "active" : "")"
                                                    @onclick="@(() => node.InputTerminalType = TerminalType.Output)"
                                                    title="Output">O</button>
                                        </div>
                                    </div>
                                    <div class="property-group">
                                        <label>Output Terminal</label>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="connectivity-btn @(node.OutputTerminalType == TerminalType.Bidirectional ? "active" : "")"
                                                    @onclick="@(() => node.OutputTerminalType = TerminalType.Bidirectional)"
                                                    title="Bidirectional">G</button>
                                            <button class="connectivity-btn @(node.OutputTerminalType == TerminalType.Input ? "active" : "")"
                                                    @onclick="@(() => node.OutputTerminalType = TerminalType.Input)"
                                                    title="Input">I</button>
                                            <button class="connectivity-btn @(node.OutputTerminalType == TerminalType.Output ? "active" : "")"
                                                    @onclick="@(() => node.OutputTerminalType = TerminalType.Output)"
                                                    title="Output">O</button>
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else if (selectedNodes.Count > 1)
                        {
                            <p class="panel-info">@selectedNodes.Count nodes selected</p>
                            <div class="property-group">
                                <label>Node Color</label>
                                <div class="panel-color-picker">
                                    @foreach (var color in presetColors)
                                    {
                                        <button class="color-swatch-small"
                                                style="background-color: @color;"
                                                @onclick="@(() => { foreach (var id in selectedNodes) { var n = nodes.FirstOrDefault(x => x.Id == id); if (n != null) n.StrokeColor = color; } })"
                                                title="@color">
                                        </button>
                                    }
                                </div>
                            </div>
                            <p class="panel-hint">Use alignment tools in toolbar</p>
                        }
                        else
                        {
                            <p class="panel-hint">Select a node to edit</p>
                        }
                    </div>
                }
            </div>
            }
        </div>

        @if (!isProjectMode && !isGanttMode)
        {
        <div class="canvas @(canvasBackground == "grid" ? "grid-background" : "")"
         @ref="canvasRef"
         @onmousedown="HandleCanvasMouseDown"
         @onmousemove="HandleCanvasMouseMove"
         @onmouseup="HandleCanvasMouseUp"
         @onclick="HandleCanvasClick"
         @onscroll="HandleCanvasScroll">
        <svg class="svg-layer" style="transform: scale(@zoomLevel); transform-origin: 0 0;">
           <defs>
                @* End arrowhead markers for each edge color *@
                @foreach (var color in edges.Where(e => !string.IsNullOrEmpty(e.StrokeColor)).Select(e => e.StrokeColor!).Distinct())
                {
                    <marker id="arrowhead-@color.Replace("#", "")" 
                            markerWidth="8" markerHeight="6"
                            refX="7" refY="3" 
                            orient="auto" 
                            markerUnits="strokeWidth">
                        <polygon points="0 0, 8 3, 0 6" fill="@color" />
                    </marker>
                }
                @* Default end arrowhead *@
                <marker id="arrowhead" 
                        markerWidth="8" markerHeight="6"
                        refX="7" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="0 0, 8 3, 0 6" fill="#374151" />
                </marker>
                @* Default gray end arrowhead for 374151 color *@
                <marker id="arrowhead-374151" 
                        markerWidth="8" markerHeight="6"
                        refX="7" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="0 0, 8 3, 0 6" fill="#374151" />
                </marker>
                
                @* Start arrowhead markers (pointing backward) for each edge color *@
                @foreach (var color in edges.Where(e => !string.IsNullOrEmpty(e.StrokeColor)).Select(e => e.StrokeColor!).Distinct())
                {
                    <marker id="arrowhead-start-@color.Replace("#", "")" 
                            markerWidth="8" markerHeight="6"
                            refX="1" refY="3" 
                            orient="auto" 
                            markerUnits="strokeWidth">
                        <polygon points="8 0, 0 3, 8 6" fill="@color" />
                    </marker>
                }
                @* Default start arrowhead *@
                <marker id="arrowhead-start" 
                        markerWidth="8" markerHeight="6"
                        refX="1" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="8 0, 0 3, 8 6" fill="#374151" />
                </marker>
                @* Default gray start arrowhead for 374151 color *@
                <marker id="arrowhead-start-374151" 
                        markerWidth="8" markerHeight="6"
                        refX="1" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="8 0, 0 3, 8 6" fill="#374151" />
                </marker>
            </defs>            @* Dynamic Canvas Background *@
            @if (canvasBackground == "swimlanes-h")
            {
                @* Horizontal Swimlanes *@
                var laneHeight = 2000.0 / swimlaneCount;
                var labelColumnWidth = 80.0; // Width for label column
                
                @* Label column background *@
                <rect x="0" y="0" width="@labelColumnWidth" height="2000"
                      fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"
                      style="pointer-events: none;" />
                
                for (int i = 0; i < swimlaneCount; i++)
                {
                    var y = i * laneHeight;
                    var fillColor = i % 2 == 0 ? "#f9fafb" : "#ffffff";
                    var labelText = swimlaneLabels.Count > i ? swimlaneLabels[i] : $"Lane {i + 1}";

                    @* Swimlane background (starts after label column) *@
                    <rect x="@labelColumnWidth" y="@y" width="@(2000 - labelColumnWidth)" height="@laneHeight"
                          fill="@fillColor" stroke="#e5e7eb" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Horizontal separator in label column *@
                    <line x1="0" y1="@y" x2="@labelColumnWidth" y2="@y"
                          stroke="#9ca3af" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Vertical text label in the column *@
                    @RenderSvgText(labelText, labelColumnWidth / 2, y + laneHeight / 2, 
                        "middle", "middle", "14", "bold", "#374151", 
                        $"rotate(-90 {labelColumnWidth / 2} {y + laneHeight / 2})")
                }
            }
            else if (canvasBackground == "swimlanes-v")
            {
                @* Vertical Swimlanes *@
                var laneWidth = 2000.0 / swimlaneCount;
                var labelRowHeight = 40.0; // Height for label row
                
                @* Label row background *@
                <rect x="0" y="0" width="2000" height="@labelRowHeight"
                      fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"
                      style="pointer-events: none;" />
                
                for (int i = 0; i < swimlaneCount; i++)
                {
                    var x = i * laneWidth;
                    var fillColor = i % 2 == 0 ? "#f9fafb" : "#ffffff";
                    var labelText = swimlaneLabels.Count > i ? swimlaneLabels[i] : $"Lane {i + 1}";

                    @* Swimlane background (starts below label row) *@
                    <rect x="@x" y="@labelRowHeight" width="@laneWidth" height="@(2000 - labelRowHeight)"
                          fill="@fillColor" stroke="#e5e7eb" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Vertical separator in label row *@
                    <line x1="@x" y1="0" x2="@x" y2="@labelRowHeight"
                          stroke="#9ca3af" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Text label in the row *@
                    @RenderSvgText(labelText, x + laneWidth / 2, labelRowHeight / 2, 
                        "middle", "middle", "14", "bold", "#374151")
                }
            }
            else if (canvasBackground == "columns")
            {
                @* Vertical Columns with labels *@
                var columnWidth = 2000.0 / columnCount;
                var labelRowHeight = 40.0; // Height for label row
                
                @* Label row background *@
                <rect x="0" y="0" width="2000" height="@labelRowHeight"
                      fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"
                      style="pointer-events: none;" />

                for (int i = 0; i < columnCount; i++)
                {
                    var x = i * columnWidth;
                    var labelText = columnLabels.Count > i ? columnLabels[i] : $"Column {i + 1}";

                    @* Column guide line (starts below label row) *@
                    <line x1="@x" y1="@labelRowHeight" x2="@x" y2="2000"
                          stroke="#e5e7eb" stroke-width="2" stroke-dasharray="10,5"
                          style="pointer-events: none;" />
                    
                    @* Vertical separator in label row *@
                    <line x1="@x" y1="0" x2="@x" y2="@labelRowHeight"
                          stroke="#9ca3af" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Text label in the row *@
                    @RenderSvgText(labelText, x + columnWidth / 2, labelRowHeight / 2, 
                        "middle", "middle", "14", "bold", "#374151")
                }
            }

            @* Row guides - horizontal lines (when enabled) *@
            @if (showRowGuide)
            {
                @for (int i = 1; i <= 3; i++)
                {
                    var y = i * 500;
                    <line x1="0" y1="@y" x2="2000" y2="@y"
                          stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5"
                          style="pointer-events: none;" />
                    @RenderRowGuideLabel(y, i)
                }
            }

            @* Column guides - vertical lines (when enabled) *@
            @if (showColumnGuide)
            {
                @for (int i = 1; i <= 3; i++)
                {
                    var x = i * 500;
                    <line x1="@x" y1="0" x2="@x" y2="2000"
                          stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5"
                          style="pointer-events: none;" />
                    @RenderColumnGuideLabel(x, i)
                }
            }

            @* Canvas boundary *@
            <rect x="0" y="0" width="4000" height="4000"
                  fill="none" stroke="#cbd5e1" stroke-width="2"
                  style="pointer-events: none;" />

            @* Render all edges *@
            @foreach (var edge in edges)
            {
                try
                {
                    // Skip edges hidden by SuperNode collapse
                    if (!ShouldRenderEdge(edge))
                    {
                        continue;
                    }

                    // Skip edges that don't have PathData calculated yet
                    if (string.IsNullOrEmpty(edge.PathData))
                    {
                        Console.WriteLine($"Edge {edge.Id} has no PathData, skipping render");
                        continue;
                    }

                    var isSelected = selectedEdges.Contains(edge.Id);
                    var strokeColor = isSelected ? "#3b82f6" : (edge.StrokeColor ?? "#374151");
                    var strokeWidth = isSelected ? 3 : (edge.StrokeWidth ?? 1);
                    var dashArray = edge.StrokeDashArray ?? "";
                    var currentEdge = edge; // Capture for use in label

                    <g @onclick="@((e) => HandleEdgeClick(edge.Id, e))"
                       @onclick:stopPropagation="true"
                       @ondblclick="@((e) => AddWaypointToEdge(edge.Id, e))"
                       @ondblclick:stopPropagation="true"
                       style="cursor: pointer;">

                        @if (edge.IsDoubleLine)
                        {
                            @* Double line effect *@
                            var offset = strokeWidth + 2;
                            var colorCode = edge.StrokeColor?.Replace("#", "") ?? "374151";

                            @* First line *@
                            <path d="@edge.PathData"
                                  stroke="@strokeColor"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  fill="none"
                                  marker-end="@(edge.ArrowDirection == ArrowDirection.End || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-{colorCode})" : "")"
                                  marker-start="@(edge.ArrowDirection == ArrowDirection.Start || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-start-{colorCode})" : "")"
                                  class="@(isSelected ? "selected-edge" : "")" />

                            @* Second parallel line *@
                            <path d="@GetParallelPath(edge.PathData, offset)"
                                  stroke="@strokeColor"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  fill="none"
                                  class="@(isSelected ? "selected-edge" : "")" />
                        }
                        else
                        {
                            @* Single line *@
                            var colorCode = edge.StrokeColor?.Replace("#", "") ?? "374151";
                            <path d="@edge.PathData"
                                  stroke="@strokeColor"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  fill="none"
                                  marker-end="@(edge.ArrowDirection == ArrowDirection.End || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-{colorCode})" : "")"
                                  marker-start="@(edge.ArrowDirection == ArrowDirection.Start || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-start-{colorCode})" : "")"
                                  class="@(isSelected ? "selected-edge" : "")" />
                        }

                        @* Invisible wider path for easier clicking *@
                        <path d="@edge.PathData"
                              stroke="transparent"
                              stroke-width="20"
                              fill="none"
                              style="pointer-events: stroke;" />

                        @* Waypoint handles and midpoint control - drag to move, right-click to delete *@
                        @if (isSelected)
                        {
                            @* Show existing waypoints *@
                            @foreach (var waypoint in edge.Waypoints)
                            {
                                var wp = waypoint; // Capture for lambda
                                <circle cx="@waypoint.X" cy="@waypoint.Y" r="7"
                                        fill="#3b82f6" stroke="white" stroke-width="2"
                                        @onmousedown="@((e) => StartDraggingWaypoint(edge.Id, wp, e))"
                                        @onmousedown:stopPropagation="true"
                                        @oncontextmenu="@((e) => DeleteWaypoint(edge.Id, wp))"
                                        @oncontextmenu:preventDefault="true"
                                        @oncontextmenu:stopPropagation="true"
                                        style="cursor: move;" />
                            }
                            
                            @* Show midpoint handle if no waypoints exist - for easy edge reshaping *@
                            @if (edge.Waypoints.Count == 0)
                            {
                                var mid = GetEdgeMidpoint(edge);
                                <circle cx="@mid.X" cy="@mid.Y" r="6"
                                        fill="white" stroke="#3b82f6" stroke-width="2"
                                        @ondblclick="@((e) => AddWaypointAtMidpoint(edge.Id))"
                                        @ondblclick:stopPropagation="true"
                                        style="cursor: pointer;"
                                        title="Double-click to add waypoint" />
                            }
                        }

                        @* Edge label *@
                        @if (!string.IsNullOrWhiteSpace(currentEdge.Label))
                        {
                            var midpoint = GetEdgeMidpoint(currentEdge);
                            @RenderEdgeLabel(currentEdge, midpoint)
                        }
                    </g>
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error rendering edge {edge.Id}: {ex.Message}");
                }
            }

            @* Render pending connection line *@
            @if (pendingConnectionNodeId.HasValue && pendingConnectionPoint.HasValue)
            {
                <line x1="@pendingConnectionPoint.Value.X"
                      y1="@pendingConnectionPoint.Value.Y"
                      x2="@currentMousePosition.X"
                      y2="@currentMousePosition.Y"
                      stroke="#3b82f6"
                      stroke-width="2"
                      stroke-dasharray="5,5"
                      style="pointer-events: none;" />
            }

            @* Render multi-connect pending line *@
            @if (multiConnectMode && multiConnectSourceNode.HasValue && multiConnectSourceCoords.HasValue)
            {
                @* Line from source to cursor *@
                <line x1="@multiConnectSourceCoords.Value.X"
                      y1="@multiConnectSourceCoords.Value.Y"
                      x2="@currentMousePosition.X"
                      y2="@currentMousePosition.Y"
                      stroke="#8b5cf6"
                      stroke-width="2"
                      stroke-dasharray="5,5"
                      style="pointer-events: none;" />
                
                @* Highlight the source point *@
                <circle cx="@multiConnectSourceCoords.Value.X"
                        cy="@multiConnectSourceCoords.Value.Y"
                        r="10"
                        fill="#8b5cf6"
                        opacity="0.6"
                        style="pointer-events: none;" />
                <circle cx="@multiConnectSourceCoords.Value.X"
                        cy="@multiConnectSourceCoords.Value.Y"
                        r="6"
                        fill="#8b5cf6"
                        stroke="white"
                        stroke-width="2"
                        style="pointer-events: none;" />
            }

            @* Render all nodes *@
            @foreach (var node in nodes)
            {
                // Skip nodes hidden by SuperNode collapse
                if (!ShouldRenderNode(node))
                {
                    continue;
                }

                var currentNode = node; // Capture for lambda
                var nodeId = node.Id;
                var isMultiConnectSource = multiConnectMode && multiConnectSourceNode == nodeId;
                var centerX = currentNode.Width / 2;
                var centerY = currentNode.Height / 2;
                var rotationTransform = currentNode.Rotation != 0
                    ? $"rotate({currentNode.Rotation}, {centerX.ToString(System.Globalization.CultureInfo.InvariantCulture)}, {centerY.ToString(System.Globalization.CultureInfo.InvariantCulture)})"
                    : "";

                <g class="node-group"
                   data-node-id="@nodeId"
                   transform="translate(@currentNode.X, @currentNode.Y) @rotationTransform"
                   @onmousedown="@((e) => HandleNodeMouseDown(nodeId, e))"
                   @onmousedown:stopPropagation="true"
                   @onmousemove="HandleCanvasMouseMove"
                   @onmouseup="HandleCanvasMouseUp"
                   @onclick="@((e) => { if (mode == EditorMode.Select) HandleNodeClick(nodeId, e); })"
                   @onclick:stopPropagation="true"
                   @ondblclick="@((e) => HandleNodeDoubleClick(nodeId))"
                   @ondblclick:stopPropagation="true"
                   @oncontextmenu="@((e) => ShowNodeContextMenu(nodeId, e))"
                   @oncontextmenu:preventDefault="true"
                   @oncontextmenu:stopPropagation="true"
                   @onmouseenter="@(() => { if (pendingConnectionNodeId.HasValue && pendingConnectionNodeId.Value != nodeId) { hoveredNodeId = nodeId; StateHasChanged(); } })"
                   @onmouseleave="@(() => { if (hoveredNodeId == nodeId) { hoveredNodeId = null; StateHasChanged(); } })">

                    @* Halo effect for multi-connect source node *@
                    @if (isMultiConnectSource)
                    {
                        <rect x="-8" y="-8"
                              width="@(currentNode.Width + 16)"
                              height="@(currentNode.Height + 16)"
                              fill="none"
                              stroke="#8b5cf6"
                              stroke-width="3"
                              stroke-dasharray="8,4"
                              rx="8"
                              opacity="0.8"
                              style="pointer-events: none;">
                            <animate attributeName="stroke-dashoffset" values="0;24" dur="1s" repeatCount="indefinite" />
                        </rect>
                        <rect x="-4" y="-4"
                              width="@(currentNode.Width + 8)"
                              height="@(currentNode.Height + 8)"
                              fill="#8b5cf6"
                              opacity="0.1"
                              rx="6"
                              style="pointer-events: none;" />
                    }

                    @* Draw the shape based on node type *@
                    @if (currentNode.IsSuperNode)
                    {
                        @* SuperNode with flashing indicator - same style for both regular and Project groups *@
                        <rect x="0" y="0"
                              width="@currentNode.Width"
                              height="@currentNode.Height"
                              fill="@(currentNode.FillColor ?? "#fef3c7")"
                              stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : "#dc2626")"
                              stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")"
                              rx="6"
                              style="cursor: move;" />
                        @* Flashing border indicator *@
                        <rect x="-3" y="-3"
                              width="@(currentNode.Width + 6)"
                              height="@(currentNode.Height + 6)"
                              fill="none"
                              stroke="#f59e0b"
                              stroke-width="2"
                              stroke-dasharray="8,4"
                              rx="8"
                              style="pointer-events: none;">
                            <animate attributeName="stroke" values="#f59e0b;#dc2626;#f59e0b" dur="1.5s" repeatCount="indefinite" />
                            <animate attributeName="stroke-dashoffset" values="0;24" dur="1s" repeatCount="indefinite" />
                        </rect>
                        @* Group icon indicator in top-right *@
                        <g transform="translate(@(currentNode.Width - 20), 5)" style="pointer-events: none;">
                            <rect width="14" height="10" fill="#dc2626" rx="2" />
                            <rect x="2" y="2" width="4" height="3" fill="white" rx="1" />
                            <rect x="8" y="2" width="4" height="3" fill="white" rx="1" />
                            <rect x="2" y="6" width="4" height="2" fill="white" rx="1" />
                            <rect x="8" y="6" width="4" height="2" fill="white" rx="1" />
                        </g>
                        @if (currentNode.TemplateId == "project")
                        {
                            @* Expand/Collapse button for Project groups *@
                            var expandIcon = currentNode.IsCollapsed ? "▶" : "▼";
                            <g transform="translate(16, 16)"
                               style="cursor: pointer;"
                               @onclick="@(() => ToggleProjectGroup(currentNode.Id))"
                               @onclick:stopPropagation="true">
                                <circle r="10" fill="@dfdTheme.CurrentTheme.GroupFill" stroke="@dfdTheme.CurrentTheme.DependencyStroke" stroke-width="1" />
                                @RenderSvgText(expandIcon, 0, 3, "middle", "middle", "10", "bold", dfdTheme.CurrentTheme.GroupText)
                            </g>
                            @* Group name and task count *@
                            var displayName = (currentNode.Text ?? "Group").Length > 12 ? (currentNode.Text ?? "Group").Substring(0, 9) + "..." : (currentNode.Text ?? "Group");
                            @RenderSvgText(displayName, currentNode.Width/2, currentNode.Height/2, "middle", "middle", "11", "600", "#92400e")
                            @RenderSvgText($"({currentNode.ContainedNodeIds.Count} tasks)", currentNode.Width/2, currentNode.Height - 8, "middle", "middle", "9", "normal", "#b45309")
                        }
                    }
                    else if (!string.IsNullOrEmpty(currentNode.TemplateId) && !string.IsNullOrEmpty(currentNode.TemplateShapeId))
                    {
                        var shapeDescriptor = shapeLibrary?.GetShape(currentNode.TemplateId, currentNode.TemplateShapeId);
                        if (shapeDescriptor != null)
                        {
                            <g style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");">
                                @* Invisible hit box for clicking - ensures the entire bounding box is clickable *@
                                <rect x="0" y="0"
                                      width="@currentNode.Width"
                                      height="@currentNode.Height"
                                      fill="transparent"
                                      stroke="none" />
                                @((MarkupString)shapeDescriptor.Render(currentNode))
                                @if (selectedNodes.Contains(nodeId))
                                {
                                    <rect x="-2" y="-2"
                                          width="@(currentNode.Width + 4)"
                                          height="@(currentNode.Height + 4)"
                                          fill="none"
                                          stroke="#3b82f6"
                                          stroke-width="2"
                                          rx="4"
                                          style="pointer-events: none;" />
                                }
                            </g>
                        }
                    }
                    else if (currentNode.Shape == NodeShape.Rectangle)
                    {
                        <rect x="0" y="0"
                              width="@currentNode.Width"
                              height="@currentNode.Height"
                              fill="@(currentNode.FillColor ?? "white")"
                              stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor)"
                              stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")"
                              rx="4"
                              style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Ellipse)
                    {
                        <ellipse cx="@(currentNode.Width / 2)"
                                 cy="@(currentNode.Height / 2)"
                                 rx="@(currentNode.Width / 2)"
                                 ry="@(currentNode.Height / 2)"
                                 fill="@(currentNode.FillColor ?? "white")"
                                 stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor)"
                                 stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")"
                                 style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Diamond)
                    {
                        var midX = currentNode.Width / 2;
                        var midY = currentNode.Height / 2;
                        <polygon points="@midX,0 @currentNode.Width,@midY @midX,@currentNode.Height 0,@midY"
                                 fill="@(currentNode.FillColor ?? "white")"
                                 stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor)"
                                 stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")"
                                 style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Parallelogram)
                    {
                        var skew = 15.0;
                        var points = $"{skew},0 {currentNode.Width},0 {currentNode.Width - skew},{currentNode.Height} 0,{currentNode.Height}";
                        <polygon points="@points"
                                 fill="@(currentNode.FillColor ?? "white")"
                                 stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor)"
                                 stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")"
                                 style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Cylinder)
                    {
                        var rx = currentNode.Width / 2;
                        var ellipseRy = 10.0;
                        var cy1 = ellipseRy;
                        var cy2 = currentNode.Height - ellipseRy;
                        
                        <g style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");">
                            @* Draw as a single path for better rendering *@
                            <path d="M 0,@cy1 
                                     Q 0,@(cy1 - ellipseRy) @rx,@(cy1 - ellipseRy)
                                     Q @currentNode.Width,@(cy1 - ellipseRy) @currentNode.Width,@cy1
                                     L @currentNode.Width,@cy2
                                     Q @currentNode.Width,@(cy2 + ellipseRy) @rx,@(cy2 + ellipseRy)
                                     Q 0,@(cy2 + ellipseRy) 0,@cy2
                                     Z"
                                  fill="@(currentNode.FillColor ?? "white")"
                                  stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor)"
                                  stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")" />
                            @* Top arc visible part *@
                            <path d="M 0,@cy1 Q 0,@(cy1 + ellipseRy / 2) @rx,@(cy1 + ellipseRy / 2) Q @currentNode.Width,@(cy1 + ellipseRy / 2) @currentNode.Width,@cy1"
                                  fill="none"
                                  stroke="@(selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor)"
                                  stroke-width="@(selectedNodes.Contains(nodeId) ? "3" : "2")" />
                        </g>
                    }

                    @* Render terminals for nodes that don't have built-in terminal rendering *@
                    @if (currentNode.ShowTerminals &&
                         currentNode.TemplateId != "sts" &&
                         currentNode.TemplateId != "circuit")
                    {
                        @((MarkupString)RenderGenericTerminals(currentNode))
                    }

                    @* Clickable terminal hit areas for terminal-to-terminal connections *@
                    @if (currentNode.ShowTerminals)
                    {
                        @RenderTerminalHitAreas(currentNode, nodeId)
                    }

                    @* Node text - render using RenderFragment to avoid Razor <text> conflict *@
                    @(RenderNodeTextWithIcon(currentNode))

                    @* Resize handle if selected *@
                    @* Show connection points if: node is selected, OR node is hovered while drawing a connection *@
                    @{
                        // Show connection points if: node is selected, OR we're connecting and hovering, OR an edge connected to this node is selected
                        var hasSelectedEdge = selectedEdges.Any(edgeId => 
                        {
                            var edge = edges.FirstOrDefault(e => e.Id == edgeId);
                            return edge != null && (edge.From == nodeId || edge.To == nodeId);
                        });
                        // Don't show connection points for nodes with terminals - they use terminals instead
                        var showConnectionPoints = !currentNode.ShowTerminals && (
                            selectedNodes.Contains(nodeId) ||
                            (pendingConnectionNodeId.HasValue && hoveredNodeId == nodeId) ||
                            hasSelectedEdge);
                    }

                    @if (showConnectionPoints)
                    {
                        @* Connection points (5 per side) - show for selected nodes, hover-during-connection, or when connected edge is selected *@
                        {
                            var sides = new[] { "top", "bottom", "left", "right" };
                            var positions = new[] { -2, -1, 0, 1, 2 };
                            const int spacing = 15; // ConnectionPointSpacing from GeometryService

                            foreach (var side in sides)
                            {
                                foreach (var pos in positions)
                                {
                                    double cpX = 0, cpY = 0;
                                    var offset = pos * spacing;

                                    switch (side)
                                    {
                                        case "top":
                                            cpX = currentNode.Width / 2 + offset;
                                            cpY = 0;
                                            break;
                                        case "bottom":
                                            cpX = currentNode.Width / 2 + offset;
                                            cpY = currentNode.Height;
                                            break;
                                        case "left":
                                            cpX = 0;
                                            cpY = currentNode.Height / 2 + offset;
                                            break;
                                        case "right":
                                            cpX = currentNode.Width;
                                            cpY = currentNode.Height / 2 + offset;
                                            break;
                                    }

                                    var isSourceNode = selectedNodes.Contains(nodeId);
                                    var isHoverTarget = (pendingConnectionNodeId.HasValue && hoveredNodeId == nodeId);
                                    var dotColor = isHoverTarget ? "#f59e0b" : "#10b981"; // Orange for hover target, green for selected
                                    var dotSize = isHoverTarget ? 6 : 5; // Larger for hover target

                                    <circle cx="@cpX"
                                            cy="@cpY"
                                            r="@dotSize"
                                            fill="@dotColor"
                                            stroke="white"
                                            stroke-width="2"
                                            style="cursor: crosshair; opacity: 1;"
                                            @onclick="@((e) => HandleConnectionPointClick(nodeId, side, pos, e))"
                                            @onclick:stopPropagation="true" />
                                }
                            }
                        }
                        
                        @* Selection indicator - rendered on top of node content for visibility *@
                        @if (selectedNodes.Contains(nodeId))
                        {
                            <rect x="-3" y="-3"
                                  width="@(currentNode.Width + 6)"
                                  height="@(currentNode.Height + 6)"
                                  fill="none"
                                  stroke="#3b82f6"
                                  stroke-width="2"
                                  stroke-dasharray="6,3"
                                  rx="4"
                                  style="pointer-events: none;" />
                        }

                        @* Resize handle - rendered LAST so it appears on top of connection points *@
                        @if (selectedNodes.Contains(nodeId))
                        {
                            <circle cx="@currentNode.Width"
                                    cy="@currentNode.Height"
                                    r="8"
                                    fill="#3b82f6"
                                    stroke="white"
                                    stroke-width="3"
                                    style="cursor: nwse-resize;"
                                    @onmousedown="@((e) => { resizingNodeId = nodeId; })"
                                    @onmousedown:stopPropagation="true" />
                        }
                    }
                </g>
            }
            
            @* Render EdgeLabel objects from edgeLabels list *@
            @foreach (var label in edgeLabels)
            {
                var labelId = label.Id;
                var isSelected = selectedLabels.Contains(labelId);
                
                <g class="edge-label-group"
                   transform="translate(@label.X, @label.Y)"
                   @onmousedown="@((e) => { if (!editingLabelId.HasValue) { draggingLabelId = labelId; dragOffsetX = e.OffsetX - label.X; dragOffsetY = e.OffsetY - label.Y; } })"
                   @onmousedown:stopPropagation="true"
                   @ondblclick="@((e) => { editingLabelId = labelId; StateHasChanged(); })"
                   @ondblclick:stopPropagation="true"
                   style="cursor: move;">
                    
                    <rect x="0" y="0"
                          width="@label.Width"
                          height="@label.Height"
                          fill="white"
                          stroke="@(isSelected ? "#3b82f6" : "#9ca3af")"
                          stroke-width="@(isSelected ? "2" : "1")"
                          rx="3" />
                    
                    @if (editingLabelId == labelId)
                    {
                        <foreignObject x="0" y="0" width="@label.Width" height="@label.Height">
                            <input @ref="textInputRef"
                                   type="text"
                                   @bind="label.Text"
                                   @bind:event="oninput"
                                   @onblur="@(() => { editingLabelId = null; StateHasChanged(); })"
                                   @onkeydown="@((e) => { if (e.Key == "Enter" || e.Key == "Escape") { editingLabelId = null; StateHasChanged(); } })"
                                   style="width: 100%; height: 100%; border: none; background: transparent; text-align: center; font-size: 12px; padding: 2px;" />
                        </foreignObject>
                    }
                    else
                    {
                        @RenderSvgText(label.Text, label.Width / 2, label.Height / 2, 
                            "middle", "middle", "12", "normal", "#374151")
                    }
                    
                    @* Resize handle if selected *@
                    @if (isSelected)
                    {
                        <circle cx="@label.Width"
                                cy="@label.Height"
                                r="5"
                                fill="#3b82f6"
                                stroke="white"
                                stroke-width="2"
                                style="cursor: nwse-resize;"
                                @onmousedown="@((e) => { resizingLabelId = labelId; })"
                                @onmousedown:stopPropagation="true" />
                    }
                </g>
            }

            @* Selection box - inside SVG so it scales with zoom *@
            @* Coordinates are already in diagram space (GetSelectionRectangle uses currentMousePosition which is diagram coords) *@
            @if (isSelecting && selectionStart.HasValue)
            {
                var rect = GetSelectionRectangle();
                var borderColor = isPrintAreaSelection ? "#10b981" : "#3b82f6";
                var bgColor = isPrintAreaSelection ? "rgba(16, 185, 129, 0.1)" : "rgba(59, 130, 246, 0.1)";
                <rect x="@rect.X" y="@rect.Y" width="@rect.Width" height="@rect.Height"
                      fill="@bgColor" stroke="@borderColor" stroke-width="@(2/zoomLevel)"
                      stroke-dasharray="@(5/zoomLevel)" pointer-events="none" />
            }

            @* 1:N Area selection box *@
            @if (isOneToNAreaSelecting && oneToNAreaStart.HasValue)
            {
                var rect = GetOneToNAreaRectangle();
                <rect x="@rect.X" y="@rect.Y" width="@rect.Width" height="@rect.Height"
                      fill="rgba(139, 92, 246, 0.1)" stroke="#8b5cf6" stroke-width="@(2/zoomLevel)"
                      stroke-dasharray="@(5/zoomLevel)" pointer-events="none" />
            }

            @* Rubberbanding line for terminal-to-terminal connections *@
            @if (isRubberbanding && rubberbandFromNodeId.HasValue)
            {
                var fromNode = nodes.FirstOrDefault(n => n.Id == rubberbandFromNodeId.Value);
                if (fromNode != null)
                {
                    var startPos = GetTerminalPosition(fromNode, rubberbandFromTerminal ?? "output");
                    if (startPos.HasValue)
                    {
                        <line x1="@startPos.Value.x" y1="@startPos.Value.y"
                              x2="@rubberbandEndX" y2="@rubberbandEndY"
                              stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5"
                              pointer-events="none" />
                        @* Circle at the end following mouse *@
                        <circle cx="@rubberbandEndX" cy="@rubberbandEndY" r="6"
                                fill="#3b82f6" stroke="white" stroke-width="2"
                                pointer-events="none" />
                    }
                }
            }
        </svg>

        @* Print area preview (when set) - convert stored screen coords to display *@
        @if (printArea.HasValue && !isSelecting)
        {
            <div style="position: absolute;
                            left: @(printArea.Value.X)px;
                            top: @(printArea.Value.Y)px;
                            width: @(printArea.Value.Width)px;
                            height: @(printArea.Value.Height)px;
                            border: 2px solid #10b981;
                            background-color: rgba(16, 185, 129, 0.05);
                            pointer-events: none;">
                <div style="position: absolute; top: -25px; left: 0; background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    Print Area
                </div>
            </div>
        }
    </div>
        } @* end if (!isProjectMode && !isGanttMode) *@
        else if (isProjectMode)
        {
        @* Project chart VIEW *@
        @if (projectViewMode == "node")
        {
            @* NODE VIEW - Compact nodes for easy connections *@
            <div class="canvas @(canvasBackground == "grid" ? "grid-background" : "")"
                 @ref="canvasRef"
                 tabindex="0"
                 @onkeydown="HandleKeyDown"
                 @onmousedown="HandleCanvasMouseDown"
                 @onmousemove="HandleCanvasMouseMove"
                 @onmouseup="HandleCanvasMouseUp"
                 @onscroll="HandleCanvasScroll">
                <svg width="3000" height="2000"
                     @onclick="HandleCanvasClick"
                     @onclick:stopPropagation="true">
                    <defs>
                        @* Standard arrowhead *@
                        <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#475569" />
                        </marker>
                    </defs>

                    @* Render Project dependency edges *@
                    @foreach (var edge in GetProjectDependencies())
                    {
                        var fromNode = nodes.FirstOrDefault(n => n.Id == edge.From);
                        var toNode = nodes.FirstOrDefault(n => n.Id == edge.To);
                        if (fromNode == null || toNode == null) continue;

                        var isCritical = projectCpmResults != null &&
                                        projectCpmResults.TryGetValue(fromNode.Id, out var fromCpm) &&
                                        projectCpmResults.TryGetValue(toNode.Id, out var toCpm) &&
                                        fromCpm.IsCritical && toCpm.IsCritical && showProjectCriticalPath;

                        @* Simple straight line from center to center *@
                        var x1 = fromNode.X + fromNode.Width / 2;
                        var y1 = fromNode.Y + fromNode.Height / 2;
                        var x2 = toNode.X + toNode.Width / 2;
                        var y2 = toNode.Y + toNode.Height / 2;

                        @* Adjust to edge of nodes *@
                        var angle = Math.Atan2(y2 - y1, x2 - x1);
                        x1 += Math.Cos(angle) * (fromNode.Width / 2);
                        y1 += Math.Sin(angle) * (fromNode.Height / 2);
                        x2 -= Math.Cos(angle) * (toNode.Width / 2);
                        y2 -= Math.Sin(angle) * (toNode.Height / 2);

                        <line x1="@x1" y1="@y1" x2="@x2" y2="@y2"
                              stroke="@(isCritical ? "#ef4444" : "#475569")"
                              stroke-width="@(isCritical ? 2.5 : 1.5)"
                              marker-end="url(#arrowhead)" />
                    }

                    @* Render Project tasks as compact nodes (filter out grouped children) *@
                    @foreach (var node in GetprojectNodesForNodeView())
                    {
                        var isSelected = selectedNodes.Contains(node.Id) || selectedProjectTaskId == node.Id;
                        var isCritical = projectCpmResults != null &&
                                        projectCpmResults.TryGetValue(node.Id, out var cpmResult) &&
                                        cpmResult.IsCritical && showProjectCriticalPath;
                        var nodeWidth = node.Width > 0 ? node.Width : 80;
                        var nodeHeight = node.Height > 0 ? node.Height : 40;

                        <g class="project-compact-node @(isSelected ? "selected" : "") @(isCritical ? "critical" : "")"
                           transform="translate(@node.X, @node.Y)"
                           @onclick="@(e => HandleProjectNodeClick(node.Id, e))"
                           @onclick:stopPropagation="true"
                           @ondblclick="@(() => EditProjectTask(node.Id))"
                           @onmousedown="@(e => HandleNodeMouseDown(node.Id, e))"
                           @onmousedown:stopPropagation="true"
                           style="cursor: move;">

                            @if (node.ProjectIsMilestone)
                            {
                                @* Milestone as diamond *@
                                var cx = nodeWidth / 2;
                                var cy = nodeHeight / 2;
                                var half = Math.Min(nodeWidth, nodeHeight) / 2 - 4;
                                <polygon points="@cx,@(cy-half) @(cx+half),@cy @cx,@(cy+half) @(cx-half),@cy"
                                         fill="@(isCritical ? "#fca5a5" : "#8b5cf6")"
                                         stroke="@(isSelected ? "#3b82f6" : "#6d28d9")"
                                         stroke-width="@(isSelected ? 2 : 1)" />
                                @RenderSvgText(node.Text, cx, cy + half + 12, "middle", "middle", "9", "normal", "#374151")
                            }
                            else if (node.IsSuperNode)
                            {
                                @* Project group - use SuperNode container style (same as regular groups) *@
                                var expandIcon = node.IsCollapsed ? "▶" : "▼";

                                @* Container background - amber/yellow like regular SuperNodes *@
                                <rect x="0" y="0"
                                      width="@nodeWidth"
                                      height="@nodeHeight"
                                      fill="#fef3c7"
                                      stroke="@(isSelected ? "#3b82f6" : "#dc2626")"
                                      stroke-width="@(isSelected ? 3 : 2)"
                                      rx="6"
                                      style="cursor: move;" />

                                @* Flashing border indicator *@
                                <rect x="-3" y="-3"
                                      width="@(nodeWidth + 6)"
                                      height="@(nodeHeight + 6)"
                                      fill="none"
                                      stroke="#f59e0b"
                                      stroke-width="2"
                                      stroke-dasharray="8,4"
                                      rx="8"
                                      style="pointer-events: none;">
                                    <animate attributeName="stroke" values="#f59e0b;#dc2626;#f59e0b" dur="1.5s" repeatCount="indefinite" />
                                    <animate attributeName="stroke-dashoffset" values="0;24" dur="1s" repeatCount="indefinite" />
                                </rect>

                                @* Group icon indicator in top-right *@
                                <g transform="translate(@(nodeWidth - 20), 5)" style="pointer-events: none;">
                                    <rect width="14" height="10" fill="#dc2626" rx="2" />
                                    <rect x="2" y="2" width="4" height="3" fill="white" rx="1" />
                                    <rect x="8" y="2" width="4" height="3" fill="white" rx="1" />
                                    <rect x="2" y="6" width="4" height="2" fill="white" rx="1" />
                                    <rect x="8" y="6" width="4" height="2" fill="white" rx="1" />
                                </g>

                                @* Expand/Collapse button in top-left *@
                                <g transform="translate(16, 16)"
                                   style="cursor: pointer;"
                                   @onclick="@(() => ToggleProjectGroup(node.Id))"
                                   @onclick:stopPropagation="true">
                                    <circle r="10" fill="@dfdTheme.CurrentTheme.GroupFill" stroke="@dfdTheme.CurrentTheme.DependencyStroke" stroke-width="1" />
                                    @RenderSvgText(expandIcon, 0, 3, "middle", "middle", "10", "bold", dfdTheme.CurrentTheme.GroupText)
                                </g>

                                @* Group name - centered *@
                                var displayName = node.Text.Length > 15 ? node.Text.Substring(0, 12) + "..." : node.Text;
                                @RenderSvgText(displayName, nodeWidth/2, nodeHeight/2, "middle", "middle", "11", "600", "#92400e")

                                @* Task count badge at bottom *@
                                @RenderSvgText($"({node.ContainedNodeIds.Count} tasks)", nodeWidth/2, nodeHeight - 8, "middle", "middle", "9", "normal", "#b45309")
                            }
                            else
                            {
                                @* Task as compact rectangle *@
                                <rect x="0" y="0" width="@nodeWidth" height="@nodeHeight"
                                      rx="4" ry="4"
                                      fill="@(isCritical ? dfdTheme.CurrentTheme.CriticalFill : (node.FillColor ?? dfdTheme.CurrentTheme.ProcessFill))"
                                      stroke="@(isSelected ? dfdTheme.CurrentTheme.SelectionStroke : (isCritical ? dfdTheme.CurrentTheme.CriticalStroke : (node.StrokeColor ?? dfdTheme.CurrentTheme.ProcessStroke)))"
                                      stroke-width="@(isSelected ? 2 : 1)" />

                                @* Task name (truncated) *@
                                var displayName = node.Text.Length > 12 ? node.Text.Substring(0, 10) + ".." : node.Text;
                                @RenderSvgText(displayName, nodeWidth/2, nodeHeight/2 - 2, "middle", "middle", "10", "500", dfdTheme.CurrentTheme.TaskNameText)

                                @* Dates in small font *@
                                @if (node.ProjectStartDate != null)
                                {
                                    var dateStr = $"{node.ProjectStartDate.Value:MMM d}";
                                    if (node.ProjectDurationDays > 1)
                                    {
                                        dateStr += $" ({node.ProjectDurationDays}d)";
                                    }
                                    @RenderSvgText(dateStr, nodeWidth/2, nodeHeight/2 + 10, "middle", "middle", "8", "normal", "#64748b")
                                }

                                @* Progress indicator bar at bottom *@
                                @if (node.ProjectPercentComplete > 0)
                                {
                                    var progressWidth = (nodeWidth - 8) * node.ProjectPercentComplete / 100;
                                    <rect x="4" y="@(nodeHeight - 6)" width="@progressWidth" height="3"
                                          rx="1" fill="@(isCritical ? "#ef4444" : "#3b82f6")" />
                                }
                            }
                        </g>
                    }

                    @* Selection rectangle *@
                    @if (isSelecting && selectionStart.HasValue)
                    {
                        var selX = Math.Min(selectionStart.Value.X, currentMousePosition.X);
                        var selY = Math.Min(selectionStart.Value.Y, currentMousePosition.Y);
                        var selW = Math.Abs(currentMousePosition.X - selectionStart.Value.X);
                        var selH = Math.Abs(currentMousePosition.Y - selectionStart.Value.Y);
                        <rect x="@selX" y="@selY" width="@selW" height="@selH"
                              fill="rgba(59, 130, 246, 0.1)"
                              stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2" />
                    }
                </svg>
            </div>
        }
        else
        {
        @* TIMELINE VIEW - Traditional Project bars *@
        <div class="project-canvas @(isCreatingProjectDependency ? "linking-mode" : "") @(mode == EditorMode.AddNode && selectedTemplateId == "project" ? "add-mode" : "")"
             tabindex="0"
             @ref="canvasRef"
             @onkeydown="HandleKeyDown"
             @onscroll="HandleCanvasScroll">
            <svg class="project-svg"
                 width="@GetProjectTotalWidth()"
                 height="@GetProjectTotalHeight()"
                 @onmousedown="HandleProjectMouseDown"
                 @onmousemove="HandleProjectMouseMove"
                 @onmouseup="HandleProjectMouseUp"
                 @onmouseleave="HandleProjectMouseUp">
                <defs>
                    @* Arrowhead for dependency lines *@
                    <marker id="project-arrowhead"
                            markerWidth="8" markerHeight="6"
                            refX="7" refY="3"
                            orient="auto"
                            markerUnits="strokeWidth">
                        <polygon points="0 0, 8 3, 0 6" fill="@dfdTheme.CurrentTheme.DependencyArrow" />
                    </marker>
                    <marker id="project-arrowhead-critical"
                            markerWidth="8" markerHeight="6"
                            refX="7" refY="3"
                            orient="auto"
                            markerUnits="strokeWidth">
                        <polygon points="0 0, 8 3, 0 6" fill="@dfdTheme.CurrentTheme.CriticalStroke" />
                    </marker>
                </defs>

                @if (projectTimeline != null)
                {
                    var projectNodes = GetOrderedprojectNodes();
                    var projectDeps = GetProjectDependencies().ToList();

                    @* Row backgrounds - render first so weekend bars appear on top *@
                    @for (int bgRowIdx = 0; bgRowIdx < projectNodes.Count; bgRowIdx++)
                    {
                        var bgNode = projectNodes[bgRowIdx];
                        var bgRowColor = dfdTheme.CurrentTheme.GetRowColor(bgRowIdx, bgNode.IsSuperNode);
                        var bgY = projectTimeline.RowToY(bgRowIdx);
                        <rect x="0" y="@bgY"
                              width="@GetProjectTotalWidth()" height="@projectTimeline.RowHeight"
                              fill="@bgRowColor"
                              style="pointer-events: none;" />
                    }

                    @* Row grid lines - render before weekend bars so they don't cross through weekends *@
                    @for (int gridRowIdx = 0; gridRowIdx <= projectNodes.Count; gridRowIdx++)
                    {
                        var gridY = projectTimeline.RowToY(gridRowIdx);
                        <line x1="0" y1="@gridY" x2="@GetProjectTotalWidth()" y2="@gridY"
                              stroke="@dfdTheme.CurrentTheme.GridLine" stroke-width="1" />
                    }

                    @* Background - Saturday shading (semi-transparent so row lines show through) *@
                    @foreach (var saturday in projectTimeline.GetSaturdayBands())
                    {
                        <rect x="@saturday.x" y="@projectTimeline.HeaderHeight"
                              width="@saturday.width" height="@(GetProjectTotalHeight() - projectTimeline.HeaderHeight)"
                              fill="@dfdTheme.CurrentTheme.SaturdayFill" opacity="0.5" />
                    }

                    @* Background - Sunday shading (semi-transparent so row lines show through) *@
                    @foreach (var sunday in projectTimeline.GetSundayBands())
                    {
                        <rect x="@sunday.x" y="@projectTimeline.HeaderHeight"
                              width="@sunday.width" height="@(GetProjectTotalHeight() - projectTimeline.HeaderHeight)"
                              fill="@dfdTheme.CurrentTheme.SundayFill" opacity="0.5" />
                    }

                    @* Today line *@
                    @if (projectTimeline.GetTodayX() is double todayXValue)
                    {
                        <line x1="@todayXValue" y1="@projectTimeline.HeaderHeight"
                              x2="@todayXValue" y2="@GetProjectTotalHeight()"
                              stroke="@dfdTheme.CurrentTheme.TodayLine" stroke-width="2" stroke-dasharray="4,2" />
                    }

                    @* Project deadline marker line *@
                    @if (projectDeadlineDate.HasValue)
                    {
                        var deadlineProjectX = projectTimeline.DateToX(projectDeadlineDate.Value);
                        var projTotalHeight = GetProjectTotalHeight();
                        <g class="project-deadline-marker" style="cursor: ew-resize;">
                            @* Invisible wider hit area for easier grabbing *@
                            <rect x="@(deadlineProjectX - 8)" y="0" width="16" height="@projTotalHeight"
                                  fill="transparent" pointer-events="all"
                                  @onmousedown="StartProjectDeadlineDrag"
                                  @onmousedown:stopPropagation="true" />
                            @* Visible deadline line *@
                            <line x1="@deadlineProjectX" y1="0" x2="@deadlineProjectX" y2="@projTotalHeight"
                                  stroke="#111827" stroke-width="2" stroke-dasharray="8,4" />
                            @* Header triangle marker *@
                            <polygon points="@(deadlineProjectX - 6),0 @(deadlineProjectX + 6),0 @deadlineProjectX,10"
                                     fill="#111827" />
                            @* Label in header *@
                            @RenderSvgText($"Deadline: {projectDeadlineDate.Value:MMM d}", deadlineProjectX + 10, 12, "start", "auto", "9", "600", "#111827")
                        </g>
                    }

                    @* Timeline header - month row *@
                    <rect x="0" y="0"
                          width="@GetProjectTotalWidth()" height="25"
                          fill="@dfdTheme.CurrentTheme.HeaderFill" stroke="@dfdTheme.CurrentTheme.HeaderStroke" />
                    @foreach (var month in projectTimeline.GetMonthLabels())
                    {
                        @RenderSvgText(month.label, month.x + month.width / 2, 16,
                            "middle", "middle", "12", "bold", dfdTheme.CurrentTheme.HeaderText)
                    }

                    @* Timeline header - day row *@
                    <rect x="0" y="25"
                          width="@GetProjectTotalWidth()" height="25"
                          fill="@dfdTheme.CurrentTheme.HeaderFill" stroke="@dfdTheme.CurrentTheme.HeaderStroke" />
                    @foreach (var day in projectTimeline.GetDayLabels())
                    {
                        var isWeekend = projectTimeline.IsWeekend(day.date);
                        @RenderSvgText(day.label, day.x + projectTimeline.DayWidth / 2, 42,
                            "middle", "middle", "10", "normal", isWeekend ? dfdTheme.CurrentTheme.WeekendText : dfdTheme.CurrentTheme.DateText)
                    }

                    @* Column headers in the header area *@
                    <rect x="0" y="0"
                          width="@projectTimeline.LabelWidth" height="@projectTimeline.HeaderHeight"
                          fill="@dfdTheme.CurrentTheme.HeaderFill" stroke="@dfdTheme.CurrentTheme.HeaderStroke" />
                    @* Outline column header - "G" button for grouping when 2+ tasks selected *@
                    @if (CanCreateProjectGroup())
                    {
                        <g transform="translate(@(projectTimeline.OutlineColumnWidth / 2), @(projectTimeline.HeaderHeight / 2))"
                           style="cursor: pointer;"
                           @onclick="CreateProjectGroupFromSelection"
                           @onclick:stopPropagation="true">
                            <rect x="-10" y="-10" width="20" height="20" rx="3"
                                  fill="@dfdTheme.CurrentTheme.TaskFill" stroke="@dfdTheme.CurrentTheme.TaskStroke" stroke-width="1" />
                            @RenderSvgText("G", 0, 1, "middle", "middle", "12", "bold", dfdTheme.CurrentTheme.TaskText)
                        </g>
                    }
                    <line x1="@projectTimeline.OutlineColumnWidth" y1="0"
                          x2="@projectTimeline.OutlineColumnWidth" y2="@projectTimeline.HeaderHeight"
                          stroke="@dfdTheme.CurrentTheme.HeaderStroke" />
                    @* ID column header *@
                    @RenderSvgText("ID", projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth / 2, projectTimeline.HeaderHeight / 2,
                        "middle", "middle", "11", "600", dfdTheme.CurrentTheme.HeaderText)
                    <line x1="@(projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth)" y1="0"
                          x2="@(projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth)" y2="@projectTimeline.HeaderHeight"
                          stroke="@dfdTheme.CurrentTheme.HeaderStroke" />
                    @* Task Name column header *@
                    @RenderSvgText("Task Name", projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth + 6, projectTimeline.HeaderHeight / 2,
                        "start", "middle", "11", "600", dfdTheme.CurrentTheme.HeaderText)

                    @* Column border lines (no fill - row colors will show through) *@
                    <line x1="@projectTimeline.OutlineColumnWidth" y1="@projectTimeline.HeaderHeight"
                          x2="@projectTimeline.OutlineColumnWidth" y2="@(projectTimeline.HeaderHeight + projectNodes.Count * projectTimeline.RowHeight)"
                          stroke="@dfdTheme.CurrentTheme.GridLine" stroke-width="1" />
                    <line x1="@(projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth)" y1="@projectTimeline.HeaderHeight"
                          x2="@(projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth)" y2="@(projectTimeline.HeaderHeight + projectNodes.Count * projectTimeline.RowHeight)"
                          stroke="@dfdTheme.CurrentTheme.GridLine" stroke-width="1" />
                    <line x1="@projectTimeline.LabelWidth" y1="@projectTimeline.HeaderHeight"
                          x2="@projectTimeline.LabelWidth" y2="@(projectTimeline.HeaderHeight + projectNodes.Count * projectTimeline.RowHeight)"
                          stroke="@dfdTheme.CurrentTheme.GridLine" stroke-width="1" />

                    @* Task rows (nodes) *@
                    @foreach (var node in projectNodes)
                    {
                        var rowIndex = node.ProjectRowIndex >= 0 ? node.ProjectRowIndex : GetProjectTaskRowIndex(node.Id);
                        var y = projectTimeline.RowToY(rowIndex);
                        var isSelected = selectedNodes.Contains(node.Id) || selectedProjectTaskId == node.Id;
                        var isCritical = projectCpmResults != null &&
                                        projectCpmResults.TryGetValue(node.Id, out var cpmResult) &&
                                        cpmResult.IsCritical && showProjectCriticalPath;
                        var wbsId = GetProjectWbsId(node, projectNodes);
                        var isChild = node.ParentSuperNodeId.HasValue;
                        var indentPx = isChild ? 12.0 : 0.0;
                        var taskNameX = projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth + 6 + indentPx;

                        @* Row backgrounds are rendered earlier (before weekend bars) so weekend bars show on top *@

                        @* Row highlight when selected - full width for clear visibility *@
                        @if (isSelected)
                        {
                            <rect x="0" y="@y"
                                  width="@GetProjectTotalWidth()" height="@projectTimeline.RowHeight"
                                  fill="#3b82f6" opacity="0.15"
                                  style="pointer-events: none;" />
                        }

                        @* Clickable label row background (selects the task, double-click to edit) *@
                        @* Note: fill is transparent to let row colors show through, selection is handled by the highlight rect above *@
                        <rect x="@(projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth)" y="@y"
                              width="@(projectTimeline.LabelWidth - projectTimeline.OutlineColumnWidth - projectTimeline.IdColumnWidth)"
                              height="@projectTimeline.RowHeight"
                              fill="transparent"
                              style="cursor: pointer;"
                              @onclick="@(e => SelectProjectTask(node.Id, e))"
                              @ondblclick="@(() => EditProjectTask(node.Id))" />

                        @* WBS ID in ID column *@
                        @RenderSvgText(wbsId, projectTimeline.OutlineColumnWidth + projectTimeline.IdColumnWidth / 2, y + projectTimeline.RowHeight / 2 + 4,
                            "middle", "middle", "10", isChild ? "normal" : "600", isChild ? dfdTheme.CurrentTheme.DateText : dfdTheme.CurrentTheme.TaskNameText)

                        @if (node.IsSuperNode)
                        {
                            @* Summary/Group row - +/- expand/collapse in outline column + task name *@
                            var bounds = projectTimeline.GetNodeBarBounds(node);
                            var barHeight = 8;
                            var barY = y + projectTimeline.RowHeight / 2 - barHeight / 2;
                            var bracketSize = 10;
                            var expandSymbol = node.IsCollapsed ? "+" : "−"; // Plus/minus signs

                            @* +/- Expand/Collapse button in outline column *@
                            <g transform="translate(@(projectTimeline.OutlineColumnWidth / 2), @(y + projectTimeline.RowHeight / 2))"
                               style="cursor: pointer;"
                               @onclick="@(() => ToggleProjectGroup(node.Id))"
                               @onclick:stopPropagation="true">
                                <rect x="-9" y="-9" width="18" height="18" rx="3"
                                      fill="@dfdTheme.CurrentTheme.HeaderFill" stroke="@dfdTheme.CurrentTheme.GroupStroke" stroke-width="2" />
                                @RenderSvgText(expandSymbol, 0, 1, "middle", "middle", "16", "bold", dfdTheme.CurrentTheme.GroupText)
                            </g>

                            @* Task name in label column (bold for groups) *@
                            @RenderSvgText(node.Text, taskNameX, y + projectTimeline.RowHeight / 2 + 4,
                                "start", "middle", "12", "600", dfdTheme.CurrentTheme.TaskNameText)

                            @* Summary bar (thin horizontal) *@
                            <rect x="@(bounds.x + bracketSize)" y="@(barY + 2)"
                                  width="@Math.Max(bounds.width - bracketSize * 2, 0)" height="4"
                                  fill="@dfdTheme.CurrentTheme.GroupFill" />

                            @* Left bracket *@
                            <polygon points="@bounds.x,@(barY - 2) @(bounds.x + bracketSize),@(barY + barHeight/2) @bounds.x,@(barY + barHeight + 2)"
                                     fill="@dfdTheme.CurrentTheme.GroupFill"
                                     style="cursor: pointer;"
                                     @onclick="@(e => SelectProjectTask(node.Id, e))"
                                     @ondblclick="@(() => AutoScheduleTaskAndSuccessors(node.Id))" />

                            @* Right bracket *@
                            <polygon points="@(bounds.x + bounds.width),@(barY - 2) @(bounds.x + bounds.width - bracketSize),@(barY + barHeight/2) @(bounds.x + bounds.width),@(barY + barHeight + 2)"
                                     fill="@dfdTheme.CurrentTheme.GroupFill"
                                     style="cursor: pointer;"
                                     @onclick="@(e => SelectProjectTask(node.Id, e))"
                                     @ondblclick="@(() => AutoScheduleTaskAndSuccessors(node.Id))" />

                            @* Selection highlight *@
                            @if (isSelected)
                            {
                                <rect x="@(bounds.x - 2)" y="@(barY - 4)"
                                      width="@(bounds.width + 4)" height="@(barHeight + 8)"
                                      fill="none" stroke="@dfdTheme.CurrentTheme.SelectionStroke" stroke-width="2" stroke-dasharray="4,2" />
                            }

                            @* Child count badge *@
                            <g transform="translate(@(bounds.x + bounds.width + 8), @(barY + barHeight/2))">
                                <rect x="-4" y="-8" width="@(node.ContainedNodeIds.Count.ToString().Length * 8 + 24)" height="16"
                                      rx="8" fill="@dfdTheme.CurrentTheme.GroupFill" />
                                @RenderSvgText($"{node.ContainedNodeIds.Count} tasks", (node.ContainedNodeIds.Count.ToString().Length * 8 + 24) / 2 - 4, 4, "middle", "middle", "9", "500", dfdTheme.CurrentTheme.GroupText)
                            </g>
                        }
                        else if (node.ProjectIsMilestone)
                        {
                            @* Outline column - click to select *@
                            <rect x="0" y="@y"
                                  width="@projectTimeline.OutlineColumnWidth" height="@projectTimeline.RowHeight"
                                  fill="transparent"
                                  style="cursor: pointer;"
                                  @onclick="@(e => SelectProjectTask(node.Id, e))" />

                            @* Task name in label column (indented if child) *@
                            @RenderSvgText(node.Text, taskNameX, y + projectTimeline.RowHeight / 2 + 4,
                                "start", "middle", "12", "normal", dfdTheme.CurrentTheme.TaskNameText)

                            @* Milestone diamond - double-click to edit (milestones are fixed dates) *@
                            var mx = node.ProjectStartDate != null ? projectTimeline.DateTimeToX(node.ProjectStartDate.Value) + projectTimeline.DayWidth / 2 : 0;
                            var my = y + projectTimeline.RowHeight / 2;
                            <polygon points="@(mx),@(my-10) @(mx+10),@(my) @(mx),@(my+10) @(mx-10),@(my)"
                                     fill="@(isCritical ? dfdTheme.CurrentTheme.CriticalStroke : dfdTheme.CurrentTheme.MilestoneFill)"
                                     stroke="@(isSelected ? dfdTheme.CurrentTheme.SelectionStroke : dfdTheme.CurrentTheme.MilestoneStroke)"
                                     stroke-width="@(isSelected ? 3 : 1)"
                                     style="cursor: pointer;"
                                     @onclick="@(e => SelectProjectTask(node.Id, e))"
                                     @ondblclick="@(() => EditProjectTask(node.Id))" />
                        }
                        else
                        {
                            @* Outline column - click to select *@
                            <rect x="0" y="@y"
                                  width="@projectTimeline.OutlineColumnWidth" height="@projectTimeline.RowHeight"
                                  fill="transparent"
                                  style="cursor: pointer;"
                                  @onclick="@(e => SelectProjectTask(node.Id, e))" />

                            @* Task name in label column (indented if child) *@
                            @RenderSvgText(node.Text, taskNameX, y + projectTimeline.RowHeight / 2 + 4,
                                "start", "middle", "12", "normal", dfdTheme.CurrentTheme.TaskNameText)

                            @* Task bar *@
                            var bounds = projectTimeline.GetNodeBarBounds(node);
                            var barHeight = projectTimeline.RowHeight - 12;
                            var barY = y + 6;

                            @* Task bar background *@
                            var isDropTarget = IsResourceDropTarget(node.Id);
                            var dropTargetClass = isDropTarget ? "resource-drop-target" : "";
                            var taskFillColor = isDropTarget ? "#dcfce7" : (isCritical ? dfdTheme.CurrentTheme.CriticalFill : dfdTheme.CurrentTheme.TaskFill);
                            var taskStrokeColor = isDropTarget ? "#10b981" : (isSelected ? dfdTheme.CurrentTheme.SelectionStroke : (isCritical ? dfdTheme.CurrentTheme.CriticalStroke : dfdTheme.CurrentTheme.TaskStroke));
                            <rect x="@bounds.x" y="@barY"
                                  width="@bounds.width" height="@barHeight"
                                  rx="4" ry="4"
                                  class="@dropTargetClass"
                                  fill="@taskFillColor"
                                  stroke="@taskStrokeColor"
                                  stroke-width="@(isDropTarget ? 3 : (isSelected ? 3 : 1))"
                                  style="cursor: @(isSelected ? "move" : "pointer");"
                                  @onmousedown="@(e => StartProjectTaskDrag(node.Id, e))"
                                  @onclick="@(e => SelectProjectTask(node.Id, e))"
                                  @ondblclick="@(() => AutoScheduleTaskAndSuccessors(node.Id))" />

                            @* Progress bar *@
                            @if (node.ProjectPercentComplete > 0)
                            {
                                var progressWidth = bounds.width * node.ProjectPercentComplete / 100;
                                <rect x="@bounds.x" y="@barY"
                                      width="@progressWidth" height="@barHeight"
                                      rx="4" ry="4"
                                      fill="@(isCritical ? dfdTheme.CurrentTheme.CriticalStroke : dfdTheme.CurrentTheme.TaskStroke)"
                                      opacity="0.5"
                                      pointer-events="none" />
                            }

                            @* Task name on bar (if wide enough) *@
                            @if (bounds.width > 50)
                            {
                                var displayName = node.Text.Length > 20 ? node.Text.Substring(0, 17) + "..." : node.Text;
                                @RenderSvgText(displayName, bounds.x + 8, barY + barHeight / 2 + 4,
                                    "start", "middle", "11", "normal", dfdTheme.CurrentTheme.TaskText)
                            }

                            @* Show assigned resource icons *@
                            var assignedResources = GetResourcesAssignedToTask(node.Id).ToList();
                            var iconX = bounds.x + bounds.width - 4;
                            var iconSize = Math.Min(barHeight - 4, 18);
                            foreach (var resource in assignedResources.Take(3))
                            {
                                iconX -= iconSize + 2;
                                var resColor = ProjectTimelineService.GetResourceTypeColor(resource.ProjectResourceType);
                                var resIcon = ProjectTimelineService.GetResourceTypeSvgIcon(resource.ProjectResourceType);
                                var iconScale = iconSize / 24.0;
                                <g transform="translate(@iconX, @(barY + (barHeight - iconSize) / 2))">
                                    <circle cx="@(iconSize/2)" cy="@(iconSize/2)" r="@(iconSize/2)"
                                            fill="@resColor" stroke="white" stroke-width="1" />
                                    <g transform="translate(@(iconSize/2 - 12*iconScale), @(iconSize/2 - 12*iconScale)) scale(@iconScale.ToString("F2"))">
                                        <path d="@resIcon" fill="white" />
                                    </g>
                                </g>
                            }
                            if (assignedResources.Count > 3)
                            {
                                iconX -= iconSize + 2;
                                <circle cx="@(iconX + iconSize/2)" cy="@(barY + barHeight/2)"
                                        r="@(iconSize/2)" fill="#64748b" stroke="white" stroke-width="1" />
                                @RenderSvgText($"+{assignedResources.Count - 3}", iconX + iconSize/2, barY + barHeight/2 + 3,
                                    "middle", "middle", "9", "bold", "white")
                            }

                            @* Resize handles when selected *@
                            @if (isSelected)
                            {
                                <rect x="@(bounds.x - 4)" y="@barY"
                                      width="8" height="@barHeight"
                                      fill="@dfdTheme.CurrentTheme.SelectionStroke" rx="2"
                                      style="cursor: ew-resize;"
                                      @onmousedown="@(e => StartProjectResize(node.Id, true))"
                                      @onmousedown:stopPropagation="true" />
                                <rect x="@(bounds.x + bounds.width - 4)" y="@barY"
                                      width="8" height="@barHeight"
                                      fill="@dfdTheme.CurrentTheme.SelectionStroke" rx="2"
                                      style="cursor: ew-resize;"
                                      @onmousedown="@(e => StartProjectResize(node.Id, false))"
                                      @onmousedown:stopPropagation="true" />
                            }
                        }
                    }

                    @* Dependency arrows (edges with IsProjectDependency) *@
                    @foreach (var dep in projectDeps)
                    {
                        var fromNode = nodes.FirstOrDefault(n => n.Id == dep.From);
                        var toNode = nodes.FirstOrDefault(n => n.Id == dep.To);
                        if (fromNode == null || toNode == null) continue;

                        @* Skip dependencies where nodes don't have valid Project dates *@
                        if (fromNode.ProjectStartDate == null || toNode.ProjectStartDate == null) continue;

                        var isCriticalDep = projectCpmResults != null &&
                                           projectCpmResults.TryGetValue(fromNode.Id, out var fromCpm) &&
                                           projectCpmResults.TryGetValue(toNode.Id, out var toCpm) &&
                                           fromCpm.IsCritical && toCpm.IsCritical && showProjectCriticalPath;

                        @* Get connection points based on dependency type *@
                        var fromPoint = projectTimeline.GetNodeDependencyPoint(fromNode, false, dep.ProjectDepType);
                        var toPoint = projectTimeline.GetNodeDependencyPoint(toNode, true, dep.ProjectDepType);

                        @* Draw arrow path *@
                        var midY = (fromPoint.y + toPoint.y) / 2;
                        var path = $"M {fromPoint.x},{fromPoint.y} " +
                                  $"L {fromPoint.x + 10},{fromPoint.y} " +
                                  $"L {fromPoint.x + 10},{midY} " +
                                  $"L {toPoint.x - 10},{midY} " +
                                  $"L {toPoint.x - 10},{toPoint.y} " +
                                  $"L {toPoint.x},{toPoint.y}";

                        @* Invisible wider path for easier clicking *@
                        <path d="@path"
                              fill="none"
                              stroke="transparent"
                              stroke-width="12"
                              style="cursor: pointer;"
                              @onclick="@((e) => HandleEdgeClick(dep.Id, e))"
                              @onclick:stopPropagation="true"
                              @onmousedown:stopPropagation="true" />
                        @* Visible dependency line *@
                        <path d="@path"
                              fill="none"
                              stroke="@(selectedEdges.Contains(dep.Id) ? dfdTheme.CurrentTheme.SelectionStroke : (isCriticalDep ? dfdTheme.CurrentTheme.CriticalStroke : dfdTheme.CurrentTheme.DependencyStroke))"
                              stroke-width="@(selectedEdges.Contains(dep.Id) ? 3 : (isCriticalDep ? 2 : 1.5))"
                              marker-end="@(isCriticalDep ? "url(#project-arrowhead-critical)" : "url(#project-arrowhead)")"
                              pointer-events="none" />
                    }

                    @* Rubberband line for dependency creation *@
                    @if (isCreatingProjectDependency && ProjectDependencyFromTaskId.HasValue)
                    {
                        var fromNode = nodes.FirstOrDefault(n => n.Id == ProjectDependencyFromTaskId.Value);
                        if (fromNode != null)
                        {
                            var fromPoint = projectTimeline.GetNodeBarRightEdge(fromNode);
                            <line x1="@fromPoint.x" y1="@fromPoint.y"
                                  x2="@projectRubberbandX" y2="@projectRubberbandY"
                                  stroke="@dfdTheme.CurrentTheme.SelectionStroke" stroke-width="2" stroke-dasharray="5,5" />
                            <circle cx="@projectRubberbandX" cy="@projectRubberbandY" r="5"
                                    fill="@dfdTheme.CurrentTheme.SelectionStroke" />
                        }
                    }
                }
            </svg>
        </div>
        } @* end else (timeline view) *@
        } @* end else (Project mode) *@
        else if (isGanttMode)
        {
        @* Gantt Machine Scheduling Mode *@
        @if (!ganttTimelineView)
        {
            @* Node View - Gantt nodes rendered as flowchart-style shapes *@
            <div class="canvas"
                 @ref="canvasRef"
                 @onmousedown="HandleCanvasMouseDown"
                 @onmousemove="HandleCanvasMouseMove"
                 @onmouseup="HandleCanvasMouseUp"
                 @onscroll="HandleCanvasScroll"
                 tabindex="0"
                 @onkeydown="HandleKeyDown">
                <svg width="4000" height="4000"
                     style="transform: scale(@zoomLevel); transform-origin: 0 0;">
                    <defs>
                        <marker id="gantt-arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151" />
                        </marker>
                        <marker id="gantt-arrowhead-selected" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="@dfdTheme.CurrentTheme.SelectionStroke" />
                        </marker>
                    </defs>

                    @* Grid *@
                    <g class="grid">
                        @for (int i = 0; i <= 4000; i += 100)
                        {
                            <line x1="@i" y1="0" x2="@i" y2="4000" stroke="#e5e7eb" stroke-width="0.5" />
                            <line x1="0" y1="@i" x2="4000" y2="@i" stroke="#e5e7eb" stroke-width="0.5" />
                        }
                    </g>

                    @* Edges (precedence links) *@
                    @foreach (var edge in edges)
                    {
                        var ganttEdgeSelected = selectedEdges.Contains(edge.Id);
                        <path d="@edge.PathData"
                              stroke="@(ganttEdgeSelected ? dfdTheme.CurrentTheme.SelectionStroke : (edge.StrokeColor ?? "#374151"))"
                              stroke-width="@(ganttEdgeSelected ? 3 : 2)"
                              fill="none"
                              marker-end="@(ganttEdgeSelected ? "url(#gantt-arrowhead-selected)" : "url(#gantt-arrowhead)")"
                              @onclick="@(e => HandleEdgeClick(edge.Id, e))"
                              @onclick:stopPropagation="true"
                              style="cursor: pointer;" />
                    }

                    @* Nodes (Jobs, Machines, Tasks) - filtered by job visibility *@
                    @foreach (var node in nodes.Where(n => n.TemplateId == "gantt" && (n.IsGanttMachine || n.IsGanttJob || IsGanttTaskVisible(n))))
                    {
                        var ganttNodeSelected = selectedNodes.Contains(node.Id);
                        var ganttJobColor = node.IsGanttTask && node.GanttJobId.HasValue
                            ? ganttColorService.GetJobFillColor(node.GanttJobId.Value)
                            : node.FillColor;
                        var ganttStrokeColor = node.GanttIsViolation ? "#ef4444" : (ganttNodeSelected ? dfdTheme.CurrentTheme.SelectionStroke : node.StrokeColor);
                        var ganttStrokeWidth = node.GanttIsViolation ? 3 : (ganttNodeSelected ? 2.5 : 1.5);

                        <g class="node @(ganttNodeSelected ? "selected" : "") @(node.GanttIsViolation ? "violation" : "")"
                           transform="translate(@node.X, @node.Y)"
                           @onmousedown="@(e => HandleNodeMouseDown(node.Id, e))"
                           @onmousedown:stopPropagation="true"
                           @onclick="@(e => HandleNodeClick(node.Id, e))"
                           @onclick:stopPropagation="true"
                           style="cursor: pointer;">

                            @if (node.IsGanttJob)
                            {
                                @* Job node - rectangle with job color *@
                                <rect width="@node.Width" height="@node.Height" rx="8" ry="8"
                                      fill="@node.FillColor" stroke="@ganttStrokeColor" stroke-width="@ganttStrokeWidth" />
                                @RenderSvgText(node.Text ?? "Job", node.Width / 2, node.Height / 2, "middle", "middle", "12", "bold", GanttColorService.GetContrastingTextColor(node.FillColor ?? "#3b82f6"))
                            }
                            else if (node.IsGanttMachine)
                            {
                                @* Machine node - rectangle with gear icon *@
                                <rect width="@node.Width" height="@node.Height" rx="4" ry="4"
                                      fill="@node.FillColor" stroke="@ganttStrokeColor" stroke-width="@ganttStrokeWidth" />
                                @RenderSvgText("⚙️", 20, node.Height / 2, "middle", "middle", "14", "normal", "#374151")
                                @RenderSvgText(node.Text ?? "Machine", 60, node.Height / 2, "start", "middle", "12", "normal", "#374151")
                            }
                            else if (node.IsGanttTask)
                            {
                                @* Task node - bar with job color *@
                                <rect width="@node.Width" height="@node.Height" rx="4" ry="4"
                                      fill="@ganttJobColor" stroke="@ganttStrokeColor" stroke-width="@ganttStrokeWidth" />
                                @RenderSvgText(node.Text ?? "Task", node.Width / 2, node.Height / 2, "middle", "middle", "11", "normal", GanttColorService.GetContrastingTextColor(ganttJobColor ?? "#3b82f6"))
                                @if (node.GanttIsViolation)
                                {
                                    @RenderSvgText("⚠️", node.Width - 12, 10, "middle", "middle", "12", "normal", "#ef4444")
                                }
                            }
                            else
                            {
                                @* Default node *@
                                <rect width="@node.Width" height="@node.Height" rx="4" ry="4"
                                      fill="@node.FillColor" stroke="@ganttStrokeColor" stroke-width="@ganttStrokeWidth" />
                                @RenderSvgText(node.Text ?? "Node", node.Width / 2, node.Height / 2, "middle", "middle", "12", "normal", "#374151")
                            }
                        </g>
                    }

                    @* Rubberband for precedence creation *@
                    @if (ganttPrecedenceFromTaskId.HasValue)
                    {
                        var ganttFromNode = nodes.FirstOrDefault(n => n.Id == ganttPrecedenceFromTaskId.Value);
                        if (ganttFromNode != null)
                        {
                            <line x1="@(ganttFromNode.X + ganttFromNode.Width)" y1="@(ganttFromNode.Y + ganttFromNode.Height / 2)"
                                  x2="@ganttRubberbandX" y2="@ganttRubberbandY"
                                  stroke="@dfdTheme.CurrentTheme.SelectionStroke" stroke-width="2" stroke-dasharray="5,5" />
                            <circle cx="@ganttRubberbandX" cy="@ganttRubberbandY" r="5"
                                    fill="@dfdTheme.CurrentTheme.SelectionStroke" />
                        }
                    }
                </svg>
            </div>
        }
        else
        {
            @* Timeline View - Gantt chart with hours/minutes *@
            <div class="canvas"
                 @ref="canvasRef"
                 @onmousedown="HandleGanttMouseDown"
                 @ondblclick="HandleGanttDoubleClick"
                 @onmousemove="HandleGanttMouseMove"
                 @onmouseup="HandleGanttMouseUp"
                 @onmouseleave="HandleGanttMouseUp"
                 @onscroll="HandleCanvasScroll"
                 @onwheel="HandleGanttWheel"
                 @onwheel:preventDefault="true"
                 tabindex="0"
                 @onkeydown="HandleKeyDown">
                @{
                    var ganttTheme = dfdTheme.GetGanttColors();
                }
                <svg width="@((int)ganttTimeline.GetTimelineWidth())" height="@((int)ganttTimeline.GetTimelineHeight(GetGanttMachineNodes().Count()))"
                     style="transform: scale(@zoomLevel); transform-origin: 0 0;">
                    <defs>
                        <marker id="gantt-timeline-arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="@ganttTheme.DependencyArrow" />
                        </marker>
                        <marker id="gantt-timeline-arrow-violation" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="@ganttTheme.ViolationStroke" />
                        </marker>
                        @* Pattern definitions for task differentiation *@
                        @{
                            var usedColors = nodes.Where(n => n.IsGanttTask && !string.IsNullOrEmpty(n.FillColor))
                                .Select(n => n.FillColor!)
                                .Distinct()
                                .ToList();
                        }
                        @foreach (var color in usedColors)
                        {
                            @((MarkupString)GanttColorService.GeneratePatternDefs(color, color.TrimStart('#')))
                        }
                    </defs>

                    @* Background *@
                    <rect x="0" y="0" width="@ganttTimeline.GetTimelineWidth()" height="@(ganttTimeline.GetTimelineHeight(GetGanttMachineNodes().Count()))"
                          fill="@ganttTheme.CanvasBackground" />

                    @* Hour grid lines and labels *@
                    @{
                        var ganttHourLabels = ganttTimeline.GetHourLabels().ToList();
                        var ganttHeaderHeight = ganttTimeline.HeaderHeight;
                        var ganttMachineNodes = GetGanttMachineNodes().ToList();
                        // Apply layer overrides to task nodes for rendering
                        var visibleLayers = layerService.GetVisibleLayers().ToList();
                        var allTasks = GetGanttTaskNodes().ToList();
                        List<Node> ganttTaskNodes;

                        if (isBaseLayerVisible)
                        {
                            // Base visible: show all tasks with layer overrides applied
                            ganttTaskNodes = visibleLayers.Count > 0
                                ? allTasks.Select(t => layerService.GetEffectiveNode(t, visibleLayers)).ToList()
                                : allTasks;
                        }
                        else if (visibleLayers.Count > 0)
                        {
                            // Base hidden but layers visible: show only tasks that have overrides in visible layers
                            var overriddenTaskIds = visibleLayers.SelectMany(l => l.NodeOverrides.Keys).ToHashSet();
                            ganttTaskNodes = allTasks
                                .Where(t => overriddenTaskIds.Contains(t.Id))
                                .Select(t => layerService.GetEffectiveNode(t, visibleLayers))
                                .ToList();
                        }
                        else
                        {
                            // Base hidden and no layers visible: show nothing
                            ganttTaskNodes = new List<Node>();
                        }

                        // Filter by job visibility
                        ganttTaskNodes = ganttTaskNodes.Where(t => IsGanttTaskVisible(t)).ToList();
                    }

                    @* Timeline header background *@
                    <rect x="0" y="0" width="@ganttTimeline.GetTimelineWidth()" height="@ganttHeaderHeight"
                          fill="@ganttTheme.HeaderFill" stroke="@ganttTheme.HeaderStroke" />

                    @* Hour labels and vertical grid lines *@
                    @foreach (var (time, hx, label) in ganttHourLabels)
                    {
                        <line x1="@hx" y1="@ganttTimeline.TotalHeaderHeight" x2="@hx" y2="@(ganttTimeline.GetTimelineHeight(ganttMachineNodes.Count))"
                              stroke="@ganttTheme.GridLineMajor" stroke-width="1" />
                        @RenderSvgText(label, hx + 5, 20, "start", "auto", "11", "500", ganttTheme.HeaderText)

                        @* 30-minute marks *@
                        var halfHourX = ganttTimeline.TimeToX(time.Add(TimeSpan.FromMinutes(30)));
                        <line x1="@halfHourX" y1="@ganttTimeline.TotalHeaderHeight" x2="@halfHourX" y2="@(ganttTimeline.GetTimelineHeight(ganttMachineNodes.Count))"
                              stroke="@ganttTheme.GridLineMinor" stroke-width="0.5" stroke-dasharray="2,2" />
                    }

                    @* Add Machine button - at TOP of machine column in header *@
                    <g class="add-machine-btn"
                       @onclick="AddGanttMachine"
                       @onclick:stopPropagation="true"
                       style="cursor: pointer;">
                        <rect x="0" y="0" width="120" height="@ganttHeaderHeight"
                              fill="@ganttTheme.HeaderFill" stroke="@ganttTheme.HeaderStroke" />
                        @* Plus button (simple rect+text, no transform) *@
                        <rect x="90" y="@(ganttHeaderHeight / 2 - 10)" width="20" height="20" rx="4"
                              fill="@ganttTheme.AddButtonFill" class="add-machine-icon-bg" />
                        @RenderSvgText("+", 100, ganttHeaderHeight / 2 + 5, "middle", "auto", "16", "bold", ganttTheme.AddButtonText)
                        @RenderSvgText("Machines", 10, ganttHeaderHeight / 2 + 4, "start", "auto", "11", "600", ganttTheme.HeaderText)
                    </g>

                    @* Job Filter Row - shows job swatches with checkboxes *@
                    @{
                        var jobFilterRowY = ganttHeaderHeight;
                        var jobFilterRowHeight = ganttTimeline.JobFilterRowHeight;
                        var ganttJobFilterEntries = GetGanttJobFilterEntries().ToList();
                    }
                    <rect x="0" y="@jobFilterRowY" width="@ganttTimeline.GetTimelineWidth()" height="@jobFilterRowHeight"
                          fill="#f8fafc" stroke="#e2e8f0" />
                    @* Jobs label *@
                    <rect x="0" y="@jobFilterRowY" width="120" height="@jobFilterRowHeight"
                          fill="#f1f5f9" stroke="#e2e8f0" />
                    @RenderSvgText("Jobs", 10, jobFilterRowY + jobFilterRowHeight / 2 + 4, "start", "auto", "10", "600", "#64748b")
                    @* Job swatches - horizontal list *@
                    @{
                        var jobSwatchX = 130.0;
                        var swatchSize = 18;
                        var swatchGap = 8;
                    }
                    @foreach (var jobEntry in ganttJobFilterEntries)
                    {
                        var jColor = jobEntry.Color;
                        var jIsVisible = IsGanttJobVisible(jobEntry.Id);
                        var jSwatchY = jobFilterRowY + (jobFilterRowHeight - swatchSize) / 2;
                        var jPatternId = ganttColorService.GetPatternId(jobEntry.Id, jColor);
                        var jFillValue = !string.IsNullOrEmpty(jPatternId) ? $"url(#{jPatternId})" : jColor;

                        <g class="job-filter-swatch @(jIsVisible ? "" : "hidden")"
                           @onclick="@(() => ToggleGanttJobVisibility(jobEntry.Id))"
                           @onclick:stopPropagation="true"
                           style="cursor: pointer;">
                            @* Swatch background/border *@
                            <rect x="@jobSwatchX" y="@jSwatchY" width="@swatchSize" height="@swatchSize" rx="3"
                                  fill="@jFillValue" stroke="@(jIsVisible ? GanttColorService.DarkenColor(jColor) : "#cbd5e1")"
                                  stroke-width="@(jIsVisible ? 1.5 : 1)" opacity="@(jIsVisible ? 1 : 0.4)" />
                            @* Checkmark when visible *@
                            @if (jIsVisible)
                            {
                                <path d="M @(jobSwatchX + 4) @(jSwatchY + swatchSize/2) l 3 3 l 6 -7"
                                      stroke="@GanttColorService.GetContrastingTextColor(jColor)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                            }
                            @* Job name tooltip area *@
                            <title>@jobEntry.Name - Click to @(jIsVisible ? "hide" : "show")</title>
                        </g>
                        jobSwatchX += swatchSize + swatchGap;
                    }
                    @* Show All / Hide All buttons *@
                    @if (ganttJobFilterEntries.Count > 0)
                    {
                        var allBtnX = jobSwatchX + 10;
                        <g class="job-filter-btn" @onclick="ShowAllGanttJobs" @onclick:stopPropagation="true" style="cursor: pointer;">
                            <rect x="@allBtnX" y="@(jobFilterRowY + 6)" width="28" height="20" rx="3" fill="#e2e8f0" stroke="#94a3b8" />
                            @RenderSvgText("All", allBtnX + 14, jobFilterRowY + 19, "middle", "auto", "9", "500", "#475569")
                            <title>Show all jobs</title>
                        </g>
                        <g class="job-filter-btn" @onclick="HideAllGanttJobs" @onclick:stopPropagation="true" style="cursor: pointer;">
                            <rect x="@(allBtnX + 32)" y="@(jobFilterRowY + 6)" width="36" height="20" rx="3" fill="#e2e8f0" stroke="#94a3b8" />
                            @RenderSvgText("None", allBtnX + 50, jobFilterRowY + 19, "middle", "auto", "9", "500", "#475569")
                            <title>Hide all jobs</title>
                        </g>
                        <g class="job-filter-btn" @onclick="InvertGanttJobVisibility" @onclick:stopPropagation="true" style="cursor: pointer;">
                            <rect x="@(allBtnX + 72)" y="@(jobFilterRowY + 6)" width="36" height="20" rx="3" fill="#e2e8f0" stroke="#94a3b8" />
                            @RenderSvgText("Invert", allBtnX + 90, jobFilterRowY + 19, "middle", "auto", "9", "500", "#475569")
                            <title>Invert job visibility</title>
                        </g>
                    }

                    @* Machine rows *@
                    @for (int mIdx = 0; mIdx < ganttMachineNodes.Count; mIdx++)
                    {
                        var machine = ganttMachineNodes[mIdx];
                        var mRowY = ganttTimeline.GetRowY(mIdx);
                        var mIsEvenRow = mIdx % 2 == 0;

                        @* Row background *@
                        <rect x="0" y="@mRowY" width="@ganttTimeline.GetTimelineWidth()" height="@ganttTimeline.RowHeight"
                              fill="@(mIsEvenRow ? ganttTheme.RowEvenFill : ganttTheme.RowOddFill)" />

                        @* Machine label *@
                        <rect x="0" y="@mRowY" width="120" height="@ganttTimeline.RowHeight"
                              fill="@ganttTheme.MachineLabelFill" stroke="@ganttTheme.MachineLabelStroke" />
                        @RenderSvgText(machine.Text ?? "Machine", 10, mRowY + ganttTimeline.RowHeight / 2 + 4, "start", "auto", "11", "500", ganttTheme.MachineLabelText)
                    }

                    @* Precedence arrows *@
                    @foreach (var edge in edges)
                    {
                        var fromGTask = ganttTaskNodes.FirstOrDefault(t => t.Id == edge.From);
                        var toGTask = ganttTaskNodes.FirstOrDefault(t => t.Id == edge.To);
                        if (fromGTask != null && toGTask != null &&
                            fromGTask.GanttStartTime.HasValue && fromGTask.GanttDuration.HasValue &&
                            toGTask.GanttStartTime.HasValue)
                        {
                            var fromMIdx = ganttMachineNodes.FindIndex(m => m.Id == fromGTask.GanttMachineId);
                            var toMIdx = ganttMachineNodes.FindIndex(m => m.Id == toGTask.GanttMachineId);
                            if (fromMIdx >= 0 && toMIdx >= 0)
                            {
                                var pfromX = ganttTimeline.TimeToX(fromGTask.GanttStartTime.Value + fromGTask.GanttDuration.Value);
                                var pfromY = ganttTimeline.GetRowY(fromMIdx) + ganttTimeline.RowHeight / 2;
                                var ptoX = ganttTimeline.TimeToX(toGTask.GanttStartTime.Value);
                                var ptoY = ganttTimeline.GetRowY(toMIdx) + ganttTimeline.RowHeight / 2;

                                var pIsViolation = toGTask.GanttIsViolation;
                                var pArrowColor = pIsViolation ? ganttTheme.ViolationStroke : ganttTheme.DependencyStroke;
                                var pMarkerUrl = pIsViolation ? "url(#gantt-timeline-arrow-violation)" : "url(#gantt-timeline-arrow)";

                                @* Draw curved arrow *@
                                var pmidX = (pfromX + ptoX) / 2;
                                var ppath = $"M {pfromX} {pfromY} Q {pmidX} {pfromY} {pmidX} {(pfromY + ptoY) / 2} Q {pmidX} {ptoY} {ptoX} {ptoY}";
                                <path d="@ppath" stroke="@pArrowColor" stroke-width="1.5" fill="none" marker-end="@pMarkerUrl" />
                            }
                        }
                    }

                    @* Task bars *@
                    @foreach (var gtask in ganttTaskNodes)
                    {
                        if (gtask.GanttStartTime.HasValue && gtask.GanttDuration.HasValue && gtask.GanttMachineId.HasValue)
                        {
                            var tMachineIndex = ganttMachineNodes.FindIndex(m => m.Id == gtask.GanttMachineId);
                            if (tMachineIndex >= 0)
                            {
                                var tX = ganttTimeline.TimeToX(gtask.GanttStartTime.Value);
                                var tY = ganttTimeline.GetRowY(tMachineIndex) + 4;
                                var tWidth = ganttTimeline.DurationToWidth(gtask.GanttDuration.Value);
                                var tHeight = ganttTimeline.RowHeight - 8;

                                var tIsSelected = selectedGanttTaskId == gtask.Id;
                                // Use task's FillColor directly (set when task created or when connected)
                                var tJobColor = !string.IsNullOrEmpty(gtask.FillColor)
                                    ? gtask.FillColor
                                    : (gtask.GanttJobId.HasValue ? ganttColorService.GetJobFillColor(gtask.GanttJobId.Value) : "#3b82f6");
                                var tStrokeColor = gtask.GanttIsViolation ? "#ef4444" : (tIsSelected ? dfdTheme.CurrentTheme.SelectionStroke : (!string.IsNullOrEmpty(gtask.StrokeColor) ? gtask.StrokeColor : GanttColorService.DarkenColor(tJobColor)));
                                var tStrokeWidth = gtask.GanttIsViolation ? 2.5 : (tIsSelected ? 2.5 : 1.5);

                                // Get pattern for job differentiation
                                var tPatternId = gtask.GanttJobId.HasValue
                                    ? ganttColorService.GetPatternId(gtask.GanttJobId.Value, tJobColor)
                                    : "";
                                var tFillValue = !string.IsNullOrEmpty(tPatternId)
                                    ? $"url(#{tPatternId})"
                                    : tJobColor;

                                var tIsHovered = hoveredGanttTaskId == gtask.Id;
                                var tJobName = gtask.GanttJobId.HasValue
                                    ? nodes.FirstOrDefault(n => n.Id == gtask.GanttJobId.Value)?.Text ?? "Job"
                                    : "";
                                var tTooltip = $"{gtask.Text ?? "Task"}" + (!string.IsNullOrEmpty(tJobName) ? $" ({tJobName})" : "") +
                                    $"\nStart: {gtask.GanttStartTime:hh\\:mm}" +
                                    $"\nDuration: {gtask.GanttDuration:hh\\:mm}";

                                <g class="gantt-task @(tIsSelected ? "selected" : "") @(tIsHovered ? "hovered" : "") @(gtask.GanttIsViolation ? "violation" : "") @(mode == EditorMode.Select ? "draggable" : "")"
                                   @onclick="@(e => SelectGanttTask(gtask.Id, e))"
                                   @onclick:stopPropagation="true"
                                   @onmouseenter="@(() => { hoveredGanttTaskId = gtask.Id; StateHasChanged(); })"
                                   @onmouseleave="@(() => { if (hoveredGanttTaskId == gtask.Id) { hoveredGanttTaskId = null; StateHasChanged(); } })"
                                   style="cursor: @(mode == EditorMode.Select ? "grab" : "pointer");">
                                    @* SVG tooltip *@
                                    <title>@tTooltip</title>
                                    @* Invisible expanded hit area for easier grabbing *@
                                    <rect x="@(tX - 4)" y="@(tY - 4)" width="@(tWidth + 8)" height="@(tHeight + 8)"
                                          fill="transparent" class="gantt-task-hitarea" />
                                    @* Task bar with pattern *@
                                    <rect x="@tX" y="@tY" width="@tWidth" height="@tHeight" rx="4" ry="4"
                                          fill="@tFillValue" stroke="@tStrokeColor" stroke-width="@tStrokeWidth" class="gantt-task-bar" />

                                    @* Task label *@
                                    @if (tWidth > 40)
                                    {
                                        var tLabelText = gtask.Text ?? "Task";
                                        var tMaxChars = Math.Max(1, (int)(tWidth / 7) - 2);
                                        var tDisplayText = tLabelText.Length > tMaxChars ? tLabelText.Substring(0, tMaxChars) + ".." : tLabelText;
                                        @RenderSvgText(tDisplayText, tX + tWidth / 2, tY + tHeight / 2 + 4, "middle", "auto", "10", "normal", GanttColorService.GetContrastingTextColor(tJobColor))
                                    }

                                    @* Violation indicator *@
                                    @if (gtask.GanttIsViolation)
                                    {
                                        <circle cx="@(tX + tWidth - 8)" cy="@(tY + 8)" r="6" fill="#fef2f2" stroke="@ganttTheme.ViolationStroke" />
                                        @RenderSvgText("!", tX + tWidth - 8, tY + 11, "middle", "auto", "8", "normal", ganttTheme.ViolationStroke)
                                    }

                                    @* Flowchart-style terminals with stem lines *@
                                    @{
                                        var termRadius = 6;
                                        var stemLength = 10;
                                        var inputColor = ganttTheme.TerminalInputColor;
                                        var outputColor = ganttTheme.TerminalOutputColor;
                                        var tCenterY = tY + tHeight / 2;
                                    }
                                    @* Left terminal (input) - stem + circle *@
                                    <g class="gantt-terminal left"
                                       @onclick="@(e => HandleGanttTerminalClick(gtask.Id, "input", e))"
                                       @onclick:stopPropagation="true"
                                       style="cursor: pointer;">
                                        <line x1="@tX" y1="@tCenterY" x2="@(tX - stemLength)" y2="@tCenterY"
                                              stroke="@inputColor" stroke-width="2" />
                                        <circle cx="@(tX - stemLength)" cy="@tCenterY" r="@termRadius"
                                                fill="@inputColor" stroke="white" stroke-width="2" />
                                    </g>
                                    @* Right terminal (output) - stem + circle *@
                                    <g class="gantt-terminal right"
                                       @onclick="@(e => HandleGanttTerminalClick(gtask.Id, "output", e))"
                                       @onclick:stopPropagation="true"
                                       style="cursor: pointer;">
                                        <line x1="@(tX + tWidth)" y1="@tCenterY" x2="@(tX + tWidth + stemLength)" y2="@tCenterY"
                                              stroke="@outputColor" stroke-width="2" />
                                        <circle cx="@(tX + tWidth + stemLength)" cy="@tCenterY" r="@termRadius"
                                                fill="@outputColor" stroke="white" stroke-width="2" />
                                    </g>
                                </g>
                            }
                        }
                    }

                    @* Current time indicator *@
                    @{
                        var nowX = ganttTimeline.TimeToX(ganttTimeline.CurrentTimeInTimeline);
                        var tlTotalHeight = ganttTimeline.GetTimelineHeight(ganttMachineNodes.Count);
                    }
                    <line x1="@nowX" y1="@ganttHeaderHeight" x2="@nowX" y2="@tlTotalHeight"
                          stroke="@ganttTheme.TodayLine" stroke-width="2" />
                    <polygon points="@(nowX - 5),@ganttHeaderHeight @(nowX + 5),@ganttHeaderHeight @nowX,@(ganttHeaderHeight + 8)"
                             fill="@ganttTheme.TodayLine" />

                    @* Deadline marker line - draggable vertical line *@
                    @if (ganttDeadlineTime.HasValue)
                    {
                        var deadlineX = ganttTimeline.TimeToX(ganttDeadlineTime.Value);
                        <g class="gantt-deadline-marker" style="cursor: ew-resize;">
                            @* Invisible wider hit area for easier grabbing *@
                            <rect x="@(deadlineX - 8)" y="0" width="16" height="@tlTotalHeight"
                                  fill="transparent" pointer-events="all"
                                  @onmousedown="StartGanttDeadlineDrag"
                                  @onmousedown:stopPropagation="true" />
                            @* Visible deadline line *@
                            <line x1="@deadlineX" y1="0" x2="@deadlineX" y2="@tlTotalHeight"
                                  stroke="#111827" stroke-width="2" stroke-dasharray="8,4" />
                            @* Header triangle marker *@
                            <polygon points="@(deadlineX - 6),0 @(deadlineX + 6),0 @deadlineX,10"
                                     fill="#111827" />
                            @* Label in header *@
                            @RenderSvgText($"Deadline: {ganttDeadlineTime.Value:hh\\:mm}", deadlineX + 10, 12, "start", "auto", "9", "600", "#111827")
                        </g>
                    }

                    @* Rubberband for precedence creation in timeline *@
                    @if (ganttPrecedenceFromTaskId.HasValue)
                    {
                        var rbFromTask = ganttTaskNodes.FirstOrDefault(t => t.Id == ganttPrecedenceFromTaskId.Value);
                        if (rbFromTask != null && rbFromTask.GanttStartTime.HasValue && rbFromTask.GanttDuration.HasValue && rbFromTask.GanttMachineId.HasValue)
                        {
                            var rbMachineIndex = ganttMachineNodes.FindIndex(m => m.Id == rbFromTask.GanttMachineId);
                            if (rbMachineIndex >= 0)
                            {
                                var rbFromX = ganttTimeline.TimeToX(rbFromTask.GanttStartTime.Value + rbFromTask.GanttDuration.Value);
                                var rbFromY = ganttTimeline.GetRowY(rbMachineIndex) + ganttTimeline.RowHeight / 2;
                                <line x1="@rbFromX" y1="@rbFromY" x2="@ganttRubberbandX" y2="@ganttRubberbandY"
                                      stroke="@dfdTheme.CurrentTheme.SelectionStroke" stroke-width="2" stroke-dasharray="5,5" />
                                <circle cx="@ganttRubberbandX" cy="@ganttRubberbandY" r="5"
                                        fill="@dfdTheme.CurrentTheme.SelectionStroke" />
                            }
                        }
                    }
                </svg>
            </div>
        }
        } @* end else if (isGanttMode) *@

<div class="side-panel right-panel @(isRightPanelCollapsed ? "collapsed" : "")">
            <button class="panel-collapse-toggle" @onclick="@(() => isRightPanelCollapsed = !isRightPanelCollapsed)" title="@(isRightPanelCollapsed ? "Expand panel" : "Collapse panel")">
                @(isRightPanelCollapsed ? "◀" : "▶")
            </button>
            @if (!isRightPanelCollapsed)
            {
            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseMinimap = !collapseMinimap)">
                    <span>🗺️ Minimap</span>
                    <span class="collapse-icon">@(collapseMinimap ? "▶" : "▼")</span>
                </button>
                @if (!collapseMinimap)
                {
                    <div class="section-content">
                        <div class="minimap-container" @onclick="HandleMinimapClick" style="cursor: crosshair;">
                            @if (isGanttMode && ganttTimeline != null && ganttTimelineView)
                            {
                                @* Gantt mode minimap with dynamic viewBox *@
                                var ganttMiniWidth = ganttTimeline.GetTimelineWidth();
                                var ganttMiniHeight = ganttTimeline.GetTimelineHeight(GetGanttMachineNodes().Count());
                                var ganttStrokeWidth = Math.Max(4, ganttMiniWidth / 500);
                                var miniGanttTheme = dfdTheme.GetGanttColors();
                                <svg class="minimap" viewBox="0 0 @ganttMiniWidth @ganttMiniHeight" preserveAspectRatio="xMidYMid meet" @ref="minimapRef">
                                    <rect x="0" y="0" width="@ganttMiniWidth" height="@ganttMiniHeight" fill="@miniGanttTheme.CanvasBackground" stroke="@miniGanttTheme.HeaderStroke" />
                                    @* Machine rows *@
                                    @{
                                        var miniGanttMachines = GetGanttMachineNodes().ToList();
                                        for (int mi = 0; mi < miniGanttMachines.Count; mi++)
                                        {
                                            var rowY = ganttTimeline.GetRowY(mi);
                                            <rect x="0" y="@rowY" width="@ganttMiniWidth" height="@ganttTimeline.RowHeight"
                                                  fill="@(mi % 2 == 0 ? miniGanttTheme.RowEvenFill : miniGanttTheme.RowOddFill)" />
                                        }
                                    }
                                    @* Task bars - apply layer overrides for minimap *@
                                    @{
                                        var miniVisibleLayers = layerService.GetVisibleLayers().ToList();
                                        var miniAllTasks = GetGanttTaskNodes().ToList();
                                        IEnumerable<Node> miniGanttTasks;

                                        if (isBaseLayerVisible)
                                        {
                                            miniGanttTasks = miniVisibleLayers.Count > 0
                                                ? miniAllTasks.Select(t => layerService.GetEffectiveNode(t, miniVisibleLayers))
                                                : miniAllTasks;
                                        }
                                        else if (miniVisibleLayers.Count > 0)
                                        {
                                            var miniOverriddenIds = miniVisibleLayers.SelectMany(l => l.NodeOverrides.Keys).ToHashSet();
                                            miniGanttTasks = miniAllTasks
                                                .Where(t => miniOverriddenIds.Contains(t.Id))
                                                .Select(t => layerService.GetEffectiveNode(t, miniVisibleLayers));
                                        }
                                        else
                                        {
                                            miniGanttTasks = Enumerable.Empty<Node>();
                                        }
                                    }
                                    @foreach (var task in miniGanttTasks)
                                    {
                                        if (task.GanttStartTime.HasValue && task.GanttDuration.HasValue)
                                        {
                                            var tx = ganttTimeline.TimeToX(task.GanttStartTime.Value);
                                            var tw = ganttTimeline.DurationToWidth(task.GanttDuration.Value);
                                            var tMachineIdx = miniGanttMachines.FindIndex(m => m.Id == task.GanttMachineId);
                                            if (tMachineIdx >= 0)
                                            {
                                                var ty = ganttTimeline.GetRowY(tMachineIdx) + 4;
                                                var th = ganttTimeline.RowHeight - 8;
                                                <rect x="@tx" y="@ty" width="@tw" height="@th"
                                                      fill="@(task.FillColor ?? miniGanttTheme.TaskDefaultFill)" stroke="@(task.StrokeColor ?? miniGanttTheme.TaskDefaultStroke)" stroke-width="1" />
                                            }
                                        }
                                    }
                                    @* Viewport indicator - scale by zoom level *@
                                    <rect x="@(scrollX / zoomLevel)" y="@(scrollY / zoomLevel)"
                                          width="@(viewportWidth / zoomLevel)" height="@(viewportHeight / zoomLevel)"
                                          fill="@miniGanttTheme.SelectionFill"
                                          stroke="@miniGanttTheme.SelectionStroke" stroke-width="@ganttStrokeWidth"
                                          style="cursor: move;" />
                                </svg>
                            }
                            else if (isProjectMode && projectTimeline != null && projectViewMode == "timeline")
                            {
                                @* Project mode minimap with dynamic viewBox *@
                                var projMiniWidth = GetProjectTotalWidth();
                                var projMiniHeight = GetProjectTotalHeight();
                                var projStrokeWidth = Math.Max(4, projMiniWidth / 500);
                                <svg class="minimap" viewBox="0 0 @projMiniWidth @projMiniHeight" preserveAspectRatio="xMidYMid meet" @ref="minimapRef">
                                    <rect x="0" y="0" width="@projMiniWidth" height="@projMiniHeight" fill="#f8fafc" stroke="#e2e8f0" />
                                    @* Task bars *@
                                    @{
                                        var projNodes = GetprojectNodes().ToList();
                                        for (int ri = 0; ri < projNodes.Count; ri++)
                                        {
                                            var pnode = projNodes[ri];
                                            if (pnode.ProjectStartDate.HasValue)
                                            {
                                                var bounds = projectTimeline.GetNodeBarBounds(pnode);
                                                var py = projectTimeline.RowToY(ri) + 6;
                                                var ph = projectTimeline.RowHeight - 12;
                                                <rect x="@bounds.x" y="@py" width="@bounds.width" height="@ph"
                                                      fill="@(pnode.FillColor ?? "#3b82f6")" stroke="@(pnode.StrokeColor ?? "#1e40af")" stroke-width="1" />
                                            }
                                        }
                                    }
                                    @* Viewport indicator - scale by zoom level *@
                                    <rect x="@(scrollX / zoomLevel)" y="@(scrollY / zoomLevel)"
                                          width="@(viewportWidth / zoomLevel)" height="@(viewportHeight / zoomLevel)"
                                          fill="rgba(59, 130, 246, 0.1)"
                                          stroke="#3b82f6" stroke-width="@projStrokeWidth"
                                          style="cursor: move;" />
                                </svg>
                            }
                            else
                            {
                                @* Standard minimap for DFD mode *@
                                <svg class="minimap" viewBox="0 0 4000 4000" preserveAspectRatio="xMidYMid meet" @ref="minimapRef">
                                    <rect x="0" y="0" width="4000" height="4000" fill="#f8fafc" stroke="#e2e8f0" />
                                    @foreach (var node in nodes)
                                    {
                                        <rect x="@node.X" y="@node.Y"
                                              width="@node.Width" height="@node.Height"
                                              fill="white" stroke="@node.StrokeColor" stroke-width="8" />
                                    }
                                    @foreach (var edge in edges)
                                    {
                                        <path d="@edge.PathData"
                                              stroke="@(edge.StrokeColor ?? "#374151")"
                                              stroke-width="6" fill="none" />
                                    }
                                    @* Viewport indicator *@
                                    <rect x="@scrollX" y="@scrollY"
                                          width="@viewportWidth" height="@viewportHeight"
                                          fill="rgba(59, 130, 246, 0.1)"
                                          stroke="#3b82f6" stroke-width="20"
                                          style="cursor: move;" />
                                </svg>
                            }
                        </div>
                    </div>
                }
            </div>

            @* Solution Layers Panel - only for Gantt and Project modes *@
            @if (selectedTemplateId == "gantt" || selectedTemplateId == "project")
            {
            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseLayers = !collapseLayers)">
                    <span>📊 Layers</span>
                    <span class="collapse-icon">@(collapseLayers ? "▶" : "▼")</span>
                </button>
                @if (!collapseLayers)
                {
                    <div class="section-content layer-panel">
                        @* Active Layer Indicator *@
                        @{
                            var activeLayer = layerService.GetActiveLayer();
                        }
                        <div class="active-layer-indicator" style="background-color: @(activeLayer?.LayerColor ?? "#6b7280")20; border-left: 3px solid @(activeLayer?.LayerColor ?? "#6b7280");">
                            <span class="active-layer-label">Editing:</span>
                            <span class="active-layer-name">@(activeLayer?.Name ?? "Base Layer")</span>
                        </div>

                        @* Layer List *@
                        <div class="layer-list">
                            @* Base Layer (always present but can be hidden) *@
                            <div class="layer-item @(layerService.ActiveLayerId == null ? "active" : "") @(!isBaseLayerVisible ? "hidden-layer" : "")"
                                 @onclick="@(() => layerService.SetActiveLayer(null))">
                                <button class="layer-visibility @(!isBaseLayerVisible ? "invisible" : "")"
                                        @onclick="@(() => { isBaseLayerVisible = !isBaseLayerVisible; StateHasChanged(); })"
                                        @onclick:stopPropagation="true"
                                        title="@(isBaseLayerVisible ? "Hide base layer" : "Show base layer")">
                                    @(isBaseLayerVisible ? "👁️" : "👁️‍🗨️")
                                </button>
                                <span class="layer-color" style="background-color: #6b7280;"></span>
                                <span class="layer-name">Base Layer</span>
                                <span class="layer-type">(original)</span>
                            </div>

                            @* Solution Layers *@
                            @foreach (var layer in layerService.GetLayers())
                            {
                                <div class="layer-item @(layer.IsActive ? "active" : "") @(!layer.IsVisible ? "hidden-layer" : "")"
                                     @onclick="@(() => layerService.SetActiveLayer(layer.Id))">
                                    <button class="layer-visibility @(!layer.IsVisible ? "invisible" : "")"
                                            @onclick="@(() => { layerService.ToggleLayerVisibility(layer.Id); StateHasChanged(); })"
                                            @onclick:stopPropagation="true"
                                            title="@(layer.IsVisible ? "Hide layer" : "Show layer")">
                                        @(layer.IsVisible ? "👁️" : "👁️‍🗨️")
                                    </button>
                                    <span class="layer-color" style="background-color: @layer.LayerColor;"></span>
                                    @if (editingLayerName == layer.Id)
                                    {
                                        <input type="text" class="layer-name-input"
                                               value="@editingLayerNameValue"
                                               @onchange="@((e) => FinishLayerRename(layer.Id, e.Value?.ToString() ?? layer.Name))"
                                               @onblur="@(() => editingLayerName = null)"
                                               @onkeydown="@((e) => { if (e.Key == "Escape") editingLayerName = null; })"
                                               @onclick:stopPropagation="true" />
                                    }
                                    else
                                    {
                                        <span class="layer-name" @ondblclick="@(() => StartLayerRename(layer.Id, layer.Name))"
                                              @ondblclick:stopPropagation="true"
                                              title="Double-click to rename">
                                            @layer.Name
                                        </span>
                                    }
                                    <span class="layer-type">@layer.SolverType</span>
                                    <button class="layer-delete"
                                            @onclick="@(() => { layerService.DeleteLayer(layer.Id); StateHasChanged(); })"
                                            @onclick:stopPropagation="true"
                                            title="Delete layer">
                                        ✕
                                    </button>
                                </div>
                            }
                        </div>

                        @* Layer Actions *@
                        <div class="layer-actions">
                            <button class="panel-btn" @onclick="CreateNewLayer" title="Create empty layer for manual edits">
                                ➕ New Layer
                            </button>
                            @if (layerService.GetLayers().Count > 0)
                            {
                                <button class="panel-btn" @onclick="@(() => { foreach (var l in layerService.GetLayers().ToList()) if (!l.IsVisible) layerService.ToggleLayerVisibility(l.Id); StateHasChanged(); })"
                                        title="Show all layers">
                                    👁️ Show All
                                </button>
                            }
                        </div>

                        @* Layer Metrics (if active layer has metrics) *@
                        @if (activeLayer != null && activeLayer.ComputedMetrics.Count > 0)
                        {
                            <div class="layer-metrics">
                                <div class="metrics-header">Metrics</div>
                                @foreach (var metric in activeLayer.ComputedMetrics)
                                {
                                    <div class="metric-row">
                                        <span class="metric-name">@metric.Key:</span>
                                        <span class="metric-value">@metric.Value.ToString("N2")</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
            }

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseInfo = !collapseInfo)">
                    <span>ℹ️ Info</span>
                    <span class="collapse-icon">@(collapseInfo ? "▶" : "▼")</span>
                </button>
                @if (!collapseInfo)
                {
                    @if (selectedTemplateId == "project" && selectedProjectTaskId.HasValue)
                    {
                        @* Show selected Project task info *@
                        var selectedTask = GetProjectNode(selectedProjectTaskId.Value);
                        if (selectedTask != null)
                        {
                            <div class="section-content">
                                <div class="property-group">
                                    <label>Task</label>
                                    <div class="property-row">
                                        <span>Name:</span>
                                    </div>
                                    <input type="text" class="property-input"
                                           value="@selectedTask.Text"
                                           @onchange="@((e) => { selectedTask.Text = e.Value?.ToString() ?? ""; StateHasChanged(); })" />
                                    <div class="stat-row">
                                        <span>Start:</span>
                                        <span>@(selectedTask.ProjectStartDate?.ToString("MMM d, yyyy") ?? "—")</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>End:</span>
                                        <span>@(selectedTask.ProjectEndDate?.ToString("MMM d, yyyy") ?? "—")</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>Duration:</span>
                                        <span>@selectedTask.ProjectDurationDays day@(selectedTask.ProjectDurationDays != 1 ? "s" : "")</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>Progress:</span>
                                        <span>@selectedTask.ProjectPercentComplete%</span>
                                    </div>
                                    @if (selectedTask.IsSuperNode)
                                    {
                                        <div class="stat-row">
                                            <span>Type:</span>
                                            <span>Summary (@selectedTask.ContainedNodeIds.Count tasks)</span>
                                        </div>
                                    }
                                    else if (selectedTask.ProjectIsMilestone)
                                    {
                                        <div class="stat-row">
                                            <span>Type:</span>
                                            <span>Milestone</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(selectedTask.ProjectAssignedTo))
                                    {
                                        <div class="stat-row">
                                            <span>Assigned:</span>
                                            <span>@selectedTask.ProjectAssignedTo</span>
                                        </div>
                                    }
                                </div>
                                <div class="property-group">
                                    <label>Cost</label>
                                    <div class="stat-row">
                                        <span>$/Day:</span>
                                        <input type="number" class="property-input-small"
                                               value="@selectedTask.ProjectCostPerDay"
                                               @onchange="@((e) => { if (decimal.TryParse(e.Value?.ToString(), out var cost)) { selectedTask.ProjectCostPerDay = cost; StateHasChanged(); } })"
                                               style="width: 70px; text-align: right;" />
                                    </div>
                                    @if (!selectedTask.ProjectIsMilestone && selectedTask.ProjectDurationDays > 0)
                                    {
                                        <div class="stat-row">
                                            <span>Total:</span>
                                            <span>$@((selectedTask.ProjectCostPerDay * selectedTask.ProjectDurationDays).ToString("N0"))</span>
                                        </div>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(selectedTask.ProjectNotes))
                                {
                                    <div class="property-group">
                                        <label>Notes</label>
                                        <div style="font-size: 11px; color: #64748b;">@selectedTask.ProjectNotes</div>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        @* Default statistics view *@
                        <div class="section-content">
                            <div class="property-group">
                                <label>Statistics</label>
                                <div class="stat-row">
                                    <span>Nodes:</span>
                                    <span>@nodes.Count</span>
                                </div>
                                <div class="stat-row">
                                    <span>Edges:</span>
                                    <span>@edges.Count</span>
                                </div>
                                <div class="stat-row">
                                    <span>Labels:</span>
                                    <span>@edgeLabels.Count</span>
                                </div>
                            </div>
                            <div class="property-group">
                                <label>Canvas</label>
                                <div class="stat-row">
                                    <span>Size:</span>
                                    <span>4000x4000</span>
                                </div>
                                <div class="stat-row">
                                    <span>Background:</span>
                                    <span>@canvasBackground</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            @* Resources Panel - show in Project mode *@
            @if (isProjectMode)
            {
                <div class="panel-section">
                    <button class="section-header" @onclick="ToggleProjectResourcesPanel">
                        <span>👥 Resources (@GetProjectResourceCount())</span>
                        <span class="collapse-icon">@(collapseProjectResources ? "▶" : "▼")</span>
                    </button>
                    @if (!collapseProjectResources)
                    {
                        <div class="section-content">
                            @if (GetProjectResourceCount() == 0)
                            {
                                <div style="font-size: 11px; color: #94a3b8; font-style: italic; padding: 8px 0;">
                                    No resources yet. Add resources from the Shape dropdown.
                                </div>
                            }
                            else
                            {
                                <div style="font-size: 10px; color: #64748b; margin-bottom: 8px;">
                                    Drag a resource onto a task to assign it
                                </div>
                                @foreach (var resource in GetProjectResourceNodes())
                                {
                                    var resId = resource.Id;
                                    var icon = ProjectTimelineService.GetResourceTypeIcon(resource.ProjectResourceType);
                                    var assignmentCount = resource.ProjectAssignedTaskIds?.Count ?? 0;
                                    var isDragging = draggingResourceId == resource.Id;
                                    <div class="project-resource-item @(isDragging ? "resource-dragging" : "")"
                                         @onmousedown="@(e => StartResourceDrag(resId, e))"
                                         @ondblclick="@(() => EditProjectResource(resId))"
                                         @ondblclick:stopPropagation="true"
                                         style="user-select: none;"
                                         title="Double-click to edit, drag to assign to a task">
                                        <span class="resource-icon">@icon</span>
                                        <span class="resource-name">@resource.Text</span>
                                        @if (assignmentCount > 0)
                                        {
                                            <span class="resource-assignments">@assignmentCount task@(assignmentCount != 1 ? "s" : "")</span>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            }

            @* Node Properties - show when exactly one node is selected *@
            @if (selectedNodes.Count == 1)
            {
                var selectedNode = nodes.FirstOrDefault(n => n.Id == selectedNodes.First());
                if (selectedNode != null)
                {
                    <div class="panel-section">
                        <button class="section-header" @onclick="@(() => collapseNodeProperties = !collapseNodeProperties)">
                            <span>📦 Node</span>
                            <span class="collapse-icon">@(collapseNodeProperties ? "▶" : "▼")</span>
                        </button>
                        @if (!collapseNodeProperties)
                        {
                            <div class="section-content">
                                <div class="property-group">
                                    <div class="property-row">
                                        <span>Text:</span>
                                    </div>
                                    <textarea class="property-textarea"
                                              value="@selectedNode.Text"
                                              @onchange="@((e) => UpdateNodeText(selectedNode.Id, e.Value?.ToString() ?? ""))"
                                              placeholder="Enter node text..."
                                              rows="3"></textarea>
                                    <div class="stat-row">
                                        <span>Position:</span>
                                        <span>@((int)selectedNode.X), @((int)selectedNode.Y)</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>Size:</span>
                                        <span>@((int)selectedNode.Width) × @((int)selectedNode.Height)</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>Shape:</span>
                                        <span>@selectedNode.Shape</span>
                                    </div>
                                    @if (selectedNode.TemplateId == "circuit" && !string.IsNullOrEmpty(selectedNode.ComponentLabel))
                                    {
                                        <div class="stat-row">
                                            <span>Component:</span>
                                            <span>@selectedNode.ComponentLabel</span>
                                        </div>
                                        <div class="property-row" style="margin-top: 8px;">
                                            <span>Value:</span>
                                        </div>
                                        <input type="text" class="panel-input"
                                               value="@selectedNode.ComponentValue"
                                               @onchange="@((e) => { selectedNode.ComponentValue = e.Value?.ToString(); StateHasChanged(); })"
                                               placeholder="e.g., 10kΩ, 100µF, 5V" />
                                    }
                                    @* QMaker queueing network - show summary only, full edit on double-click *@
                                    @if (selectedNode.TemplateId == "qmaker")
                                    {
                                        <div class="qmaker-properties" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                            <div class="stat-row" style="font-weight: 600; color: #374151; margin-bottom: 8px;">
                                                <span>Queueing Parameters</span>
                                            </div>
                                            @* Show summary based on node type *@
                                            @if (selectedNode.TemplateShapeId == "source")
                                            {
                                                <div class="stat-row" style="font-size: 12px;">
                                                    <span>λ = @(selectedNode.QueueArrivalRate ?? 1.0)</span>
                                                </div>
                                            }
                                            else if (selectedNode.TemplateShapeId == "router")
                                            {
                                                <div class="stat-row" style="font-size: 12px;">
                                                    <span>p = @((selectedNode.QueueRoutingProbability ?? 0.5).ToString("F2"))</span>
                                                </div>
                                            }
                                            else if (selectedNode.TemplateShapeId == "splitter")
                                            {
                                                <div class="stat-row" style="font-size: 12px;">
                                                    <span>1 → @selectedNode.OutputTerminalCount outputs</span>
                                                </div>
                                            }
                                            else if (selectedNode.TemplateShapeId == "collector")
                                            {
                                                <div class="stat-row" style="font-size: 12px;">
                                                    <span>@selectedNode.InputTerminalCount → 1 output</span>
                                                </div>
                                            }
                                            else if (selectedNode.TemplateShapeId != "sink" && selectedNode.TemplateShapeId != "fork" && selectedNode.TemplateShapeId != "join")
                                            {
                                                <div class="stat-row" style="font-size: 11px; color: #0ea5e9; font-weight: 600;">
                                                    <span>@GetKendallNotation(selectedNode)</span>
                                                </div>
                                            }
                                            <div class="stat-row" style="font-size: 11px; color: #9ca3af; font-style: italic; margin-top: 8px;">
                                                <span>Double-click to edit parameters</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="icon-picker-section">
                                    <label>Icon</label>
                                    <div class="icon-picker">
                                        <button class="icon-btn @(string.IsNullOrEmpty(selectedNode.Icon) ? "selected" : "")"
                                                @onclick="@(() => { selectedNode.Icon = null; StateHasChanged(); })"
                                                title="No icon">
                                            <span style="color: #9ca3af; font-size: 14px;">✕</span>
                                        </button>
                                        @foreach (var category in IconCategories)
                                        {
                                            @foreach (var iconName in category.Value)
                                            {
                                                if (IconLibrary.TryGetValue(iconName, out var iconData))
                                                {
                                                    <button class="icon-btn @(selectedNode.Icon == iconName ? "selected" : "")"
                                                            @onclick="@(() => { selectedNode.Icon = iconName; StateHasChanged(); })"
                                                            title="@iconName">
                                                        <svg width="18" height="18" viewBox="@iconData.ViewBox">
                                                            <path d="@iconData.Path" fill="@(selectedNode.Icon == iconName ? "#3b82f6" : "#374151")"/>
                                                        </svg>
                                                    </button>
                                                }
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (selectedNodes.Count > 1)
            {
                <div class="property-group">
                    <label>Selection</label>
                    <div class="stat-row">
                        <span>Nodes:</span>
                        <span>@selectedNodes.Count</span>
                    </div>
                </div>
            }

            @* Edge Label Properties - show when exactly one label is selected *@
            @if (selectedLabels.Count == 1)
            {
                var selectedLabel = edgeLabels.FirstOrDefault(l => l.Id == selectedLabels.First());
                if (selectedLabel != null)
                {
                    <div class="property-group">
                        <label>Label Properties</label>
                        <div class="property-row">
                            <span>Text:</span>
                        </div>
                        <textarea class="property-textarea"
                                  value="@selectedLabel.Text"
                                  @onchange="@((e) => UpdateLabelText(selectedLabel.Id, e.Value?.ToString() ?? ""))"
                                  placeholder="Enter label text..."
                                  rows="2"></textarea>
                        <div class="stat-row">
                            <span>Position:</span>
                            <span>@((int)selectedLabel.X), @((int)selectedLabel.Y)</span>
                        </div>
                    </div>
                }
            }

            @* Edge Properties - show when edges are selected *@
            @if (selectedEdges.Count > 0)
            {
                <div class="property-group">
                    <label>Edge Selection</label>
                    <div class="stat-row">
                        <span>Edges:</span>
                        <span>@selectedEdges.Count</span>
                    </div>
                    <button class="btn-small" @onclick="@(() => showEdgeStylePanel = !showEdgeStylePanel)">
                        ✏️ Edit Style
                    </button>
                </div>
            }
            }
        </div>
    </div>

    @* Edge Style Panel *@
    @if (showEdgeStylePanel && selectedEdges.Count > 0)
    {
        <div class="edge-style-panel">
            <h3>Edit Edge Style (@selectedEdges.Count selected)</h3>

            @* Connector Style Dropdown - Updates immediately *@
            <div class="panel-row">
                <label>Connector Style:</label>
                <select value="@editEdgeStyle" @onchange="OnEdgeStyleChanged" class="edge-dropdown">
                    <option value="@EdgeStyle.Direct">Direct (Straight)</option>
                    <option value="@EdgeStyle.Ortho">Orthogonal (Right Angles)</option>
                    <option value="@EdgeStyle.OrthoRound">Ortho Rounded</option>
                    <option value="@EdgeStyle.Bezier">Bezier (Smooth Curve)</option>
                    <option value="@EdgeStyle.Arc">Arc (Single Curve)</option>
                    <option value="@EdgeStyle.Stylized">Stylized (Fancy)</option>
                </select>
            </div>

            @* Visual preview of connector styles *@
            <div class="connector-preview">
                <svg viewBox="0 0 280 40" style="width:100%;height:40px;">
                    @if (editEdgeStyle == EdgeStyle.Direct)
                    {
                        <circle cx="20" cy="20" r="6" fill="#3b82f6"/>
                        <line x1="26" y1="20" x2="254" y2="20" stroke="#374151" stroke-width="2"/>
                        <circle cx="260" cy="20" r="6" fill="#3b82f6"/>
                        <polygon points="250,15 260,20 250,25" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Ortho)
                    {
                        <circle cx="20" cy="10" r="6" fill="#3b82f6"/>
                        <path d="M26 10 H140 V30 H254" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="30" r="6" fill="#3b82f6"/>
                        <polygon points="250,25 260,30 250,35" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.OrthoRound)
                    {
                        <circle cx="20" cy="10" r="6" fill="#3b82f6"/>
                        <path d="M26 10 H130 Q140 10 140 20 V20 Q140 30 150 30 H254" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="30" r="6" fill="#3b82f6"/>
                        <polygon points="250,25 260,30 250,35" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Bezier)
                    {
                        <circle cx="20" cy="10" r="6" fill="#3b82f6"/>
                        <path d="M26 10 C80 10, 200 30, 254 30" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="30" r="6" fill="#3b82f6"/>
                        <polygon points="250,25 260,30 250,35" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Arc)
                    {
                        <circle cx="20" cy="20" r="6" fill="#3b82f6"/>
                        <path d="M26 20 A120 40 0 0 1 254 20" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="20" r="6" fill="#3b82f6"/>
                        <polygon points="250,15 260,20 250,25" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Stylized)
                    {
                        <circle cx="20" cy="12" r="6" fill="#3b82f6"/>
                        <path d="M26 12 Q35 7 38 17 C70 5, 220 35, 254 28" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="28" r="6" fill="#3b82f6"/>
                        <polygon points="250,23 260,28 250,33" fill="#374151"/>
                    }
                </svg>
            </div>

            <div class="panel-row">
                <label>Line Width:</label>
                <select value="@editStrokeWidth" @onchange="@(e => { editStrokeWidth = int.Parse(e.Value?.ToString() ?? "2"); OnEdgePropertyChanged(); })" class="edge-dropdown">
                    <option value="1">1px</option>
                    <option value="2">2px</option>
                    <option value="3">3px</option>
                    <option value="4">4px</option>
                    <option value="5">5px</option>
                </select>
            </div>

            <div class="panel-row">
                <label>Line Style:</label>
                <select value="@editStrokeDashArray" @onchange="@(e => { editStrokeDashArray = e.Value?.ToString() ?? ""; OnEdgePropertyChanged(); })" class="edge-dropdown">
                    @foreach (var style in lineStyles)
                    {
                        <option value="@style.Key">@style.Value</option>
                    }
                </select>
            </div>

            <div class="panel-row">
                <label>Color:</label>
                <div class="color-picker">
                    @foreach (var color in presetColors)
                    {
                        <button class="color-swatch @(editStrokeColor == color ? "selected" : "")"
                                style="background-color: @color;"
                                @onclick="@(() => { editStrokeColor = color; OnEdgePropertyChanged(); })">
                        </button>
                    }
                </div>
            </div>

            <div class="panel-row">
                <label class="checkbox-label">
                    <input type="checkbox" checked="@editIsDoubleLine" 
                           @onchange="@(e => { editIsDoubleLine = (bool)(e.Value ?? false); OnEdgePropertyChanged(); })" />
                    Double Line
                </label>
            </div>

            <div class="panel-row">
                <label>Arrow:</label>
                <select value="@editArrowDirection" @onchange="@(e => { editArrowDirection = Enum.Parse<ArrowDirection>(e.Value?.ToString() ?? "End"); OnEdgePropertyChanged(); })" class="edge-dropdown">
                    <option value="@ArrowDirection.End">→ End Only</option>
                    <option value="@ArrowDirection.Start">← Start Only</option>
                    <option value="@ArrowDirection.Both">↔ Both Ends</option>
                    <option value="@ArrowDirection.None">— No Arrow</option>
                </select>
            </div>

            @* Project dependency Properties - shown when any selected edge is a Project dependency *@
            @if (selectedEdges.Any(id => edges.FirstOrDefault(e => e.Id == id)?.IsProjectDependency == true))
            {
                <div class="panel-section-divider"></div>
                <h4 style="margin: 8px 0 4px 0; color: #6b7280;">Dependency Properties</h4>

                <div class="panel-row">
                    <label>Type:</label>
                    <select value="@editProjectDepType" @onchange="@(e => { editProjectDepType = Enum.Parse<ProjectDependencyType>(e.Value?.ToString() ?? "FinishToStart"); OnProjectDepPropertyChanged(); })" class="edge-dropdown">
                        <option value="@ProjectDependencyType.FinishToStart">FS (Finish-to-Start)</option>
                        <option value="@ProjectDependencyType.StartToStart">SS (Start-to-Start)</option>
                        <option value="@ProjectDependencyType.FinishToFinish">FF (Finish-to-Finish)</option>
                        <option value="@ProjectDependencyType.StartToFinish">SF (Start-to-Finish)</option>
                    </select>
                </div>

                <div class="panel-row">
                    <label>Lag:</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" value="@editProjectLagDays"
                               @onchange="@(e => { editProjectLagDays = int.TryParse(e.Value?.ToString(), out var v) ? v : 0; OnProjectDepPropertyChanged(); })"
                               style="width: 60px;" class="edge-dropdown" />
                        <span style="color: #6b7280;">days</span>
                    </div>
                </div>

                <div class="panel-row" style="font-size: 11px; color: #9ca3af;">
                    @{
                        var depTypeDesc = editProjectDepType switch
                        {
                            ProjectDependencyType.FinishToStart => "Successor starts after predecessor finishes",
                            ProjectDependencyType.StartToStart => "Both tasks start together",
                            ProjectDependencyType.FinishToFinish => "Both tasks finish together",
                            ProjectDependencyType.StartToFinish => "Successor finishes when predecessor starts",
                            _ => ""
                        };
                    }
                    @depTypeDesc
                    @if (editProjectLagDays != 0)
                    {
                        <span> (@(editProjectLagDays > 0 ? "+" : "")@editProjectLagDays days)</span>
                    }
                </div>
            }

            <div class="panel-buttons">
                <button @onclick="ApplyEdgeStylesToSelected" class="btn-apply">
                    Apply to Selected
                </button>
                <button @onclick="ApplyEdgeStylesToAll" class="btn-apply-all">
                    Apply to All Edges
                </button>
                <button @onclick="@(() => showEdgeStylePanel = false)" class="btn-cancel">
                    Close
                </button>
            </div>
        </div>
    }

    @* Background Configuration Dialog *@
    @if (showBackgroundConfig)
    {
        <div class="dialog-overlay" @onclick="@(() => showBackgroundConfig = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>Configure Background</h2>

                @if (canvasBackground == "swimlanes-h" || canvasBackground == "swimlanes-v")
                {
                    <div class="config-section">
                        <label>Number of Swimlanes:</label>
                        <select @bind="swimlaneCount" class="config-dropdown">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>

                    <div class="config-section">
                        <label>Swimlane Labels:</label>
                        @for (int i = 0; i < swimlaneCount; i++)
                        {
                            var index = i;
                            <input type="text"
                                   value="@(swimlaneLabels.Count > index ? swimlaneLabels[index] : $"Lane {index + 1}")"
                                   @onchange="@((e) => UpdateSwimlaneLabel(index, e.Value?.ToString() ?? ""))"
                                   class="label-input"
                                   placeholder="@($"Lane {index + 1}")" />
                        }
                    </div>
                }
                else if (canvasBackground == "columns")
                {
                    <div class="config-section">
                        <label>Number of Columns:</label>
                        <select @bind="columnCount" class="config-dropdown">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>

                    <div class="config-section">
                        <label>Column Labels:</label>
                        @for (int i = 0; i < columnCount; i++)
                        {
                            var index = i;
                            <input type="text"
                                   value="@(columnLabels.Count > index ? columnLabels[index] : $"Column {index + 1}")"
                                   @onchange="@((e) => UpdateColumnLabel(index, e.Value?.ToString() ?? ""))"
                                   class="label-input"
                                   placeholder="@($"Column {index + 1}")" />
                        }
                    </div>
                }

                <div class="dialog-buttons">
                    <button @onclick="@(() => showBackgroundConfig = false)" class="btn-close">
                        Close
                    </button>
                </div>
            </div>
        </div>
    }

    @* About Dialog *@
    @if (showAboutDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showAboutDialog = false)">
            <div class="dialog" @onclick:stopPropagation="true" style="max-width: 400px;">
                <h2>About DFD Editor</h2>
                <div style="padding: 1rem 0; line-height: 1.8;">
                    <p><strong>DFD Editor v2</strong></p>
                    <p>A visual editor for Data Flow Diagrams</p>
                    <br />
                    <p><strong>Built by:</strong></p>
                    <p>Manbir Sodhi</p>
                    <p><a href="mailto:sodhi@uri.edu" style="color: #3b82f6;">sodhi@uri.edu</a></p>
                    <p>University of Rhode Island</p>
                    <br />
                    <p style="color: #6b7280; font-size: 0.875rem;">Built with Blazor WebAssembly</p>
                </div>
                <div class="dialog-buttons">
                    <button class="btn-primary" @onclick="@(() => showAboutDialog = false)">Close</button>
                </div>
            </div>
        </div>
    }

    @* Load Dialog *@
    @if (showLoadDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showLoadDialog = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>Import Diagram</h2>
                <p>Paste your diagram below. Supports: JSON, Mermaid, DOT (GraphViz)</p>
                
                <div style="margin-bottom: 10px;">
                    <label>Format:</label>
                    <select @bind="importFormat" style="margin-left: 10px; padding: 5px;">
                        <option value="auto">Auto-detect</option>
                        <option value="json">JSON</option>
                        <option value="mermaid">Mermaid</option>
                        <option value="dot">DOT (GraphViz)</option>
                    </select>
                </div>
                
                <textarea class="dialog-textarea" @bind="loadDiagramJson" 
                          placeholder="Paste JSON, Mermaid, or DOT diagram here..."></textarea>
                @if (!string.IsNullOrEmpty(loadErrorMessage))
                {
                    <div class="error-message">@loadErrorMessage</div>
                }
                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="LoadDiagram">Import</button>
                    <button class="btn-secondary" @onclick="@(() => { showLoadDialog = false; loadDiagramJson = ""; loadErrorMessage = ""; })">Cancel</button>
                </div>
            </div>
        </div>
    }

    @* Export Dialog *@
    @if (showExportDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showExportDialog = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>@exportDialogTitle</h2>
                <p>@exportDialogDescription</p>
                <textarea readonly class="dialog-textarea">@exportedContent</textarea>
                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="CopyToClipboard">Copy to Clipboard</button>
                    <button class="btn-secondary" @onclick="@(() => showExportDialog = false)">Close</button>
                </div>
            </div>
        </div>
    }

    @* Clear Confirmation Dialog *@
    @if (showClearConfirm)
    {
        <div class="dialog-overlay" @onclick="@(() => showClearConfirm = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>Clear All?</h2>
                <p>This will delete all nodes, edges, and labels. This action cannot be undone (unless you use Undo immediately after).</p>
                <div class="dialog-actions">
                    <button class="btn-primary" style="background: #ef4444;" @onclick="ConfirmClear">Yes, Clear All</button>
                    <button class="btn-secondary" @onclick="@(() => showClearConfirm = false)">Cancel</button>
                </div>
            </div>
        </div>
    }

    @* Theme Configurator Dialog *@
    @if (showThemeConfigurator)
    {
        <div class="dialog-overlay" @onclick="@(() => showThemeConfigurator = false)">
            <div class="dialog-content theme-configurator" @onclick:stopPropagation="true" style="min-width: 700px; max-height: 85vh; overflow-y: auto;">
                <h2>Theme Configurator</h2>

                <div class="theme-config-tabs">
                    <button class="@(themeConfigTab == "select" ? "active" : "")" @onclick="@(() => themeConfigTab = "select")">Select Theme</button>
                    <button class="@(themeConfigTab == "edit" ? "active" : "")" @onclick="@(() => themeConfigTab = "edit")">Edit Colors</button>
                    <button class="@(themeConfigTab == "export" ? "active" : "")" @onclick="@(() => themeConfigTab = "export")">Export/Import</button>
                </div>

                @if (themeConfigTab == "select")
                {
                    <div class="theme-select-grid">
                        @foreach (var theme in dfdTheme.GetAvailableThemes())
                        {
                            <div class="theme-card @(dfdTheme.CurrentThemeId == theme.Id ? "selected" : "")"
                                 @onclick="@(() => { ApplyTheme(theme.Id); InitEditingTheme(); })">
                                <div class="theme-preview">
                                    <div class="preview-swatch" style="background: @(dfdTheme.Themes.TryGetValue(theme.Id, out var t) ? t.ProcessFill : "#dbeafe")"></div>
                                    <div class="preview-swatch" style="background: @(dfdTheme.Themes.TryGetValue(theme.Id, out var t2) ? t2.DecisionFill : "#fef3c7")"></div>
                                    <div class="preview-swatch" style="background: @(dfdTheme.Themes.TryGetValue(theme.Id, out var t3) ? t3.ExternalEntityFill : "#f3e8ff")"></div>
                                    <div class="preview-swatch" style="background: @(dfdTheme.Themes.TryGetValue(theme.Id, out var t4) ? t4.DataStoreFill : "#fef3c7")"></div>
                                </div>
                                <div class="theme-info">
                                    <strong>@theme.Name</strong> @(theme.IsCustom ? "(Custom)" : "")
                                    <small>@theme.Description</small>
                                </div>
                                @if (dfdTheme.CurrentThemeId == theme.Id)
                                {
                                    <span class="theme-check">✓</span>
                                }
                            </div>
                        }
                    </div>

                    <div class="theme-actions" style="margin-top: 16px;">
                        <button class="btn-secondary" @onclick="CreateNewTheme">+ New Theme from Current</button>
                    </div>
                }

                @if (themeConfigTab == "edit" && editingThemeData != null)
                {
                    <div class="theme-edit-header">
                        <input type="text" @bind="editingThemeData.Name" placeholder="Theme Name" class="theme-name-input" />
                        <input type="text" @bind="editingThemeData.Description" placeholder="Description" class="theme-desc-input" />
                    </div>

                    <div class="color-sections">
                        <div class="color-section">
                            <h4>Node Colors</h4>
                            <div class="color-grid">
                                <div class="color-row">
                                    <label>Process Fill</label>
                                    <input type="color" @bind="editingThemeData.ProcessFill" />
                                    <input type="text" @bind="editingThemeData.ProcessFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Process Stroke</label>
                                    <input type="color" @bind="editingThemeData.ProcessStroke" />
                                    <input type="text" @bind="editingThemeData.ProcessStroke" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Decision Fill</label>
                                    <input type="color" @bind="editingThemeData.DecisionFill" />
                                    <input type="text" @bind="editingThemeData.DecisionFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Decision Stroke</label>
                                    <input type="color" @bind="editingThemeData.DecisionStroke" />
                                    <input type="text" @bind="editingThemeData.DecisionStroke" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>External Entity Fill</label>
                                    <input type="color" @bind="editingThemeData.ExternalEntityFill" />
                                    <input type="text" @bind="editingThemeData.ExternalEntityFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>External Entity Stroke</label>
                                    <input type="color" @bind="editingThemeData.ExternalEntityStroke" />
                                    <input type="text" @bind="editingThemeData.ExternalEntityStroke" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Data Store Fill</label>
                                    <input type="color" @bind="editingThemeData.DataStoreFill" />
                                    <input type="text" @bind="editingThemeData.DataStoreFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Data Store Stroke</label>
                                    <input type="color" @bind="editingThemeData.DataStoreStroke" />
                                    <input type="text" @bind="editingThemeData.DataStoreStroke" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Default Node Fill</label>
                                    <input type="color" @bind="editingThemeData.NodeFill" />
                                    <input type="text" @bind="editingThemeData.NodeFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Default Node Stroke</label>
                                    <input type="color" @bind="editingThemeData.NodeStroke" />
                                    <input type="text" @bind="editingThemeData.NodeStroke" class="color-hex" />
                                </div>
                            </div>
                        </div>

                        <div class="color-section">
                            <h4>Edge & Canvas Colors</h4>
                            <div class="color-grid">
                                <div class="color-row">
                                    <label>Edge Stroke</label>
                                    <input type="color" @bind="editingThemeData.EdgeStroke" />
                                    <input type="text" @bind="editingThemeData.EdgeStroke" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Edge Arrow</label>
                                    <input type="color" @bind="editingThemeData.EdgeArrow" />
                                    <input type="text" @bind="editingThemeData.EdgeArrow" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Canvas Background</label>
                                    <input type="color" @bind="editingThemeData.CanvasBackground" />
                                    <input type="text" @bind="editingThemeData.CanvasBackground" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Canvas Grid</label>
                                    <input type="color" @bind="editingThemeData.CanvasGrid" />
                                    <input type="text" @bind="editingThemeData.CanvasGrid" class="color-hex" />
                                </div>
                            </div>
                        </div>

                        <div class="color-section">
                            <h4>Project Colors</h4>
                            <div class="color-grid">
                                <div class="color-row">
                                    <label>Task Fill</label>
                                    <input type="color" @bind="editingThemeData.TaskFill" />
                                    <input type="text" @bind="editingThemeData.TaskFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Task Stroke</label>
                                    <input type="color" @bind="editingThemeData.TaskStroke" />
                                    <input type="text" @bind="editingThemeData.TaskStroke" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Milestone Fill</label>
                                    <input type="color" @bind="editingThemeData.MilestoneFill" />
                                    <input type="text" @bind="editingThemeData.MilestoneFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Critical Fill</label>
                                    <input type="color" @bind="editingThemeData.CriticalFill" />
                                    <input type="text" @bind="editingThemeData.CriticalFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Group Fill</label>
                                    <input type="color" @bind="editingThemeData.GroupFill" />
                                    <input type="text" @bind="editingThemeData.GroupFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Selection Stroke</label>
                                    <input type="color" @bind="editingThemeData.SelectionStroke" />
                                    <input type="text" @bind="editingThemeData.SelectionStroke" class="color-hex" />
                                </div>
                            </div>
                        </div>

                        <div class="color-section">
                            <h4>Calendar Colors</h4>
                            <div class="color-grid">
                                <div class="color-row">
                                    <label>Weekend Fill</label>
                                    <input type="color" @bind="editingThemeData.WeekendFill" />
                                    <input type="text" @bind="editingThemeData.WeekendFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Saturday Fill</label>
                                    <input type="color" @bind="editingThemeData.SaturdayFill" />
                                    <input type="text" @bind="editingThemeData.SaturdayFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Sunday Fill</label>
                                    <input type="color" @bind="editingThemeData.SundayFill" />
                                    <input type="text" @bind="editingThemeData.SundayFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Holiday Fill</label>
                                    <input type="color" @bind="editingThemeData.HolidayFill" />
                                    <input type="text" @bind="editingThemeData.HolidayFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Christmas Fill</label>
                                    <input type="color" @bind="editingThemeData.ChristmasFill" />
                                    <input type="text" @bind="editingThemeData.ChristmasFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>New Year Fill</label>
                                    <input type="color" @bind="editingThemeData.NewYearFill" />
                                    <input type="text" @bind="editingThemeData.NewYearFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Company Event Fill</label>
                                    <input type="color" @bind="editingThemeData.CompanyEventFill" />
                                    <input type="text" @bind="editingThemeData.CompanyEventFill" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Vacation Fill</label>
                                    <input type="color" @bind="editingThemeData.VacationFill" />
                                    <input type="text" @bind="editingThemeData.VacationFill" class="color-hex" />
                                </div>
                            </div>
                        </div>

                        <div class="color-section">
                            <h4>Project Row Colors</h4>

                            @* Row color mode selector *@
                            <div class="row-color-mode" style="margin-bottom: 12px;">
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <button class="@(rowColorMode == "individual" ? "btn-primary" : "btn-secondary")"
                                            style="flex: 1; padding: 4px 8px; font-size: 11px;"
                                            @onclick="@(() => rowColorMode = "individual")">Individual</button>
                                    <button class="@(rowColorMode == "all-same" ? "btn-primary" : "btn-secondary")"
                                            style="flex: 1; padding: 4px 8px; font-size: 11px;"
                                            @onclick="@(() => rowColorMode = "all-same")">All Same</button>
                                    <button class="@(rowColorMode == "gradient" ? "btn-primary" : "btn-secondary")"
                                            style="flex: 1; padding: 4px 8px; font-size: 11px;"
                                            @onclick="@(() => rowColorMode = "gradient")">Gradient</button>
                                </div>

                                @if (rowColorMode == "all-same")
                                {
                                    <div class="color-row" style="margin-bottom: 8px;">
                                        <label>Color</label>
                                        <input type="color" @bind="rowColorAllSame" />
                                        <input type="text" @bind="rowColorAllSame" class="color-hex" />
                                        <button class="btn-secondary" style="padding: 2px 8px; font-size: 11px;"
                                                @onclick="ApplyAllSameRowColor">Apply</button>
                                    </div>
                                }
                                else if (rowColorMode == "gradient")
                                {
                                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                        <div style="flex: 1;">
                                            <label style="font-size: 11px; display: block;">From</label>
                                            <div style="display: flex; gap: 4px;">
                                                <input type="color" @bind="rowColorGradientFrom" style="width: 32px;" />
                                                <input type="text" @bind="rowColorGradientFrom" class="color-hex" style="width: 70px;" />
                                            </div>
                                        </div>
                                        <div style="flex: 1;">
                                            <label style="font-size: 11px; display: block;">To</label>
                                            <div style="display: flex; gap: 4px;">
                                                <input type="color" @bind="rowColorGradientTo" style="width: 32px;" />
                                                <input type="text" @bind="rowColorGradientTo" class="color-hex" style="width: 70px;" />
                                            </div>
                                        </div>
                                        <button class="btn-secondary" style="padding: 2px 8px; font-size: 11px; margin-top: 16px;"
                                                @onclick="ApplyGradientRowColors">Apply</button>
                                    </div>
                                }
                            </div>

                            <div class="color-grid">
                                <div class="color-row">
                                    <label>Row 1</label>
                                    <input type="color" @bind="editingThemeData.RowColor1" />
                                    <input type="text" @bind="editingThemeData.RowColor1" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 2</label>
                                    <input type="color" @bind="editingThemeData.RowColor2" />
                                    <input type="text" @bind="editingThemeData.RowColor2" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 3</label>
                                    <input type="color" @bind="editingThemeData.RowColor3" />
                                    <input type="text" @bind="editingThemeData.RowColor3" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 4</label>
                                    <input type="color" @bind="editingThemeData.RowColor4" />
                                    <input type="text" @bind="editingThemeData.RowColor4" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 5</label>
                                    <input type="color" @bind="editingThemeData.RowColor5" />
                                    <input type="text" @bind="editingThemeData.RowColor5" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 6</label>
                                    <input type="color" @bind="editingThemeData.RowColor6" />
                                    <input type="text" @bind="editingThemeData.RowColor6" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 7</label>
                                    <input type="color" @bind="editingThemeData.RowColor7" />
                                    <input type="text" @bind="editingThemeData.RowColor7" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 8</label>
                                    <input type="color" @bind="editingThemeData.RowColor8" />
                                    <input type="text" @bind="editingThemeData.RowColor8" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 9</label>
                                    <input type="color" @bind="editingThemeData.RowColor9" />
                                    <input type="text" @bind="editingThemeData.RowColor9" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Row 10</label>
                                    <input type="color" @bind="editingThemeData.RowColor10" />
                                    <input type="text" @bind="editingThemeData.RowColor10" class="color-hex" />
                                </div>
                                <div class="color-row">
                                    <label>Group Row</label>
                                    <input type="color" @bind="editingThemeData.GroupRowColor" />
                                    <input type="text" @bind="editingThemeData.GroupRowColor" class="color-hex" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="theme-edit-actions">
                        <button class="btn-primary" @onclick="SaveEditingTheme">Save as Custom Theme</button>
                        <button class="btn-secondary" @onclick="PreviewEditingTheme">Preview</button>
                        <button class="btn-secondary" @onclick="@(() => InitEditingTheme())">Reset</button>
                    </div>
                }

                @if (themeConfigTab == "export")
                {
                    <div class="export-section">
                        <h4>Export Current Theme</h4>
                        <p>Copy this JSON to save your theme or share it:</p>
                        <textarea class="export-textarea" readonly>@dfdTheme.ExportThemeAsJson()</textarea>
                        <button class="btn-secondary" @onclick="CopyThemeToClipboard">Copy to Clipboard</button>
                    </div>

                    <div class="import-section">
                        <h4>Import Theme</h4>
                        <p>Paste theme JSON here:</p>
                        <textarea class="import-textarea" @bind="themeImportJson" placeholder="Paste theme JSON here..."></textarea>
                        @if (!string.IsNullOrEmpty(themeImportError))
                        {
                            <div class="import-error">@themeImportError</div>
                        }
                        <button class="btn-primary" @onclick="ImportThemeFromJson">Import Theme</button>
                    </div>
                }

                <div class="dialog-actions" style="margin-top: 16px; border-top: 1px solid #e5e7eb; padding-top: 16px;">
                    <button class="btn-secondary" @onclick="@(() => showThemeConfigurator = false)">Close</button>
                </div>
            </div>
        </div>
    }

    @* Project task Edit Dialog *@
    @if (showProjectTaskDialog && editingProjectTask != null)
    {
        <div class="dialog-overlay" @onclick="CancelProjectTaskEdit">
            <div class="dialog-content project-task-dialog" @onclick:stopPropagation="true" style="min-width: 400px;">
                <h2>Edit Task</h2>

                <div class="project-form-group">
                    <label>Task Name</label>
                    <input type="text" @bind="projectEditTaskName" placeholder="Enter task name" />
                </div>

                <div class="project-form-row">
                    <div class="project-form-group">
                        <label>Start Date</label>
                        <input type="text" @bind="projectEditStartDate" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}" />
                    </div>
                    <div class="project-form-group">
                        <label>Duration (days)</label>
                        <input type="number" @bind="projectEditDuration" min="0" disabled="@projectEditIsMilestone" />
                    </div>
                </div>

                <div class="project-form-row">
                    <div class="project-form-group">
                        <label>Progress (%)</label>
                        <input type="range" @bind="projectEditProgress" min="0" max="100" />
                        <span class="project-progress-value">@projectEditProgress%</span>
                    </div>
                    <div class="project-form-group project-checkbox-group">
                        <label>
                            <input type="checkbox" @bind="projectEditIsMilestone" />
                            Milestone
                        </label>
                    </div>
                </div>

                <div class="project-form-group">
                    <label>Notes</label>
                    <textarea @bind="projectEditNotes" rows="3" placeholder="Optional notes..."></textarea>
                </div>

                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="SaveProjectTaskEdit">Save</button>
                    <button class="btn-secondary" @onclick="CancelProjectTaskEdit">Cancel</button>
                    <button class="btn-danger" @onclick="DeleteEditingProjectTask" style="margin-left: auto;">Delete Task</button>
                </div>
            </div>
        </div>
    }

    @* Node Properties Dialog (Logical Properties) *@
    @if (showNodePropertiesDialog && propertiesDialogNode != null)
    {
        <div class="dialog-overlay" @onclick="CloseNodePropertiesDialog">
            <div class="dialog-content node-properties-dialog" @onclick:stopPropagation="true" style="min-width: 400px; max-width: 500px;">
                <h2>Node Properties</h2>
                <p style="color: #6b7280; margin-bottom: 16px;">@propertiesDialogNode.Text</p>

                @* Text/Name *@
                <div class="project-form-group">
                    <label>Text</label>
                    <textarea @bind="propertiesDialogNode.Text" rows="2" placeholder="Node text..."></textarea>
                </div>

                @* QMaker Queueing Parameters *@
                @if (propertiesDialogNode.TemplateId == "qmaker")
                {
                    <div class="qmaker-dialog-section">
                        <h3 style="margin: 16px 0 12px; font-size: 14px; color: #374151;">Queueing Parameters</h3>

                        @if (propertiesDialogNode.TemplateShapeId == "source")
                        {
                            <div class="project-form-row">
                                <div class="project-form-group">
                                    <label>Arrival Rate (λ)</label>
                                    <input type="number" step="0.1" min="0"
                                           @bind="propertiesDialogNode.QueueArrivalRate"
                                           placeholder="Arrivals per unit time" />
                                </div>
                                <div class="project-form-group">
                                    <label>Distribution</label>
                                    <select @bind="propertiesDialogNode.QueueArrivalDistribution">
                                        <option value="@QueueDistribution.Exponential">M - Exponential</option>
                                        <option value="@QueueDistribution.Deterministic">D - Deterministic</option>
                                        <option value="@QueueDistribution.General">G - General</option>
                                        <option value="@QueueDistribution.Erlang">Erlang-k</option>
                                    </select>
                                </div>
                            </div>
                        }
                        else if (propertiesDialogNode.TemplateShapeId == "router")
                        {
                            <div class="project-form-group">
                                <label>Routing Probability (p)</label>
                                <input type="number" step="0.1" min="0" max="1"
                                       @bind="propertiesDialogNode.QueueRoutingProbability"
                                       placeholder="0.0 to 1.0" />
                                <span style="font-size: 11px; color: #6b7280;">
                                    P(out1) = @((propertiesDialogNode.QueueRoutingProbability ?? 0.5).ToString("F2")),
                                    P(out2) = @((1 - (propertiesDialogNode.QueueRoutingProbability ?? 0.5)).ToString("F2"))
                                </span>
                            </div>
                        }
                        else if (propertiesDialogNode.TemplateShapeId == "splitter" || propertiesDialogNode.TemplateShapeId == "collector")
                        {
                            <div class="project-form-row">
                                <div class="project-form-group">
                                    <label>@(propertiesDialogNode.TemplateShapeId == "splitter" ? "Output Terminals" : "Input Terminals")</label>
                                    <input type="number" step="1" min="2" max="8"
                                           value="@(propertiesDialogNode.TemplateShapeId == "splitter" ? propertiesDialogNode.OutputTerminalCount : propertiesDialogNode.InputTerminalCount)"
                                           @onchange="@(e => {
                                               var count = int.TryParse(e.Value?.ToString(), out var v) && v >= 2 ? Math.Min(v, 8) : 2;
                                               if (propertiesDialogNode.TemplateShapeId == "splitter")
                                                   propertiesDialogNode.OutputTerminalCount = count;
                                               else
                                                   propertiesDialogNode.InputTerminalCount = count;
                                               StateHasChanged();
                                           })" />
                                </div>
                            </div>
                        }
                        else if (propertiesDialogNode.TemplateShapeId != "sink" && propertiesDialogNode.TemplateShapeId != "fork" && propertiesDialogNode.TemplateShapeId != "join")
                        {
                            @* Queue/Server properties *@
                            <div class="project-form-row">
                                <div class="project-form-group">
                                    <label>Service Rate (μ)</label>
                                    <input type="number" step="0.1" min="0"
                                           @bind="propertiesDialogNode.QueueServiceRate"
                                           placeholder="Services per unit time" />
                                </div>
                                <div class="project-form-group">
                                    <label>Service Distribution</label>
                                    <select @bind="propertiesDialogNode.QueueServiceDistribution">
                                        <option value="@QueueDistribution.Exponential">M - Exponential</option>
                                        <option value="@QueueDistribution.Deterministic">D - Deterministic</option>
                                        <option value="@QueueDistribution.General">G - General</option>
                                        <option value="@QueueDistribution.Erlang">Erlang-k</option>
                                    </select>
                                </div>
                            </div>
                            @if (propertiesDialogNode.TemplateShapeId != "server" && propertiesDialogNode.TemplateShapeId != "delay")
                            {
                                <div class="project-form-group">
                                    <label>Queue Capacity (K)</label>
                                    <input type="number" step="1" min="0"
                                           @bind="propertiesDialogNode.QueueCapacity"
                                           placeholder="0 = infinite" />
                                    <span style="font-size: 11px; color: #6b7280;">
                                        @(propertiesDialogNode.QueueCapacity.HasValue && propertiesDialogNode.QueueCapacity > 0 ? $"K = {propertiesDialogNode.QueueCapacity}" : "K = ∞ (infinite)")
                                    </span>
                                </div>
                            }
                            @if (propertiesDialogNode.TemplateShapeId == "mmc" || propertiesDialogNode.TemplateShapeId == "delay")
                            {
                                <div class="project-form-group">
                                    <label>Number of Servers (c)</label>
                                    <input type="number" step="1" min="1"
                                           @bind="propertiesDialogNode.QueueServerCount"
                                           placeholder="Parallel servers" />
                                </div>
                            }
                            <div class="project-form-group">
                                <label>Discipline</label>
                                <select @bind="propertiesDialogNode.QueueDiscipline">
                                    <option value="@QueueDiscipline.FIFO">FIFO - First In First Out</option>
                                    <option value="@QueueDiscipline.LIFO">LIFO - Last In First Out</option>
                                    <option value="@QueueDiscipline.Priority">Priority</option>
                                    <option value="@QueueDiscipline.Random">Random</option>
                                </select>
                            </div>
                            <div style="font-size: 12px; color: #0ea5e9; font-weight: 600; margin-top: 8px;">
                                Kendall: @GetKendallNotation(propertiesDialogNode)
                            </div>
                        }
                    </div>
                }

                @* Circuit Component Properties *@
                @if (propertiesDialogNode.TemplateId == "circuit" && !string.IsNullOrEmpty(propertiesDialogNode.ComponentLabel))
                {
                    <div class="circuit-dialog-section">
                        <h3 style="margin: 16px 0 12px; font-size: 14px; color: #374151;">Component Properties</h3>
                        <div class="project-form-row">
                            <div class="project-form-group">
                                <label>Component</label>
                                <input type="text" value="@propertiesDialogNode.ComponentLabel" disabled />
                            </div>
                            <div class="project-form-group">
                                <label>Value</label>
                                <input type="text" @bind="propertiesDialogNode.ComponentValue" placeholder="e.g., 10kΩ, 100µF" />
                            </div>
                        </div>
                    </div>
                }

                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="CloseNodePropertiesDialog">Done</button>
                </div>
            </div>
        </div>
    }

    @* Resource Assignment Dialog *@
    @if (showResourceAssignmentDialog && assigningToTask != null)
    {
        <div class="dialog-overlay" @onclick="CancelResourceAssignment">
            <div class="dialog-content resource-assignment-dialog" @onclick:stopPropagation="true">
                <h3>📋 Assign Resource to Task</h3>

                <div class="assignment-header">
                    @if (assigningResource != null)
                    {
                        <p>
                            Assigning <span class="resource-name">@(ProjectTimelineService.GetResourceTypeIcon(assigningResource.ProjectResourceType)) @assigningResource.Text</span>
                            to <span class="task-name">@assigningToTask.Text</span>
                        </p>
                    }
                    else
                    {
                        var newResType = GetResourceTypeFromShapeId(selectedTemplateShapeId);
                        var newResIcon = ProjectTimelineService.GetResourceTypeIcon(newResType);
                        <p>
                            Creating new <span class="resource-name">@newResIcon @ProjectTimelineService.GetResourceTypeName(newResType)</span>
                            for <span class="task-name">@assigningToTask.Text</span>
                        </p>
                    }
                </div>

                @if (assigningResource == null)
                {
                    <div class="form-group">
                        <label>Resource Name</label>
                        <input type="text" @bind="newResourceName" placeholder="Enter resource name..." />
                        <div class="form-hint">Name for this resource (leave empty for auto-generated name)</div>
                    </div>
                }

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" @bind="resourceAssignmentQuantity" min="1" max="100" />
                    <div class="form-hint">Number of this resource type needed (e.g., 2 people, 3 machines)</div>
                </div>

                <div class="form-group">
                    <label>Allocation Percentage</label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="range" @bind="resourceAssignmentPercentage" min="10" max="100" step="10" style="flex: 1;" />
                        <span class="range-value">@resourceAssignmentPercentage%</span>
                    </div>
                    <div class="form-hint">How much of this resource's time is allocated (100% = full-time)</div>
                </div>

                <div class="button-row">
                    <button class="btn-secondary" @onclick="CancelResourceAssignment">Cancel</button>
                    <button class="btn-primary" @onclick="ConfirmResourceAssignment">Assign Resource</button>
                </div>
            </div>
        </div>
    }

    @* Resource Edit Dialog *@
    @if (showProjectResourceDialog && editingProjectResource != null)
    {
        <div class="dialog-overlay" @onclick="CancelProjectResourceEdit">
            <div class="dialog-content resource-edit-dialog" @onclick:stopPropagation="true" style="min-width: 400px;">
                <h2>@(ProjectTimelineService.GetResourceTypeIcon(editingProjectResource.ProjectResourceType)) Edit Resource</h2>

                <div class="project-form-group">
                    <label>Resource Name</label>
                    <input type="text" @bind="projectEditResourceName" placeholder="Enter resource name" />
                </div>

                <div class="project-form-group">
                    <label>Resource Type</label>
                    <select @bind="projectEditResourceType">
                        @foreach (var type in Enum.GetValues<ProjectResourceType>())
                        {
                            <option value="@type">@(ProjectTimelineService.GetResourceTypeIcon(type)) @(ProjectTimelineService.GetResourceTypeName(type))</option>
                        }
                    </select>
                </div>

                <div class="project-form-row">
                    <div class="project-form-group">
                        <label>Capacity (%)</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="range" @bind="projectEditResourceCapacity" min="0" max="100" step="10" style="flex: 1;" />
                            <span class="range-value">@projectEditResourceCapacity%</span>
                        </div>
                        <div class="form-hint">Availability (100% = full-time)</div>
                    </div>
                    <div class="project-form-group">
                        <label>Rate ($/day)</label>
                        <input type="number" @bind="projectEditResourceRate" min="0" step="10" />
                        <div class="form-hint">Daily cost for budgeting</div>
                    </div>
                </div>

                @if (projectEditResourceType == ProjectResourceType.Person || projectEditResourceType == ProjectResourceType.Team)
                {
                    <div class="project-form-group">
                        <label>Email</label>
                        <input type="email" @bind="projectEditResourceEmail" placeholder="contact@example.com" />
                    </div>
                }

                <div class="project-form-group">
                    <label>Assigned Tasks (@(editingProjectResource.ProjectAssignedTaskIds?.Count ?? 0))</label>
                    <div class="assigned-tasks-list">
                        @if (editingProjectResource.ProjectAssignedTaskIds != null && editingProjectResource.ProjectAssignedTaskIds.Count > 0)
                        {
                            @foreach (var taskId in editingProjectResource.ProjectAssignedTaskIds)
                            {
                                var task = nodes.FirstOrDefault(n => n.Id == taskId);
                                if (task != null)
                                {
                                    <div class="assigned-task-item">
                                        <span>@task.Text</span>
                                        <button class="btn-small btn-danger" @onclick="@(() => UnassignResourceFromTask(editingProjectResource, task))" title="Unassign">✕</button>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="no-assignments">No tasks assigned</div>
                        }
                    </div>
                </div>

                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="SaveProjectResourceEdit">Save</button>
                    <button class="btn-secondary" @onclick="CancelProjectResourceEdit">Cancel</button>
                    <button class="btn-danger" @onclick="DeleteeditingProjectResource" style="margin-left: auto;">Delete Resource</button>
                </div>
            </div>
        </div>
    }

    @* Project Help Dialog *@
    @if (showProjectHelpDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showProjectHelpDialog = false)">
            <div class="dialog-content project-help-dialog" @onclick:stopPropagation="true" style="min-width: 600px; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                <h2>Project chart Help</h2>

                <div class="help-section">
                    <h3>Getting Started</h3>
                    <p>The Project chart helps you plan and track project schedules. Each task is shown as a horizontal bar spanning its duration.</p>
                </div>

                <div class="help-section">
                    <h3>Adding Tasks</h3>
                    <ul>
                        <li><strong>Add Shape:</strong> Click "Add Shape" in the toolbar, select a shape (Task, Milestone, Resource), then click on the canvas</li>
                        <li><strong>Add Milestone:</strong> Click "Add Milestone" for zero-duration checkpoint events</li>
                        <li><strong>Double-click:</strong> Double-click on empty space to add a task at that date</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Editing Tasks</h3>
                    <ul>
                        <li><strong>Double-click:</strong> Double-click a task bar to open the edit dialog</li>
                        <li><strong>Drag:</strong> Click and drag a task bar to move it to a different date</li>
                        <li><strong>Resize:</strong> Drag the left or right edge of a task bar to change duration</li>
                        <li><strong>Delete:</strong> Select a task and press Delete or Backspace</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Dependencies</h3>
                    <ul>
                        <li><strong>Create:</strong> Click "Link Tasks", then click the predecessor task, then the successor</li>
                        <li><strong>Types:</strong> Finish-to-Start (FS) is the default - successor starts after predecessor finishes</li>
                        <li><strong>Arrows:</strong> Dependencies are shown as arrows connecting task bars</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Scheduling</h3>
                    <ul>
                        <li><strong>Auto Schedule:</strong> Automatically positions tasks based on their dependencies</li>
                        <li><strong>Critical Path:</strong> Highlights tasks that directly affect the project end date</li>
                        <li><strong>Working Days:</strong> Weekends (Sat/Sun) are skipped in duration calculations</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Navigation</h3>
                    <ul>
                        <li><strong>Zoom:</strong> Use + / - keys or toolbar buttons to zoom in/out</li>
                        <li><strong>Fit to View:</strong> Shows all tasks in the visible area</li>
                        <li><strong>Scroll:</strong> Use mouse scroll or drag to navigate the timeline</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Visual Indicators</h3>
                    <ul>
                        <li><strong>Blue bars:</strong> Regular tasks</li>
                        <li><strong>Diamond:</strong> Milestones (zero-duration events)</li>
                        <li><strong>Progress fill:</strong> Shows percentage complete</li>
                        <li><strong>Red highlight:</strong> Critical path tasks (when enabled)</li>
                    </ul>
                </div>

                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="@(() => showProjectHelpDialog = false)">Close</button>
                </div>
            </div>
        </div>
    }

    @* Project Import Dialog *@
    @if (showProjectImportDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showProjectImportDialog = false)">
            <div class="dialog-content" @onclick:stopPropagation="true" style="min-width: 600px; max-width: 700px;">
                <h2>📥 Import Project Data</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">
                    Load a file or paste CSV, JSON, or MS Project XML. Formats are auto-detected.
                </p>

                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">📁 Load from file:</label>
                    <InputFile OnChange="OnProjectFileSelected" accept=".csv,.json,.xml,.txt"
                               style="margin-bottom: 0.5rem;" />
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">📋 Or paste data:</label>
                    <textarea @bind="projectImportText"
                              style="width: 100%; height: 180px; font-family: monospace; font-size: 12px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; resize: vertical;"
                              placeholder="Name,Start Date,End Date,Duration,Predecessors
Task A,2025-01-06,2025-01-10,5,
Task B,2025-01-13,2025-01-17,5,1
Task C,2025-01-20,2025-01-24,5,2"></textarea>
                </div>

                @if (!string.IsNullOrEmpty(projectImportError))
                {
                    <div style="background: #fee2e2; color: #dc2626; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                        ⚠️ @projectImportError
                    </div>
                }

                <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                    <strong>Supported formats:</strong>
                    <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                        <li><strong>CSV</strong> - Flexible column names (Name/Task, Start Date/Begin, End/Finish, Duration, Predecessors)</li>
                        <li><strong>JSON</strong> - { tasks: [...], dependencies: [...] }</li>
                        <li><strong>MS Project XML</strong> - Export from Microsoft Project</li>
                    </ul>
                </div>

                <div class="dialog-actions">
                    <button class="btn-secondary" @onclick="@(() => { showProjectImportDialog = false; projectImportError = ""; })">Cancel</button>
                    <button class="btn-primary" @onclick="ImportProjectData">Import</button>
                </div>
            </div>
        </div>
    }

    @* Gantt Import Dialog *@
    @if (showGanttImportDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showGanttImportDialog = false)">
            <div class="dialog-content" @onclick:stopPropagation="true" style="min-width: 600px; max-width: 700px;">
                <h2>📥 Import Job-Shop Schedule</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">
                    Load a JSON file or paste job-shop scheduling data.
                </p>

                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">📁 Load from file:</label>
                    <InputFile OnChange="OnGanttFileSelected" accept=".json,.txt"
                               style="margin-bottom: 0.5rem;" />
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">📋 Or paste JSON:</label>
                    <textarea @bind="ganttImportText" @bind:event="oninput" @bind:after="() => OnGanttImportTextChanged(ganttImportText)"
                              style="width: 100%; height: 160px; font-family: monospace; font-size: 12px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; resize: vertical;"
                              placeholder='{
  "name": "My Job Shop",
  "machines": 5,
  "jobs": 8,
  "time_unit": "minutes",
  "data": [
    [[0,15,33], [1,22,52], [2,10,74]],
    [[1,12,0], [0,20,13], [3,14,34]]
  ]
}'></textarea>
                </div>

                @* Solution detection info *@
                @if (ganttImportIsSolution)
                {
                    <div style="background: #dcfce7; color: #166534; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                        ✓ Solution file detected (includes scheduled start times)
                    </div>

                    @if (nodes.Any(n => n.IsGanttTask))
                    {
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" @bind="ganttImportAsLayer" style="width: 16px; height: 16px;" />
                                <span><strong>Import as Layer</strong> - Apply solution to existing tasks (creates a new layer)</span>
                            </label>
                        </div>
                    }
                }

                @if (!string.IsNullOrEmpty(ganttImportError))
                {
                    <div style="background: #fee2e2; color: #dc2626; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                        ⚠️ @ganttImportError
                    </div>
                }

                <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                    <strong>JSON Format:</strong>
                    <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                        <li><strong>Problem</strong>: data = [[machine, duration], ...] per job</li>
                        <li><strong>Solution</strong>: data = [[machine, duration, start_time], ...] per job</li>
                        <li><strong>makespan</strong>, <strong>status</strong> - Solution metadata (optional)</li>
                    </ul>
                </div>

                <div class="dialog-actions">
                    <button class="btn-secondary" @onclick="@(() => { showGanttImportDialog = false; ganttImportError = ""; ganttImportAsLayer = false; ganttImportIsSolution = false; })">Cancel</button>
                    <button class="btn-primary" @onclick="ImportGanttData">
                        @(ganttImportAsLayer ? "Import as Layer" : "Import")
                    </button>
                </div>
            </div>
        </div>
    }

    @* Job Shop Solver Dialog *@
    @if (showJobShopSolverDialog)
    {
        <div class="dialog-overlay" @onclick="CloseSolverDialog">
            <div class="dialog-content" @onclick:stopPropagation="true" style="min-width: 500px; max-width: 600px;">
                <h2>🧮 Job Shop Scheduler</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">
                    Run scheduling algorithms to optimize task start times.
                </p>

                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Algorithm:</label>
                    <select @bind="selectedSolverAlgorithm" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        <option value="SPT">SPT - Shortest Processing Time</option>
                        <option value="LPT">LPT - Longest Processing Time</option>
                        <option value="FCFS">FCFS - First Come First Served</option>
                        <option value="MWR">MWR - Most Work Remaining</option>
                        <option value="LWR">LWR - Least Work Remaining</option>
                        <option value="Best">Best - Try all, pick best</option>
                    </select>
                </div>

                <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                    <strong>Algorithm Info:</strong>
                    <ul style="margin: 0.5rem 0 0 1.25rem; padding: 0;">
                        @switch(selectedSolverAlgorithm)
                        {
                            case "SPT":
                                <li>Prioritizes shorter operations first</li>
                                <li>Often minimizes average flow time</li>
                                break;
                            case "LPT":
                                <li>Prioritizes longer operations first</li>
                                <li>Can help balance machine loads</li>
                                break;
                            case "FCFS":
                                <li>Processes jobs in order of index</li>
                                <li>Simple, fair scheduling</li>
                                break;
                            case "MWR":
                                <li>Prioritizes jobs with most remaining work</li>
                                <li>Helps complete long jobs sooner</li>
                                break;
                            case "LWR":
                                <li>Prioritizes jobs with least remaining work</li>
                                <li>Completes more jobs faster</li>
                                break;
                            case "Best":
                                <li>Tries SPT, LPT, MWR, LWR</li>
                                <li>Returns solution with lowest makespan</li>
                                break;
                        }
                    </ul>
                </div>

                @if (!string.IsNullOrEmpty(solverResultMessage))
                {
                    var isSuccess = lastValidationResult?.IsValid ?? solverResultMessage.StartsWith("Solved") || solverResultMessage.StartsWith("Valid") || solverResultMessage.StartsWith("Created");
                    <div style="background: @(isSuccess ? "#dcfce7" : "#fee2e2"); color: @(isSuccess ? "#166534" : "#dc2626"); padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem; white-space: pre-wrap;">
                        @(isSuccess ? "✓" : "⚠️") @solverResultMessage
                    </div>
                }

                @if (lastValidationResult?.Metrics != null)
                {
                    <div style="background: #eff6ff; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                        <strong>Metrics:</strong>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                            <div>Makespan: <strong>@lastValidationResult.Metrics.Makespan min</strong></div>
                            <div>Lower Bound: <strong>@lastValidationResult.Metrics.LowerBound min</strong></div>
                            <div>Utilization: <strong>@($"{lastValidationResult.Metrics.AverageMachineUtilization:F1}%")</strong></div>
                            <div>Idle Time: <strong>@lastValidationResult.Metrics.TotalIdleTime min</strong></div>
                        </div>
                    </div>
                }

                <div class="dialog-actions" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn-secondary" @onclick="CloseSolverDialog">Close</button>
                    <button class="btn-secondary" @onclick="ValidateJobShopSchedule" title="Validate current schedule">
                        ✓ Validate
                    </button>
                    <button class="btn-secondary" @onclick="RunJobShopSolverAsLayer" disabled="@isSolving" title="Create a new layer with the solution">
                        📊 Solve to Layer
                    </button>
                    <button class="btn-primary" @onclick="RunJobShopSolver" disabled="@isSolving">
                        @(isSolving ? "Solving..." : "🚀 Solve & Apply")
                    </button>
                </div>
            </div>
        </div>
    }

    @* Project Solver Dialog *@
    @if (showProjectSolverDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showProjectSolverDialog = false)">
            <div class="dialog-content solver-dialog" @onclick:stopPropagation="true" style="min-width: 700px; max-width: 800px;">
                <h2>🔧 Schedule Optimizer</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">
                    Configure optimization goals and costs, then click Solve to find the optimal schedule.
                </p>

                <div class="solver-columns">
                    @* Goals Column (Hard Constraints) *@
                    <div class="solver-column">
                        <h3 style="color: #059669; margin-bottom: 0.75rem; font-size: 1rem;">✓ Goals (Constraints)</h3>
                        <p style="color: #6b7280; font-size: 0.75rem; margin-bottom: 0.75rem;">Must be satisfied for a valid solution</p>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.GoalMeetMilestones" />
                                <span>Meet milestone dates</span>
                            </label>
                            <span class="solver-hint">Milestones complete on/before target</span>
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.GoalMeetDeadline" />
                                <span>Meet project deadline</span>
                            </label>
                            @if (solverConfig.GoalMeetDeadline)
                            {
                                <input type="date" @bind="solverConfig.DeadlineDate"
                                       style="margin-left: 1.5rem; padding: 0.25rem; font-size: 0.875rem;" />
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.GoalRespectDependencies" />
                                <span>Respect dependencies</span>
                            </label>
                            <span class="solver-hint">Predecessors finish before successors start</span>
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.GoalNoOverallocation" />
                                <span>No resource overallocation</span>
                            </label>
                            <span class="solver-hint">Resources can't work on overlapping tasks</span>
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.GoalFixedTasksLocked" />
                                <span>Fixed tasks locked</span>
                            </label>
                            <span class="solver-hint">Tasks marked fixed cannot move</span>
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.GoalCompletedTasksLocked" />
                                <span>Completed tasks locked</span>
                            </label>
                            <span class="solver-hint">100% complete tasks cannot move</span>
                        </div>
                    </div>

                    @* Costs Column (Soft Objectives) *@
                    <div class="solver-column">
                        <h3 style="color: #dc2626; margin-bottom: 0.75rem; font-size: 1rem;">⚖ Costs (Minimize)</h3>
                        <p style="color: #6b7280; font-size: 0.75rem; margin-bottom: 0.75rem;">Weighted objectives to optimize</p>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizeTotalCost" />
                                <span>Total project cost</span>
                            </label>
                            @if (solverConfig.CostMinimizeTotalCost)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostTotalCostWeight" />
                                    <span>@solverConfig.CostTotalCostWeight</span>
                                </div>
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizeDuration" />
                                <span>Project duration</span>
                            </label>
                            @if (solverConfig.CostMinimizeDuration)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostDurationWeight" />
                                    <span>@solverConfig.CostDurationWeight</span>
                                </div>
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizeResourceConflicts" />
                                <span>Resource conflicts</span>
                            </label>
                            @if (solverConfig.CostMinimizeResourceConflicts)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostResourceConflictsWeight" />
                                    <span>@solverConfig.CostResourceConflictsWeight</span>
                                </div>
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizeMilestoneSlippage" />
                                <span>Milestone slippage</span>
                            </label>
                            @if (solverConfig.CostMinimizeMilestoneSlippage)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostMilestoneSlippageWeight" />
                                    <span>@solverConfig.CostMilestoneSlippageWeight</span>
                                </div>
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizeCriticalPath" />
                                <span>Critical path length</span>
                            </label>
                            @if (solverConfig.CostMinimizeCriticalPath)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostCriticalPathWeight" />
                                    <span>@solverConfig.CostCriticalPathWeight</span>
                                </div>
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizePeakDailyCost" />
                                <span>Peak daily cost</span>
                            </label>
                            @if (solverConfig.CostMinimizePeakDailyCost)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostPeakDailyCostWeight" />
                                    <span>@solverConfig.CostPeakDailyCostWeight</span>
                                </div>
                            }
                        </div>

                        <div class="solver-option">
                            <label>
                                <input type="checkbox" @bind="solverConfig.CostMinimizeIdleTime" />
                                <span>Resource idle time</span>
                            </label>
                            @if (solverConfig.CostMinimizeIdleTime)
                            {
                                <div class="solver-weight">
                                    <input type="range" min="1" max="10" @bind="solverConfig.CostIdleTimeWeight" />
                                    <span>@solverConfig.CostIdleTimeWeight</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                @* Task Compression Section *@
                <div class="solver-compression-section">
                    <div class="solver-compression-header">
                        <label>
                            <input type="checkbox" @bind="solverConfig.AllowTaskCompression" />
                            <span style="font-weight: 600;">Allow task compression</span>
                        </label>
                        @if (solverConfig.AllowTaskCompression)
                        {
                            <div class="solver-compression-options">
                                <label style="font-size: 0.8rem; margin-right: 1rem;">
                                    <input type="radio" name="costModel" checked="@(solverConfig.CompressionCostModel == CompressionCostModel.Linear)"
                                           @onchange="@(() => solverConfig.CompressionCostModel = CompressionCostModel.Linear)" />
                                    Linear (fixed $/day)
                                </label>
                                <label style="font-size: 0.8rem;">
                                    <input type="radio" name="costModel" checked="@(solverConfig.CompressionCostModel == CompressionCostModel.Quadratic)"
                                           @onchange="@(() => solverConfig.CompressionCostModel = CompressionCostModel.Quadratic)" />
                                    Quadratic (diminishing returns)
                                </label>
                            </div>
                        }
                    </div>

                    @if (solverConfig.AllowTaskCompression)
                    {
                        <div class="solver-compression-tasks">
                            <div class="compression-task-header">
                                <span style="flex: 2;">Task</span>
                                <span style="flex: 1; text-align: center;">Min</span>
                                <span style="flex: 1; text-align: center;">Current</span>
                                <span style="flex: 1; text-align: center;">Max</span>
                                <span style="flex: 1; text-align: center;">$/Day</span>
                                <span style="flex: 0.5; text-align: center;">Allow</span>
                            </div>
                            @foreach (var task in GetprojectNodes().Where(n => !n.ProjectIsMilestone && !n.IsSuperNode).Take(10))
                            {
                                <div class="compression-task-row">
                                    <span style="flex: 2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@task.Text">@task.Text</span>
                                    <input type="number" min="1" max="@task.ProjectDurationDays"
                                           value="@task.ProjectMinDuration"
                                           @onchange="@(e => { if (int.TryParse(e.Value?.ToString(), out var v)) task.ProjectMinDuration = Math.Max(1, Math.Min(v, task.ProjectDurationDays)); })"
                                           style="flex: 1; width: 50px; text-align: center; padding: 0.25rem;"
                                           disabled="@(!task.ProjectAllowCompression)" />
                                    <span style="flex: 1; text-align: center; font-weight: 500;">@task.ProjectDurationDays</span>
                                    <input type="number" min="@task.ProjectDurationDays"
                                           value="@(task.ProjectMaxDuration > 0 ? task.ProjectMaxDuration : task.ProjectDurationDays)"
                                           @onchange="@(e => { if (int.TryParse(e.Value?.ToString(), out var v)) task.ProjectMaxDuration = Math.Max(task.ProjectDurationDays, v); })"
                                           style="flex: 1; width: 50px; text-align: center; padding: 0.25rem;"
                                           disabled="@(!task.ProjectAllowCompression)" />
                                    <input type="number" min="0" step="10"
                                           value="@((int)task.ProjectCrashCostPerDay)"
                                           @onchange="@(e => { if (decimal.TryParse(e.Value?.ToString(), out var v)) task.ProjectCrashCostPerDay = v; })"
                                           style="flex: 1; width: 60px; text-align: center; padding: 0.25rem;"
                                           disabled="@(!task.ProjectAllowCompression)" />
                                    <div style="flex: 0.5; text-align: center;">
                                        <input type="checkbox" @bind="task.ProjectAllowCompression" />
                                    </div>
                                </div>
                            }
                            @if (GetprojectNodes().Count(n => !n.ProjectIsMilestone && !n.IsSuperNode) > 10)
                            {
                                <div style="font-size: 0.75rem; color: #6b7280; padding: 0.5rem; text-align: center;">
                                    Showing first 10 tasks. Enable compression on individual tasks in the task info panel.
                                </div>
                            }
                        </div>
                    }
                </div>

                @* Results Panel *@
                @if (solverResult != null)
                {
                    <div class="solver-results @(solverResult.Status == SolverStatus.Optimal || solverResult.Status == SolverStatus.Feasible ? "solver-success" : "solver-error")">
                        <div class="solver-results-header">
                            @switch (solverResult.Status)
                            {
                                case SolverStatus.Optimal:
                                    <span>✅ Optimal solution found (@solverResult.SolveTimeMs ms)</span>
                                    break;
                                case SolverStatus.Feasible:
                                    <span>✓ Feasible solution found (@solverResult.SolveTimeMs ms)</span>
                                    break;
                                case SolverStatus.Infeasible:
                                    <span>❌ No feasible solution</span>
                                    break;
                                case SolverStatus.Timeout:
                                    <span>⏱ Solver timeout</span>
                                    break;
                                case SolverStatus.Error:
                                    <span>⚠ Solver error</span>
                                    break;
                            }
                        </div>
                        <p style="font-size: 0.875rem; margin: 0.5rem 0;">@solverResult.Message</p>

                        @if (solverResult.Violations.Any())
                        {
                            <div style="margin-top: 0.75rem;">
                                <strong style="font-size: 0.875rem;">Constraint violations:</strong>
                                <ul style="margin: 0.25rem 0 0 1.25rem; padding: 0; font-size: 0.8rem;">
                                    @foreach (var violation in solverResult.Violations)
                                    {
                                        <li style="color: @(violation.Severity == ViolationSeverity.Error ? "#dc2626" : "#f59e0b");">
                                            @violation.Description
                                        </li>
                                    }
                                </ul>
                            </div>
                        }

                        @if (solverResult.SuggestedFixes.Any())
                        {
                            <div style="margin-top: 0.75rem; background: #fef3c7; padding: 0.5rem; border-radius: 4px;">
                                <strong style="font-size: 0.875rem;">💡 Suggested fixes:</strong>
                                <ul style="margin: 0.25rem 0 0 1.25rem; padding: 0; font-size: 0.8rem;">
                                    @foreach (var fix in solverResult.SuggestedFixes)
                                    {
                                        <li>@fix</li>
                                    }
                                </ul>
                            </div>
                        }

                        @if (solverResult.BeforeMetrics != null && solverResult.AfterMetrics != null)
                        {
                            <div style="margin-top: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.8rem;">
                                <div>
                                    <strong>Before:</strong>
                                    <div>Cost: $@solverResult.BeforeMetrics.TotalProjectCost.ToString("N0")</div>
                                    <div>Duration: @solverResult.BeforeMetrics.ProjectDurationDays days</div>
                                    <div>Conflicts: @solverResult.BeforeMetrics.ResourceConflictCount</div>
                                </div>
                                <div>
                                    <strong>After:</strong>
                                    <div>Cost: $@solverResult.AfterMetrics.TotalProjectCost.ToString("N0")</div>
                                    <div>Duration: @solverResult.AfterMetrics.ProjectDurationDays days</div>
                                    <div>Conflicts: @solverResult.AfterMetrics.ResourceConflictCount</div>
                                </div>
                            </div>
                        }
                        @if (solverResult.TotalCompressionCost > 0)
                        {
                            <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                                <strong>Compression:</strong> @solverResult.OptimizedDurations.Count tasks compressed,
                                cost $@solverResult.TotalCompressionCost.ToString("N0")
                            </div>
                        }
                    </div>
                }

                <div class="dialog-actions">
                    <button class="btn-secondary" @onclick="@(() => { showProjectSolverDialog = false; solverResult = null; })">Close</button>
                    <button class="btn-primary" @onclick="RunSolver" disabled="@solverRunning">
                        @if (solverRunning)
                        {
                            <span>⏳ Solving...</span>
                        }
                        else
                        {
                            <span>🚀 Solve</span>
                        }
                    </button>
                    @if (solverResult?.Status == SolverStatus.Optimal || solverResult?.Status == SolverStatus.Feasible)
                    {
                        <button class="btn-success" @onclick="ApplySolverResult">✓ Apply Solution</button>
                    }
                </div>
            </div>
        </div>
    }

    @* Template Styles Configuration Dialog *@
    @if (showTemplateStylesDialog)
    {
        <div class="dialog-overlay" @onclick="CloseTemplateStylesDialog">
            <div class="dialog-content" @onclick:stopPropagation="true" style="min-width: 420px; max-width: 480px;">
                <h2>Template Styles</h2>

                @* Template and Component Selector *@
                <div class="panel-row" style="margin-bottom: 1rem;">
                    <select @bind="editingTemplateId" @bind:after="OnEditingTemplateChanged" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; min-width: 100px;">
                        <option value="circuit">Circuit</option>
                        <option value="flowchart">Flowchart</option>
                        <option value="icd">ICD</option>
                        <option value="network">Network</option>
                        <option value="bpmn">BPMN</option>
                        <option value="sts">STS</option>
                    </select>
                    @if (editingTemplateId == "circuit" || editingTemplateId == "sts")
                    {
                        <select @bind="editingShapeId" @bind:after="OnEditingShapeChanged" style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; margin-left: 0.5rem;">
                            <option value="">(Default)</option>
                            @foreach (var shape in GetShapesForTemplate(editingTemplateId))
                            {
                                <option value="@shape.Id">@shape.DisplayName</option>
                            }
                        </select>
                    }
                </div>

                @* Interactive Preview Panel *@
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.8rem; color: #6b7280;">Drag terminals to reposition</span>
                        @if (!string.IsNullOrEmpty(editingShapeId))
                        {
                            <span style="font-size: 0.75rem; color: #3b82f6; font-weight: 500;">@GetShapeDisplayName(editingTemplateId, editingShapeId)</span>
                        }
                    </div>
                    <svg width="200" height="140" viewBox="0 0 200 140"
                         style="display: block; cursor: @(previewDraggingTerminal != null ? "grabbing" : "default"); user-select: none;"
                         @onmousemove="OnPreviewMouseMove" @onmouseup="OnPreviewMouseUp" @onmouseleave="OnPreviewMouseUp">
                        @* Background grid *@
                        <defs>
                            <pattern id="previewGrid" width="10" height="10" patternUnits="userSpaceOnUse">
                                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#e5e7eb" stroke-width="0.5"/>
                            </pattern>
                        </defs>
                        <rect width="200" height="140" fill="url(#previewGrid)" />

                        @* Component shape - rendered by GetPreviewShapeSvg() at (40, 35) with size 120x70 *@
                        @((MarkupString)GetPreviewShapeSvg())

                        @* Input Terminal (T1) - draggable with precise positioning *@
                        @{
                            // Shape is at (40, 35) with size 120x70
                            const double shapeX = 40;
                            const double shapeY = 35;
                            const double shapeW = 120;
                            const double shapeH = 70;
                            // Use normalized coordinates for precise positioning
                            var (inX, inY, inStickX, inStickY) = GetPreviewTerminalCoordsFromNormalized(previewT1X, previewT1Y, shapeW, shapeH);
                            var inAbsX = shapeX + inX;
                            var inAbsY = shapeY + inY;
                            var inTermX = inAbsX + inStickX;
                            var inTermY = inAbsY + inStickY;
                            var inColor = GetPreviewTerminalColor(tplEditInputTerminalType);
                        }
                        <g style="cursor: grab;" @onmousedown="@(() => OnPreviewTerminalMouseDown("input"))" @onmousedown:stopPropagation="true">
                            <line x1="@inAbsX" y1="@inAbsY" x2="@inTermX" y2="@inTermY" stroke="@inColor" stroke-width="3" />
                            <circle cx="@inTermX" cy="@inTermY" r="10" fill="@inColor" stroke="white" stroke-width="2" style="cursor: grab;" />
                            <text x="@inTermX" y="@(inTermY + 4)" text-anchor="middle" font-size="11" fill="white" font-weight="bold" style="pointer-events: none;">1</text>
                        </g>

                        @* Output Terminal (T2) - draggable with precise positioning *@
                        @{
                            var (outX, outY, outStickX, outStickY) = GetPreviewTerminalCoordsFromNormalized(previewT2X, previewT2Y, shapeW, shapeH);
                            var outAbsX = shapeX + outX;
                            var outAbsY = shapeY + outY;
                            var outTermX = outAbsX + outStickX;
                            var outTermY = outAbsY + outStickY;
                            var outColor = GetPreviewTerminalColor(tplEditOutputTerminalType);
                        }
                        <g style="cursor: grab;" @onmousedown="@(() => OnPreviewTerminalMouseDown("output"))" @onmousedown:stopPropagation="true">
                            <line x1="@outAbsX" y1="@outAbsY" x2="@outTermX" y2="@outTermY" stroke="@outColor" stroke-width="3" />
                            <circle cx="@outTermX" cy="@outTermY" r="10" fill="@outColor" stroke="white" stroke-width="2" style="cursor: grab;" />
                            <text x="@outTermX" y="@(outTermY + 4)" text-anchor="middle" font-size="11" fill="white" font-weight="bold" style="pointer-events: none;">2</text>
                        </g>

                        @* Third Terminal (T3) - draggable with precise positioning, if enabled *@
                        @if (tplEditHasThirdTerminal)
                        {
                            var (thirdX, thirdY, thirdStickX, thirdStickY) = GetPreviewTerminalCoordsFromNormalized(previewT3X, previewT3Y, shapeW, shapeH);
                            var thirdAbsX = shapeX + thirdX;
                            var thirdAbsY = shapeY + thirdY;
                            var thirdTermX = thirdAbsX + thirdStickX;
                            var thirdTermY = thirdAbsY + thirdStickY;
                            var thirdColor = GetPreviewTerminalColor(tplEditThirdTerminalType);
                            <g style="cursor: grab;" @onmousedown="@(() => OnPreviewTerminalMouseDown("third"))" @onmousedown:stopPropagation="true">
                                <line x1="@thirdAbsX" y1="@thirdAbsY" x2="@thirdTermX" y2="@thirdTermY" stroke="@thirdColor" stroke-width="3" />
                                <circle cx="@thirdTermX" cy="@thirdTermY" r="10" fill="@thirdColor" stroke="white" stroke-width="2" style="cursor: grab;" />
                                <text x="@thirdTermX" y="@(thirdTermY + 4)" text-anchor="middle" font-size="11" fill="white" font-weight="bold" style="pointer-events: none;">3</text>
                            </g>
                        }

                        @* Drag hint overlay when dragging *@
                        @if (previewDraggingTerminal != null)
                        {
                            <rect x="0" y="0" width="200" height="140" fill="rgba(59, 130, 246, 0.05)" style="pointer-events: none;" />
                            @* Side indicators using circles with arrows *@
                            <circle cx="15" cy="70" r="8" fill="#3b82f6" opacity="0.3" />
                            <circle cx="185" cy="70" r="8" fill="#3b82f6" opacity="0.3" />
                            <circle cx="100" cy="12" r="8" fill="#3b82f6" opacity="0.3" />
                            <circle cx="100" cy="128" r="8" fill="#3b82f6" opacity="0.3" />
                        }
                    </svg>
                </div>

                @* Terminal Types - compact row with G/I/O buttons *@
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.8rem; color: #374151; min-width: 20px;">T1:</span>
                            <div style="display: flex; gap: 2px;">
                                <button class="@(tplEditInputTerminalType == TerminalType.Bidirectional ? "connectivity-btn active" : "connectivity-btn")"
                                        @onclick="() => SetEditingTerminalType(1, TerminalType.Bidirectional)" title="Bidirectional">G</button>
                                <button class="@(tplEditInputTerminalType == TerminalType.Input ? "connectivity-btn active" : "connectivity-btn")"
                                        @onclick="() => SetEditingTerminalType(1, TerminalType.Input)" title="Input">I</button>
                                <button class="@(tplEditInputTerminalType == TerminalType.Output ? "connectivity-btn active" : "connectivity-btn")"
                                        @onclick="() => SetEditingTerminalType(1, TerminalType.Output)" title="Output">O</button>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.8rem; color: #374151; min-width: 20px;">T2:</span>
                            <div style="display: flex; gap: 2px;">
                                <button class="@(tplEditOutputTerminalType == TerminalType.Bidirectional ? "connectivity-btn active" : "connectivity-btn")"
                                        @onclick="() => SetEditingTerminalType(2, TerminalType.Bidirectional)" title="Bidirectional">G</button>
                                <button class="@(tplEditOutputTerminalType == TerminalType.Input ? "connectivity-btn active" : "connectivity-btn")"
                                        @onclick="() => SetEditingTerminalType(2, TerminalType.Input)" title="Input">I</button>
                                <button class="@(tplEditOutputTerminalType == TerminalType.Output ? "connectivity-btn active" : "connectivity-btn")"
                                        @onclick="() => SetEditingTerminalType(2, TerminalType.Output)" title="Output">O</button>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.8rem; color: #374151; min-width: 20px;">T3:</span>
                            <input type="checkbox" checked="@tplEditHasThirdTerminal" @onchange="e => SetEditingHasThirdTerminal((bool)(e.Value ?? false))" style="margin: 0;" />
                            @if (tplEditHasThirdTerminal)
                            {
                                <div style="display: flex; gap: 2px;">
                                    <button class="@(tplEditThirdTerminalType == TerminalType.Bidirectional ? "connectivity-btn active" : "connectivity-btn")"
                                            @onclick="() => SetEditingTerminalType(3, TerminalType.Bidirectional)" title="Bidirectional">G</button>
                                    <button class="@(tplEditThirdTerminalType == TerminalType.Input ? "connectivity-btn active" : "connectivity-btn")"
                                            @onclick="() => SetEditingTerminalType(3, TerminalType.Input)" title="Input">I</button>
                                    <button class="@(tplEditThirdTerminalType == TerminalType.Output ? "connectivity-btn active" : "connectivity-btn")"
                                            @onclick="() => SetEditingTerminalType(3, TerminalType.Output)" title="Output">O</button>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                @* Colors - compact single-line format *@
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; align-items: center;">
                        <span style="font-size: 0.8rem; color: #6b7280;">Fill:</span>
                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                            <input type="color" @bind="tplEditFillColor" style="width: 28px; height: 24px; border: 1px solid #d1d5db; border-radius: 4px; padding: 0; cursor: pointer;" />
                            <input type="text" @bind="tplEditFillColor" style="width: 70px; padding: 0.2rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 0.75rem;" />
                            <span style="font-size: 0.8rem; color: #6b7280; margin-left: 0.5rem;">Stroke:</span>
                            <input type="color" @bind="tplEditStrokeColor" style="width: 28px; height: 24px; border: 1px solid #d1d5db; border-radius: 4px; padding: 0; cursor: pointer;" />
                            <input type="text" @bind="tplEditStrokeColor" style="width: 70px; padding: 0.2rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 0.75rem;" />
                            <input type="number" @bind="tplEditStrokeWidth" min="1" max="5" style="width: 36px; padding: 0.2rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem;" title="Stroke width" />
                        </div>
                        <span style="font-size: 0.8rem; color: #6b7280;">T1:</span>
                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                            <input type="color" @bind="tplEditInputTerminalColor" style="width: 28px; height: 24px; border: 1px solid #d1d5db; border-radius: 4px; padding: 0; cursor: pointer;" />
                            <input type="text" @bind="tplEditInputTerminalColor" style="width: 70px; padding: 0.2rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 0.75rem;" />
                            <span style="font-size: 0.8rem; color: #6b7280; margin-left: 0.5rem;">T2:</span>
                            <input type="color" @bind="tplEditOutputTerminalColor" style="width: 28px; height: 24px; border: 1px solid #d1d5db; border-radius: 4px; padding: 0; cursor: pointer;" />
                            <input type="text" @bind="tplEditOutputTerminalColor" style="width: 70px; padding: 0.2rem 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 0.75rem;" />
                        </div>
                    </div>
                </div>

                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="SaveTemplateStyle">Save</button>
                    <button class="btn-secondary" @onclick="ResetTemplateStyle" style="background: #f59e0b;">Reset</button>
                    <button class="btn-secondary" @onclick="CloseTemplateStylesDialog">Close</button>
                </div>
            </div>
        </div>
    }

    @* Text Edit Dialog - Enhanced with Node Style Options *@
    @if (showTextEditDialog)
    {
        <div class="dialog-overlay" @onclick="CancelTextEdit">
            <div class="dialog-content text-edit-dialog" @onclick:stopPropagation="true" style="min-width: 400px;">
                <h2>@(editingTextNodeId.HasValue ? "Edit Node" : "Edit Label Text")</h2>
                
                @if (editingTextNodeId.HasValue)
                {
                    var editNode = nodes.FirstOrDefault(n => n.Id == editingTextNodeId.Value);
                    @if (editNode != null)
                    {
                        @* Text Section *@
                        <div class="panel-row">
                            <label>Text:</label>
                            <textarea @bind="editingText" 
                                      @bind:event="oninput"
                                      @onkeydown="HandleTextEditKeyDown"
                                      @ref="textEditTextarea"
                                      class="text-edit-textarea"
                                      placeholder="Enter text here..."
                                      rows="3"></textarea>
                        </div>

                        @* Shape Dropdown *@
                        <div class="panel-row">
                            <label>Shape:</label>
                            <select value="@editNode.Shape" @onchange="@(e => { if (Enum.TryParse<NodeShape>(e.Value?.ToString(), out var s)) editNode.Shape = s; StateHasChanged(); })" class="edge-dropdown" style="width:100%;">
                                <option value="@NodeShape.Rectangle">Rectangle</option>
                                <option value="@NodeShape.Ellipse">Ellipse</option>
                                <option value="@NodeShape.Diamond">Diamond</option>
                                <option value="@NodeShape.Parallelogram">Parallelogram</option>
                                <option value="@NodeShape.Cylinder">Cylinder</option>
                            </select>
                        </div>

                        @* Size *@
                        <div class="panel-row">
                            <label>Size:</label>
                            <div class="size-inputs">
                                <span>W:</span>
                                <input type="number" value="@((int)editNode.Width)" 
                                       @onchange="@(e => { editNode.Width = double.Parse(e.Value?.ToString() ?? "120"); RecalculateEdgePaths(editNode.Id); })" 
                                       class="size-input" min="40" />
                                <span>H:</span>
                                <input type="number" value="@((int)editNode.Height)" 
                                       @onchange="@(e => { editNode.Height = double.Parse(e.Value?.ToString() ?? "60"); RecalculateEdgePaths(editNode.Id); })" 
                                       class="size-input" min="30" />
                            </div>
                        </div>

                        @* Fill Color *@
                        <div class="panel-row">
                            <label>Fill Color:</label>
                            <div class="color-picker">
                                @foreach (var color in nodeFillColors)
                                {
                                    <button class="color-swatch @(editNode.FillColor == color ? "selected" : "")"
                                            style="background-color: @color;"
                                            @onclick="@(() => { editNode.FillColor = color; StateHasChanged(); })">
                                    </button>
                                }
                            </div>
                        </div>

                        @* Border Color *@
                        <div class="panel-row">
                            <label>Border Color:</label>
                            <div class="color-picker">
                                @foreach (var color in presetColors)
                                {
                                    <button class="color-swatch @(editNode.StrokeColor == color ? "selected" : "")"
                                            style="background-color: @color;"
                                            @onclick="@(() => { editNode.StrokeColor = color; StateHasChanged(); })">
                                    </button>
                                }
                            </div>
                        </div>

                        @* Border Width *@
                        <div class="panel-row">
                            <label>Border Width:</label>
                            <select value="@(editNode.StrokeWidth ?? 2)" @onchange="@(e => { editNode.StrokeWidth = int.Parse(e.Value?.ToString() ?? "2"); StateHasChanged(); })" class="edge-dropdown" style="width:100%;">
                                <option value="1">1px</option>
                                <option value="2">2px</option>
                                <option value="3">3px</option>
                                <option value="4">4px</option>
                                <option value="5">5px</option>
                            </select>
                        </div>
                    }
                }
                else
                {
                    @* Label-only editing (original behavior) *@
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        Press Enter for new line. Press Escape or click outside to cancel.
                    </p>
                    <textarea @bind="editingText" 
                              @bind:event="oninput"
                              @onkeydown="HandleTextEditKeyDown"
                              @ref="textEditTextarea"
                              class="text-edit-textarea"
                              placeholder="Enter text here..."
                              rows="5"></textarea>
                }
                
                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="SaveTextEdit">💾 Save</button>
                    <button class="btn-secondary" @onclick="CancelTextEdit">Cancel</button>
                </div>
            </div>
        </div>
    }

    @* ===== NODE CONTEXT MENU ===== *@
    @if (showNodeContextMenu)
    {
        <div class="context-menu-overlay" @onclick="HideNodeContextMenu">
            <div class="context-menu" style="left: @(contextMenuX)px; top: @(contextMenuY)px;" @onclick:stopPropagation="true">
                @{
                    var contextNode = nodes.FirstOrDefault(n => n.Id == contextMenuNodeId);
                }
                @if (contextNode != null)
                {
                    @* SuperNode-specific options *@
                    @if (contextNode.IsSuperNode)
                    {
                        @if (contextNode.IsCollapsed)
                        {
                            <div class="context-menu-item" @onclick="ExpandSuperNodeFromContextMenu">
                                <span>⊞ Expand Group</span>
                            </div>
                        }
                        else
                        {
                            <div class="context-menu-item" @onclick="CollapseSuperNodeFromContextMenu">
                                <span>⊟ Collapse Group</span>
                            </div>
                        }
                        <div class="context-menu-item" @onclick="DeleteSuperNodeFromContextMenu">
                            <span>⊠ Ungroup (@contextNode.ContainedNodeIds.Count nodes)</span>
                        </div>
                        <div class="context-menu-separator"></div>
                    }
                    @* Create SuperNode when multiple nodes selected *@
                    @if (selectedNodes.Count >= 2 && !contextNode.IsSuperNode)
                    {
                        <div class="context-menu-item" @onclick="CreateSuperNodeFromContextMenu">
                            <span>⊞ Create Group (@selectedNodes.Count nodes)</span>
                        </div>
                        <div class="context-menu-separator"></div>
                    }
                    @* Collapse back to parent group if this node belongs to an expanded SuperNode *@
                    @if (GetExpandedParentSuperNodeId(contextMenuNodeId) is int expandedParentId)
                    {
                        <div class="context-menu-item" @onclick="() => { CollapseSuperNode(expandedParentId); HideNodeContextMenu(); }">
                            <span>⊟ Collapse Back to Group</span>
                        </div>
                        <div class="context-menu-separator"></div>
                    }
                    <div class="context-menu-item" @onclick="() => ToggleNodeTerminals(contextMenuNodeId)">
                        @if (contextNode.ShowTerminals)
                        {
                            <span>Hide Terminals</span>
                        }
                        else
                        {
                            <span>Show Terminals</span>
                        }
                    </div>
                    @if (contextNode.ShowTerminals)
                    {
                        <div class="context-menu-item" @onclick="() => RotateContextNodeTerminals(true)">
                            <span>Rotate Terminals (Ctrl+R)</span>
                        </div>
                        <div class="context-menu-submenu">
                            <div class="context-menu-item context-menu-has-submenu">
                                <span>Add Input Terminal ▶</span>
                            </div>
                            <div class="context-submenu">
                                <div class="context-menu-item" @onclick="AddExtraInputTerminalLeft">Left</div>
                                <div class="context-menu-item" @onclick="AddExtraInputTerminalRight">Right</div>
                                <div class="context-menu-item" @onclick="AddExtraInputTerminalTop">Top</div>
                                <div class="context-menu-item" @onclick="AddExtraInputTerminalBottom">Bottom</div>
                            </div>
                        </div>
                        <div class="context-menu-submenu">
                            <div class="context-menu-item context-menu-has-submenu">
                                <span>Add Output Terminal ▶</span>
                            </div>
                            <div class="context-submenu">
                                <div class="context-menu-item" @onclick="AddExtraOutputTerminalLeft">Left</div>
                                <div class="context-menu-item" @onclick="AddExtraOutputTerminalRight">Right</div>
                                <div class="context-menu-item" @onclick="AddExtraOutputTerminalTop">Top</div>
                                <div class="context-menu-item" @onclick="AddExtraOutputTerminalBottom">Bottom</div>
                            </div>
                        </div>
                        <div class="context-menu-submenu">
                            <div class="context-menu-item context-menu-has-submenu">
                                <span>Add Bidirectional ▶</span>
                            </div>
                            <div class="context-submenu">
                                <div class="context-menu-item" @onclick="AddBidirectionalTerminalLeft">Left</div>
                                <div class="context-menu-item" @onclick="AddBidirectionalTerminalRight">Right</div>
                                <div class="context-menu-item" @onclick="AddBidirectionalTerminalTop">Top</div>
                                <div class="context-menu-item" @onclick="AddBidirectionalTerminalBottom">Bottom</div>
                            </div>
                        </div>
                        @if (contextNode.ExtraTerminals.Count > 0)
                        {
                            <div class="context-menu-item" @onclick="ClearExtraTerminals">
                                <span>Clear Extra Terminals (@contextNode.ExtraTerminals.Count)</span>
                            </div>
                        }
                    }
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-submenu">
                        <div class="context-menu-item context-menu-has-submenu">
                            <span>Rotate Node ▶</span>
                        </div>
                        <div class="context-submenu">
                            <div class="context-menu-item" @onclick="RotateNodeClockwise">
                                <span>↻ Rotate 90° CW</span>
                            </div>
                            <div class="context-menu-item" @onclick="RotateNodeCounterClockwise">
                                <span>↺ Rotate 90° CCW</span>
                            </div>
                            @if (contextNode.Rotation != 0)
                            {
                                <div class="context-menu-item" @onclick="ResetNodeRotation">
                                    <span>⟲ Reset (@contextNode.Rotation°)</span>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="context-menu-item" @onclick="() => StartEditingNode(contextMenuNodeId)">
                        <span>Edit Text</span>
                    </div>
                    <div class="context-menu-item context-menu-danger" @onclick="() => DeleteContextNode()">
                        <span>Delete</span>
                    </div>
                }
            </div>
        </div>
    }

    @* ===== HELP MODAL ===== *@
    @if (showHelpModal)
    {
        <div class="dialog-overlay" @onclick="CloseHelp">
            <div class="help-modal" @onclick:stopPropagation="true">
                <div class="help-header">
                    <h2>📖 DFD Editor Help</h2>
                    <button class="modal-close-btn" @onclick="CloseHelp">✕</button>
                </div>
                
                <div class="help-body">
                    <nav class="help-nav">
                        @foreach (var section in HelpSections)
                        {
                            <button class="help-nav-btn @(activeHelpSection == section.Key ? "active" : "")"
                                    @onclick="@(() => SetHelpSection(section.Key))">
                                <span>@(section.Value.Icon)</span> @(section.Value.Title)
                            </button>
                        }
                    </nav>
                    
                    <div class="help-content">
                        @if (activeHelpSection == "getting-started")
                        {
                            <h3>🚀 Getting Started</h3>
                            <p>Welcome to the DFD Editor! Create professional diagrams in minutes.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 120" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Step 1: Add Node -->
                                    <rect x="10" y="30" width="80" height="50" rx="4" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="50" y="60" text-anchor="middle" font-size="11" fill="#1e40af">Add Node</text>
                                    <text x="50" y="100" text-anchor="middle" font-size="9" fill="#6b7280">1. Click toolbar</text>
                                    
                                    <!-- Arrow -->
                                    <path d="M100 55 L130 55" stroke="#9ca3af" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    
                                    <!-- Step 2: Click Canvas -->
                                    <rect x="140" y="20" width="100" height="70" rx="4" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4"/>
                                    <rect x="165" y="40" width="50" height="30" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="190" y="60" text-anchor="middle" font-size="10" fill="#1e40af">Node</text>
                                    <text x="190" y="108" text-anchor="middle" font-size="9" fill="#6b7280">2. Click canvas</text>
                                    
                                    <!-- Arrow -->
                                    <path d="M250 55 L280 55" stroke="#9ca3af" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    
                                    <!-- Step 3: Connect -->
                                    <rect x="290" y="35" width="45" height="25" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <circle cx="335" cy="47" r="4" fill="#3b82f6"/>
                                    <path d="M339 47 L371 47" stroke="#3b82f6" stroke-width="2"/>
                                    <circle cx="375" cy="47" r="4" fill="#3b82f6"/>
                                    <rect x="379" y="35" width="45" height="25" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="357" y="108" text-anchor="middle" font-size="9" fill="#6b7280">3. Connect nodes</text>
                                    
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>Quick Start Steps</h4>
                            <ol>
                                <li><b>Add a node:</b> Click "Add Shape" in toolbar, then click on canvas</li>
                                <li><b>Edit text:</b> Double-click any node to edit its label</li>
                                <li><b>Connect nodes:</b> Click connection point (○) on one node, then on another</li>
                                <li><b>Move nodes:</b> Click and drag any node</li>
                                <li><b>Change properties:</b> Select node, use right panel to change shape, color, icon</li>
                            </ol>
                            
                            <div class="help-tip">
                                <b>💡 Tip:</b> Load an example from the <b>Examples</b> menu to see how diagrams are built!
                            </div>
                        }
                        else if (activeHelpSection == "shapes")
                        {
                            <h3>⬡ Shapes & Meanings</h3>
                            <p>Each shape has a specific meaning. Using correct shapes helps viewers understand your diagram instantly.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 520 200" style="width:100%;max-width:520px;height:auto;">
                                    <!-- Rectangle -->
                                    <rect x="10" y="20" width="80" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="50" y="48" text-anchor="middle" font-size="10" fill="#065f46">Entity</text>
                                    <text x="50" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Rectangle</text>
                                    <text x="50" y="95" text-anchor="middle" font-size="8" fill="#6b7280">External entities</text>
                                    <text x="50" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Process steps</text>
                                    
                                    <!-- Ellipse -->
                                    <ellipse cx="155" cy="42" rx="45" ry="25" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="155" y="47" text-anchor="middle" font-size="10" fill="#1e40af">Process</text>
                                    <text x="155" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Ellipse</text>
                                    <text x="155" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Processes (DFD)</text>
                                    <text x="155" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Start/End</text>
                                    
                                    <!-- Diamond -->
                                    <polygon points="260,17 295,42 260,67 225,42" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="260" y="46" text-anchor="middle" font-size="9" fill="#92400e">Yes?</text>
                                    <text x="260" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Diamond</text>
                                    <text x="260" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Decision point</text>
                                    <text x="260" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Yes/No branch</text>
                                    
                                    <!-- Parallelogram -->
                                    <polygon points="330,20 400,20 385,65 315,65" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="357" y="47" text-anchor="middle" font-size="9" fill="#92400e">D1: Data</text>
                                    <text x="357" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Parallelogram</text>
                                    <text x="357" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Data stores</text>
                                    <text x="357" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Input/Output</text>
                                    
                                    <!-- Cylinder -->
                                    <ellipse cx="465" cy="25" rx="35" ry="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <rect x="430" y="25" width="70" height="35" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" stroke-dasharray="0,35,70,35"/>
                                    <ellipse cx="465" cy="60" rx="35" ry="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="465" y="47" text-anchor="middle" font-size="9" fill="#1e40af">DB</text>
                                    <text x="465" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Cylinder</text>
                                    <text x="465" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Databases</text>
                                    <text x="465" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Storage</text>
                                    
                                    <!-- Color Legend -->
                                    <rect x="10" y="130" width="500" height="60" rx="6" fill="#f8fafc" stroke="#e2e8f0"/>
                                    <text x="20" y="150" font-size="10" fill="#374151" font-weight="bold">Color Conventions:</text>
                                    <rect x="20" y="160" width="12" height="12" fill="#3b82f6"/>
                                    <text x="38" y="170" font-size="9" fill="#475569">Blue: Processes, UI</text>
                                    <rect x="130" y="160" width="12" height="12" fill="#059669"/>
                                    <text x="148" y="170" font-size="9" fill="#475569">Green: Users, entities</text>
                                    <rect x="260" y="160" width="12" height="12" fill="#8b5cf6"/>
                                    <text x="278" y="170" font-size="9" fill="#475569">Purple: External APIs</text>
                                    <rect x="380" y="160" width="12" height="12" fill="#f59e0b"/>
                                    <text x="398" y="170" font-size="9" fill="#475569">Amber: Data stores</text>
                                </svg>
                            </div>
                        }
                        else if (activeHelpSection == "connections")
                        {
                            <h3>↗ Connections & Edges</h3>
                            <p>Edges show data flow or control flow between elements.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 160" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Connection points demo -->
                                    <text x="10" y="15" font-size="10" fill="#374151" font-weight="bold">Connection Points (hover to see):</text>
                                    <rect x="60" y="35" width="100" height="50" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="110" y="65" text-anchor="middle" font-size="10" fill="#1e40af">Node</text>
                                    <!-- Connection points -->
                                    <circle cx="110" cy="35" r="5" fill="#3b82f6"/>
                                    <circle cx="160" cy="60" r="5" fill="#3b82f6"/>
                                    <circle cx="110" cy="85" r="5" fill="#3b82f6"/>
                                    <circle cx="60" cy="60" r="5" fill="#3b82f6"/>
                                    <text x="110" y="105" text-anchor="middle" font-size="8" fill="#6b7280">5 points per side</text>
                                    
                                    <!-- Arrow with label -->
                                    <text x="200" y="15" font-size="10" fill="#374151" font-weight="bold">Labeled Edge:</text>
                                    <rect x="200" y="35" width="60" height="35" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="230" y="57" text-anchor="middle" font-size="9" fill="#065f46">User</text>
                                    <path d="M260 52 L320 52" stroke="#374151" stroke-width="2" marker-end="url(#arr2)"/>
                                    <rect x="275" y="40" width="35" height="16" fill="white" stroke="#e2e8f0"/>
                                    <text x="292" y="52" text-anchor="middle" font-size="8" fill="#374151">Order</text>
                                    <rect x="320" y="35" width="60" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="350" y="57" text-anchor="middle" font-size="9" fill="#1e40af">System</text>
                                    
                                    <!-- Line styles -->
                                    <text x="10" y="130" font-size="10" fill="#374151" font-weight="bold">Edge Styles:</text>
                                    <line x1="90" y1="130" x2="150" y2="130" stroke="#374151" stroke-width="2"/>
                                    <text x="120" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Solid</text>
                                    <line x1="180" y1="130" x2="240" y2="130" stroke="#374151" stroke-width="2" stroke-dasharray="8,4"/>
                                    <text x="210" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Dashed</text>
                                    <line x1="270" y1="130" x2="330" y2="130" stroke="#374151" stroke-width="2" stroke-dasharray="2,4"/>
                                    <text x="300" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Dotted</text>
                                    <line x1="360" y1="127" x2="420" y2="127" stroke="#374151" stroke-width="2"/>
                                    <line x1="360" y1="133" x2="420" y2="133" stroke="#374151" stroke-width="2"/>
                                    <text x="390" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Double</text>
                                    
                                    <defs>
                                        <marker id="arr2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <div class="help-warning">
                                <b>⚠️ Important:</b> Always label your edges! Unlabeled arrows leave viewers guessing what data flows between nodes.
                            </div>
                        }
                        else if (activeHelpSection == "icons")
                        {
                            <h3>🎨 Icons Library</h3>
                            <p>Icons make diagrams more intuitive. They automatically match your node's stroke color.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 100" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Icon examples -->
                                    <rect x="10" y="10" width="70" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <circle cx="45" cy="28" r="8" fill="none" stroke="#059669" stroke-width="1.5"/>
                                    <path d="M37 42 L53 42 Q45 35 37 42" fill="none" stroke="#059669" stroke-width="1.5"/>
                                    <text x="45" y="70" text-anchor="middle" font-size="8" fill="#6b7280">user</text>
                                    
                                    <rect x="95" y="10" width="70" height="45" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <circle cx="130" cy="30" r="10" fill="none" stroke="#3b82f6" stroke-width="1.5"/>
                                    <circle cx="130" cy="30" r="3" fill="#3b82f6"/>
                                    <path d="M123 37 L137 23" stroke="#3b82f6" stroke-width="1.5"/>
                                    <text x="130" y="70" text-anchor="middle" font-size="8" fill="#6b7280">gear</text>
                                    
                                    <rect x="180" y="10" width="70" height="45" rx="4" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
                                    <ellipse cx="215" cy="22" rx="12" ry="6" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
                                    <rect x="203" y="22" width="24" height="18" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
                                    <ellipse cx="215" cy="40" rx="12" ry="6" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
                                    <text x="215" y="70" text-anchor="middle" font-size="8" fill="#6b7280">database</text>
                                    
                                    <rect x="265" y="10" width="70" height="45" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <path d="M290 20 L300 20 L300 45 L290 45 Z M302 25 L320 25 L320 40 L302 40 Z" fill="none" stroke="#f59e0b" stroke-width="1.5"/>
                                    <text x="300" y="70" text-anchor="middle" font-size="8" fill="#6b7280">file</text>
                                    
                                    <rect x="350" y="10" width="70" height="45" rx="4" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                                    <rect x="365" y="20" width="40" height="25" rx="2" fill="none" stroke="#dc2626" stroke-width="1.5"/>
                                    <path d="M372 27 L385 35 L398 27" fill="none" stroke="#dc2626" stroke-width="1.5"/>
                                    <text x="385" y="70" text-anchor="middle" font-size="8" fill="#6b7280">email</text>
                                    
                                    <rect x="435" y="10" width="55" height="45" rx="4" fill="#f0fdf4" stroke="#059669" stroke-width="2"/>
                                    <path d="M455 20 L472 35 L455 35 L455 45 L448 45 L448 35 L440 35 Z" fill="none" stroke="#059669" stroke-width="1.5"/>
                                    <text x="462" y="70" text-anchor="middle" font-size="8" fill="#6b7280">cloud</text>
                                </svg>
                            </div>
                            
                            <h4>Available Icon Categories</h4>
                            <table class="help-table">
                                <tr><th>Category</th><th>Icons</th></tr>
                                <tr><td>People</td><td>user, users, user-plus, user-check</td></tr>
                                <tr><td>Technology</td><td>computer, mobile, server, database, cloud</td></tr>
                                <tr><td>Files</td><td>file, file-text, folder, document</td></tr>
                                <tr><td>Actions</td><td>gear, check, error, play, stop, refresh</td></tr>
                                <tr><td>Security</td><td>lock, shield, key</td></tr>
                                <tr><td>Commerce</td><td>cart, credit-card</td></tr>
                            </table>
                        }
                        else if (activeHelpSection == "dfd")
                        {
                            <h3>📊 Data Flow Diagrams (DFD)</h3>
                            <p>DFDs show how data moves through a system. They're excellent for system analysis.</p>
                            
                            <h4>Context Diagram Example</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 180" style="width:100%;max-width:500px;height:auto;">
                                    <!-- External Entity: Customer -->
                                    <rect x="20" y="60" width="80" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="60" y="87" text-anchor="middle" font-size="10" fill="#065f46">Customer</text>
                                    
                                    <!-- Central Process -->
                                    <ellipse cx="250" cy="82" rx="70" ry="40" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="250" y="78" text-anchor="middle" font-size="10" fill="#1e40af">Order</text>
                                    <text x="250" y="92" text-anchor="middle" font-size="10" fill="#1e40af">System</text>
                                    
                                    <!-- External Entity: Supplier -->
                                    <rect x="400" y="20" width="80" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="440" y="47" text-anchor="middle" font-size="10" fill="#065f46">Supplier</text>
                                    
                                    <!-- External Entity: Bank -->
                                    <rect x="400" y="100" width="80" height="45" rx="4" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
                                    <text x="440" y="127" text-anchor="middle" font-size="10" fill="#6b21a8">Bank</text>
                                    
                                    <!-- Data Flows -->
                                    <path d="M100 75 L175 75" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="137" y="68" text-anchor="middle" font-size="8" fill="#374151">Orders</text>
                                    
                                    <path d="M320 60 L395 45" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="355" y="45" text-anchor="middle" font-size="8" fill="#374151">PO</text>
                                    
                                    <path d="M320 100 L395 120" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="355" y="118" text-anchor="middle" font-size="8" fill="#374151">Payment</text>
                                    
                                    <!-- Legend -->
                                    <rect x="10" y="150" width="480" height="25" rx="4" fill="#f8fafc"/>
                                    <rect x="20" y="157" width="30" height="12" rx="2" fill="#dcfce7" stroke="#059669"/>
                                    <text x="58" y="167" font-size="8" fill="#475569">External Entity</text>
                                    <ellipse cx="155" cy="163" rx="20" ry="8" fill="#dbeafe" stroke="#3b82f6"/>
                                    <text x="185" y="167" font-size="8" fill="#475569">Process</text>
                                    <path d="M250 163 L290 163" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="320" y="167" font-size="8" fill="#475569">Data Flow</text>
                                    
                                    <defs>
                                        <marker id="arr3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>DFD Hierarchy</h4>
                            <ul>
                                <li><b>Context Diagram (Level 0):</b> Entire system as ONE process with external entities</li>
                                <li><b>Level 1 DFD:</b> Expand into sub-processes numbered 1.0, 2.0, 3.0...</li>
                                <li><b>Level 2+ DFD:</b> Further detail: 1.1, 1.2, 2.1, 2.2...</li>
                            </ul>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → Context Diagram or Level 0 DFD
                            </div>
                        }
                        else if (activeHelpSection == "flowcharts")
                        {
                            <h3>📋 Flowcharts</h3>
                            <p>Show step-by-step processes with decisions and branches.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 220" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Start -->
                                    <ellipse cx="100" cy="25" rx="35" ry="18" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="100" y="30" text-anchor="middle" font-size="10" fill="#065f46">Start</text>
                                    
                                    <!-- Arrow down -->
                                    <path d="M100 43 L100 60" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    
                                    <!-- Process -->
                                    <rect x="55" y="65" width="90" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="100" y="87" text-anchor="middle" font-size="10" fill="#1e40af">Process Step</text>
                                    
                                    <!-- Arrow down -->
                                    <path d="M100 100 L100 120" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    
                                    <!-- Decision -->
                                    <polygon points="100,125 145,155 100,185 55,155" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="100" y="159" text-anchor="middle" font-size="10" fill="#92400e">Valid?</text>
                                    
                                    <!-- Yes branch -->
                                    <path d="M100 185 L100 205" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    <text x="108" y="198" font-size="8" fill="#059669">Yes</text>
                                    
                                    <!-- End -->
                                    <ellipse cx="100" cy="220" rx="30" ry="15" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                                    <text x="100" y="224" text-anchor="middle" font-size="9" fill="#dc2626">End</text>
                                    
                                    <!-- No branch -->
                                    <path d="M145 155 L200 155" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    <text x="170" y="148" font-size="8" fill="#dc2626">No</text>
                                    
                                    <!-- Error handling -->
                                    <rect x="205" y="140" width="70" height="30" rx="4" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                                    <text x="240" y="159" text-anchor="middle" font-size="9" fill="#dc2626">Show Error</text>
                                    
                                    <!-- Loop back -->
                                    <path d="M240 140 L240 82 L150 82" stroke="#374151" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arr4)"/>
                                    
                                    <!-- Legend on right -->
                                    <rect x="320" y="20" width="170" height="180" rx="6" fill="#f8fafc" stroke="#e2e8f0"/>
                                    <text x="330" y="40" font-size="10" fill="#374151" font-weight="bold">Flowchart Symbols</text>
                                    
                                    <ellipse cx="345" cy="60" rx="15" ry="8" fill="#dcfce7" stroke="#059669" stroke-width="1"/>
                                    <text x="370" y="64" font-size="9" fill="#475569">Start / End</text>
                                    
                                    <rect x="330" y="80" width="30" height="16" rx="2" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
                                    <text x="370" y="92" font-size="9" fill="#475569">Process</text>
                                    
                                    <polygon points="345,105 360,118 345,131 330,118" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
                                    <text x="370" y="122" font-size="9" fill="#475569">Decision</text>
                                    
                                    <polygon points="330,145 365,145 360,165 325,165" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
                                    <text x="370" y="158" font-size="9" fill="#475569">Input/Output</text>
                                    
                                    <path d="M330 180 L360 180" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    <text x="370" y="184" font-size="9" fill="#475569">Flow</text>
                                    
                                    <defs>
                                        <marker id="arr4" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → Login Flow
                            </div>
                        }
                        else if (activeHelpSection == "swimlanes")
                        {
                            <h3>🏊 Swimlane Diagrams</h3>
                            <p>Organize process flows by <b>who performs each step</b> (roles, departments, or systems).</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 520 240" style="width:100%;max-width:520px;height:auto;">
                                    <!-- Lane backgrounds -->
                                    <rect x="80" y="0" width="140" height="240" fill="#eff6ff" stroke="#bfdbfe"/>
                                    <rect x="220" y="0" width="140" height="240" fill="#f0fdf4" stroke="#bbf7d0"/>
                                    <rect x="360" y="0" width="140" height="240" fill="#fef3c7" stroke="#fde68a"/>
                                    
                                    <!-- Lane headers -->
                                    <rect x="80" y="0" width="140" height="30" fill="#3b82f6"/>
                                    <text x="150" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Customer</text>
                                    <rect x="220" y="0" width="140" height="30" fill="#059669"/>
                                    <text x="290" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Sales Team</text>
                                    <rect x="360" y="0" width="140" height="30" fill="#f59e0b"/>
                                    <text x="430" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Warehouse</text>
                                    
                                    <!-- Row labels -->
                                    <text x="40" y="60" text-anchor="middle" font-size="9" fill="#6b7280">Order</text>
                                    <text x="40" y="120" text-anchor="middle" font-size="9" fill="#6b7280">Process</text>
                                    <text x="40" y="180" text-anchor="middle" font-size="9" fill="#6b7280">Fulfill</text>
                                    
                                    <!-- Customer activities -->
                                    <rect x="105" y="45" width="90" height="30" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="150" y="64" text-anchor="middle" font-size="9" fill="#1e40af">Place Order</text>
                                    
                                    <rect x="105" y="165" width="90" height="30" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="150" y="184" text-anchor="middle" font-size="9" fill="#1e40af">Receive</text>
                                    
                                    <!-- Sales activities -->
                                    <rect x="245" y="45" width="90" height="30" rx="4" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="290" y="64" text-anchor="middle" font-size="9" fill="#065f46">Confirm</text>
                                    
                                    <rect x="245" y="105" width="90" height="30" rx="4" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="290" y="124" text-anchor="middle" font-size="9" fill="#065f46">Invoice</text>
                                    
                                    <!-- Warehouse activities -->
                                    <rect x="385" y="105" width="90" height="30" rx="4" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="430" y="124" text-anchor="middle" font-size="9" fill="#92400e">Pick Items</text>
                                    
                                    <rect x="385" y="165" width="90" height="30" rx="4" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="430" y="184" text-anchor="middle" font-size="9" fill="#92400e">Ship</text>
                                    
                                    <!-- Flow arrows -->
                                    <path d="M195 60 L240 60" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M335 60 L335 120 L380 120" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M430 135 L430 160" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M385 180 L200 180" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M290 75 L290 100" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    
                                    <!-- Labels on arrows -->
                                    <rect x="200" y="50" width="35" height="14" fill="white"/>
                                    <text x="217" y="61" text-anchor="middle" font-size="7" fill="#6b7280">Order</text>
                                    <rect x="280" y="170" width="40" height="14" fill="white"/>
                                    <text x="300" y="181" text-anchor="middle" font-size="7" fill="#6b7280">Package</text>
                                    
                                    <!-- Tip box -->
                                    <rect x="10" y="210" width="500" height="25" rx="4" fill="#fef3c7" stroke="#f59e0b"/>
                                    <text x="260" y="227" text-anchor="middle" font-size="9" fill="#92400e">💡 Use COLOR to identify lanes: Blue=Customer, Green=Staff, Amber=Systems</text>
                                    
                                    <defs>
                                        <marker id="arr5" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>How to Create Swimlanes</h4>
                            <ol>
                                <li><b>Plan lanes:</b> Decide actors (2-4 lanes works best)</li>
                                <li><b>Create headers:</b> Add rectangle nodes at top for each lane name</li>
                                <li><b>Color code:</b> Use same color for all nodes in each lane</li>
                                <li><b>Align vertically:</b> Keep each actor's tasks in their column</li>
                                <li><b>Label handoffs:</b> Name what passes between lanes</li>
                            </ol>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → E-Commerce Flow
                            </div>
                        }
                        else if (activeHelpSection == "architecture")
                        {
                            <h3>🏗 Architecture Diagrams</h3>
                            <p>Show the structure and components of software systems.</p>
                            
                            <h4>3-Tier Architecture</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 200" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Presentation Layer -->
                                    <rect x="10" y="10" width="480" height="50" rx="6" fill="#eff6ff" stroke="#bfdbfe"/>
                                    <text x="20" y="28" font-size="9" fill="#1e40af" font-weight="bold">PRESENTATION LAYER</text>
                                    <rect x="80" y="25" width="80" height="28" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="120" y="43" text-anchor="middle" font-size="9" fill="#1e40af">🖥 Web</text>
                                    <rect x="210" y="25" width="80" height="28" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="250" y="43" text-anchor="middle" font-size="9" fill="#1e40af">📱 Mobile</text>
                                    <rect x="340" y="25" width="80" height="28" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="380" y="43" text-anchor="middle" font-size="9" fill="#1e40af">🔌 API</text>
                                    
                                    <!-- Arrows -->
                                    <path d="M250 60 L250 75" stroke="#374151" stroke-width="2" marker-end="url(#arr6)"/>
                                    
                                    <!-- Business Layer -->
                                    <rect x="10" y="80" width="480" height="50" rx="6" fill="#f0fdf4" stroke="#bbf7d0"/>
                                    <text x="20" y="98" font-size="9" fill="#065f46" font-weight="bold">BUSINESS LOGIC LAYER</text>
                                    <ellipse cx="120" cy="110" rx="45" ry="16" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="120" y="114" text-anchor="middle" font-size="9" fill="#065f46">⚙ Auth</text>
                                    <ellipse cx="250" cy="110" rx="45" ry="16" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="250" y="114" text-anchor="middle" font-size="9" fill="#065f46">⚙ Orders</text>
                                    <ellipse cx="380" cy="110" rx="45" ry="16" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="380" y="114" text-anchor="middle" font-size="9" fill="#065f46">⚙ Users</text>
                                    
                                    <!-- Arrows -->
                                    <path d="M250 130 L250 145" stroke="#374151" stroke-width="2" marker-end="url(#arr6)"/>
                                    
                                    <!-- Data Layer -->
                                    <rect x="10" y="150" width="480" height="45" rx="6" fill="#fef3c7" stroke="#fde68a"/>
                                    <text x="20" y="168" font-size="9" fill="#92400e" font-weight="bold">DATA LAYER</text>
                                    
                                    <!-- Database cylinders -->
                                    <ellipse cx="150" cy="165" rx="30" ry="6" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <path d="M120 165 L120 182 Q150 195 180 182 L180 165" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <ellipse cx="150" cy="182" rx="30" ry="6" fill="none" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="150" y="200" text-anchor="middle" font-size="8" fill="#92400e">Users DB</text>
                                    
                                    <ellipse cx="350" cy="165" rx="30" ry="6" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <path d="M320 165 L320 182 Q350 195 380 182 L380 165" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <ellipse cx="350" cy="182" rx="30" ry="6" fill="none" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="350" y="200" text-anchor="middle" font-size="8" fill="#92400e">Orders DB</text>
                                    
                                    <defs>
                                        <marker id="arr6" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>Common Patterns</h4>
                            <ul>
                                <li><b>3-Tier:</b> Presentation → Business Logic → Data</li>
                                <li><b>Microservices:</b> API Gateway → Independent Services → Databases</li>
                                <li><b>ETL Pipeline:</b> Sources → Extract → Transform → Load → Destinations</li>
                            </ul>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → Software Architecture or ETL Pipeline
                            </div>
                        }
                        else if (activeHelpSection == "keyboard")
                        {
                            <h3>⌨ Keyboard Shortcuts</h3>
                            <table class="help-table">
                                <tr><th>Shortcut</th><th>Action</th></tr>
                                <tr><td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td><td>Undo last action</td></tr>
                                <tr><td><kbd>Ctrl</kbd> + <kbd>Y</kbd></td><td>Redo</td></tr>
                                <tr><td><kbd>Delete</kbd></td><td>Delete selected items</td></tr>
                                <tr><td><kbd>Escape</kbd></td><td>Cancel operation / Deselect all</td></tr>
                                <tr><td><kbd>Scroll wheel</kbd></td><td>Zoom in/out</td></tr>
                                <tr><td><kbd>Shift</kbd> + <kbd>Click</kbd></td><td>Add to selection</td></tr>
                                <tr><td><kbd>Double-click</kbd></td><td>Edit node text</td></tr>
                                <tr><td><kbd>Drag on canvas</kbd></td><td>Selection box</td></tr>
                            </table>
                        }
                        else if (activeHelpSection == "export")
                        {
                            <h3>💾 Export Options</h3>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 400 80" style="width:100%;max-width:400px;height:auto;">
                                    <rect x="10" y="10" width="110" height="60" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="65" y="35" text-anchor="middle" font-size="14" fill="#1e40af" font-weight="bold">PNG</text>
                                    <text x="65" y="52" text-anchor="middle" font-size="8" fill="#3b82f6">Images, docs</text>
                                    
                                    <rect x="140" y="10" width="110" height="60" rx="8" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="195" y="35" text-anchor="middle" font-size="14" fill="#065f46" font-weight="bold">SVG</text>
                                    <text x="195" y="52" text-anchor="middle" font-size="8" fill="#059669">Print, scalable</text>
                                    
                                    <rect x="270" y="10" width="110" height="60" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="325" y="35" text-anchor="middle" font-size="14" fill="#92400e" font-weight="bold">JSON</text>
                                    <text x="325" y="52" text-anchor="middle" font-size="8" fill="#f59e0b">Backup, share</text>
                                </svg>
                            </div>
                            
                            <table class="help-table">
                                <tr><th>Format</th><th>Best For</th></tr>
                                <tr><td><b>PNG</b></td><td>Word docs, PowerPoint, web pages. Use 2x scale for retina displays.</td></tr>
                                <tr><td><b>SVG</b></td><td>Print materials, infinite zoom, professional documents.</td></tr>
                                <tr><td><b>JSON</b></td><td>Save your work! Can be reimported to continue editing.</td></tr>
                            </table>
                            
                            <div class="help-warning">
                                <b>💡 Always save JSON</b> as backup before major changes! Use Export PDF to print.
                            </div>
                        }
                        else if (activeHelpSection == "tips")
                        {
                            <h3>💡 Tips & Best Practices</h3>
                            
                            <h4>✅ Do This</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 240 100" style="width:100%;max-width:240px;height:auto;">
                                    <rect x="10" y="10" width="220" height="80" rx="6" fill="#f0fdf4" stroke="#059669"/>
                                    <!-- Aligned nodes -->
                                    <rect x="25" y="25" width="50" height="25" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <rect x="95" y="25" width="50" height="25" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <rect x="165" y="25" width="50" height="25" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <path d="M75 37 L95 37" stroke="#374151" stroke-width="1" marker-end="url(#arr7)"/>
                                    <path d="M145 37 L165 37" stroke="#374151" stroke-width="1" marker-end="url(#arr7)"/>
                                    <text x="120" y="75" text-anchor="middle" font-size="9" fill="#065f46">Aligned, consistent, labeled</text>
                                    <defs>
                                        <marker id="arr7" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                                            <polygon points="0 0, 8 3, 0 6" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            <ul>
                                <li>Align nodes in rows/columns</li>
                                <li>Use consistent sizing for similar elements</li>
                                <li>Label ALL edges with data names</li>
                                <li>Stick to 3-4 colors with meaning</li>
                                <li>Leave white space between elements</li>
                            </ul>
                            
                            <h4>❌ Avoid This</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 240 100" style="width:100%;max-width:240px;height:auto;">
                                    <rect x="10" y="10" width="220" height="80" rx="6" fill="#fef2f2" stroke="#dc2626"/>
                                    <!-- Misaligned nodes -->
                                    <rect x="20" y="20" width="40" height="20" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <rect x="100" y="35" width="60" height="35" rx="3" fill="white" stroke="#f59e0b" stroke-width="1.5"/>
                                    <rect x="180" y="15" width="35" height="25" rx="3" fill="white" stroke="#dc2626" stroke-width="1.5"/>
                                    <path d="M60 30 L100 52" stroke="#374151" stroke-width="1"/>
                                    <path d="M160 52 L180 27" stroke="#374151" stroke-width="1"/>
                                    <text x="120" y="80" text-anchor="middle" font-size="9" fill="#dc2626">Messy, unlabeled, inconsistent</text>
                                </svg>
                            </div>
                            <ul>
                                <li>❌ Unlabeled arrows</li>
                                <li>❌ Crossing lines everywhere</li>
                                <li>❌ Random sizes and positions</li>
                                <li>❌ Too many colors without meaning</li>
                            </ul>
                            
                            <h4>Pro Tips</h4>
                            <ul>
                                <li>🎯 Start with an Example and modify it</li>
                                <li>🔄 Use Undo freely - experiment!</li>
                                <li>📍 Use the minimap for large diagrams</li>
                                <li>💾 Save JSON backup before big changes</li>
                            </ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* ===== EXAMPLE GENERATOR MODAL (Ctrl+Shift+E) ===== *@
    @if (showExampleGenerator)
    {
        <div class="dialog-overlay" @onclick="CloseExampleGenerator">
            <div class="example-generator-modal" @onclick:stopPropagation="true">
                <div class="help-header">
                    <h2>🔧 Example Generator</h2>
                    <button class="modal-close-btn" @onclick="CloseExampleGenerator">✕</button>
                </div>
                
                @if (!examplePasswordVerified)
                {
                    <div class="password-section">
                        <p>Enter password to access example generator:</p>
                        <input type="password" 
                               @bind="examplePassword" 
                               @bind:event="oninput"
                               @onkeypress="@(e => { if (e.Key == "Enter") VerifyExamplePassword(); })"
                               placeholder="Password" />
                        <button class="btn-primary" @onclick="VerifyExamplePassword">Unlock</button>
                    </div>
                }
                else
                {
                    <div class="generator-content">
                        <div class="example-meta">
                            <div class="form-row">
                                <label>Key (lowercase, no spaces):</label>
                                <input type="text" @bind="newExampleKey" @bind:event="oninput" placeholder="myexample" />
                            </div>
                            <div class="form-row">
                                <label>Display Name:</label>
                                <input type="text" @bind="newExampleName" @bind:event="oninput" placeholder="My Example" />
                            </div>
                            <div class="form-row">
                                <label>Description:</label>
                                <input type="text" @bind="newExampleDescription" @bind:event="oninput" placeholder="What this example shows" />
                            </div>
                            <button class="btn-primary" @onclick="GenerateExampleCode">🔄 Regenerate Code</button>
                        </div>
                        
                        <div class="code-section">
                            <div class="code-header">
                                <span>Generated C# Code</span>
                                <button class="btn-copy" @onclick="CopyGeneratedCode">📋 Copy</button>
                            </div>
                            <pre class="code-output">@generatedExampleCode</pre>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .dfd-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f9fafb;
    }

    .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .side-panel {
        width: 220px;
        min-width: 220px;
        background: white;
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        position: relative;
        transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease;
    }

    .side-panel.collapsed {
        width: 32px;
        min-width: 32px;
        padding: 0.75rem 4px;
        overflow: hidden;
    }

    .panel-collapse-toggle {
        position: absolute;
        top: 8px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #6b7280;
        z-index: 10;
        transition: background 0.2s;
    }

    .panel-collapse-toggle:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .side-panel.collapsed .panel-collapse-toggle {
        position: static;
        margin: 0 auto;
    }

    .right-panel .panel-collapse-toggle {
        right: auto;
        left: 4px;
    }

    .side-panel h3 {
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        margin: 0.5rem 0 0.5rem 0;
        padding-bottom: 0.35rem;
        border-bottom: 1px solid #e5e7eb;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .side-panel h3:first-child {
        margin-top: 0;
    }

    .side-panel .property-group {
        margin-bottom: 0.5rem;
    }

    .side-panel .property-group label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 0.3rem;
    }

    .side-panel .property-row,
    .side-panel .stat-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
    }

    .side-panel .property-row span:first-child,
    .side-panel .stat-row span:first-child {
        color: #6b7280;
    }

    .side-panel .property-row input {
        width: 70px;
        padding: 0.25rem 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        text-align: right;
    }

    .side-panel .panel-info {
        font-size: 0.9rem;
        color: #374151;
        margin: 0.5rem 0;
    }

    .side-panel .panel-hint {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
        margin: 0.25rem 0;
    }

    .side-panel .panel-select {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        background: white;
        margin-bottom: 0.5rem;
    }

    .side-panel .panel-select-small {
        flex: 1;
        padding: 0.3rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        background: white;
    }

    .side-panel .panel-color-picker {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
    }

    .side-panel .color-swatch-small {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .side-panel .color-swatch-small:hover {
        transform: scale(1.1);
    }

    .side-panel .color-swatch-small.selected {
        border-color: #1f2937;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #3b82f6;
    }

    .side-panel .panel-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #374151;
        cursor: pointer;
    }

    .side-panel .panel-checkbox input {
        width: 16px;
        height: 16px;
    }

    .side-panel .panel-btn {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        background: #f9fafb;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 0.25rem;
    }

    .side-panel .panel-btn:hover {
        background: #f3f4f6;
    }

    .side-panel .panel-btn-primary {
        width: 100%;
        padding: 0.5rem;
        border: none;
        border-radius: 0.25rem;
        background: #3b82f6;
        color: white;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        margin-top: 0.5rem;
    }

    .side-panel .panel-btn-primary:hover {
        background: #2563eb;
    }

    .left-panel {
        border-right: 1px solid #e5e7eb;
    }

    .right-panel {
        border-left: 1px solid #e5e7eb;
    }
    .minimap-container {
        width: 100%;
        height: 150px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .minimap {
        width: 100%;
        height: 100%;
    }

    .property-textarea {
        width: 100%;
        min-height: 60px;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-family: Arial, sans-serif;
        font-size: 0.85rem;
        resize: vertical;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }

        .property-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

    .property-row {
        font-size: 0.8rem;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .btn-small {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border: none;
        border-radius: 0.25rem;
        background: #3b82f6;
        color: white;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 0.5rem;
    }

        .btn-small:hover {
            background: #2563eb;
        }

    .toolbar {
        display: flex;
        align-items: center;
        gap: 2rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .toolbar h1 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin: 0;
        }

    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .zoom-controls button {
        width: 28px;
        height: 28px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zoom-controls button:hover:not(:disabled) {
        background: #e5e7eb;
    }

    .zoom-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .zoom-level {
        min-width: 45px;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .zoom-slider {
        width: 80px;
        height: 6px;
        cursor: pointer;
        accent-color: #3b82f6;
    }

    .zoom-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
    }

    .zoom-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        border: none;
    }

    .toolbar-buttons {
        display: flex;
        gap: 0.5rem;
    }

        .toolbar-buttons button {
            padding: 0.35rem 0.7rem;
            border: none;
            border-radius: 0.375rem;
            background: #e5e7eb;
            color: #374151;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }

            .toolbar-buttons button:hover {
                background: #d1d5db;
            }

            .toolbar-buttons button.active {
                background: #3b82f6;
                color: white;
            }

    /* Toolbar Dropdown Menus */
    .toolbar-dropdown {
        position: relative;
        display: inline-block;
    }

    .toolbar-dropdown .dropdown-trigger {
        padding: 0.35rem 0.7rem;
        border: none;
        border-radius: 0.375rem;
        background: #e5e7eb;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .toolbar-dropdown .dropdown-trigger:hover {
        background: #d1d5db;
    }

    .toolbar-dropdown .dropdown-trigger.active {
        background: #3b82f6;
        color: white;
    }

    .toolbar-dropdown .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 180px;
        z-index: 1000;
        padding: 0.25rem 0;
        margin-top: 0.25rem;
    }

    .toolbar-dropdown:hover .dropdown-menu,
    .toolbar-dropdown:focus-within .dropdown-menu {
        display: block;
    }

    .toolbar-dropdown .dropdown-menu button {
        display: block;
        width: 100%;
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: #374151;
        text-align: left;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .toolbar-dropdown .dropdown-menu button:hover {
        background: #f3f4f6;
    }

    .toolbar-dropdown .dropdown-menu button.active {
        background: #eff6ff;
        color: #3b82f6;
    }

    .toolbar-dropdown .dropdown-menu button.btn-danger {
        color: #dc2626;
    }

    .toolbar-dropdown .dropdown-menu button.btn-danger:hover {
        background: #fef2f2;
    }

    .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 0.25rem 0;
    }

    .dropdown-submenu {
        padding: 0.5rem 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .dropdown-submenu .submenu-label {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
        margin-top: 0.5rem;
    }

    .dropdown-submenu .submenu-label:first-child {
        margin-top: 0;
    }

    .dropdown-select {
        width: 100%;
        padding: 0.35rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.85rem;
    }

    .dropdown-menu-wide {
        min-width: 280px;
    }

    .dropdown-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }

    .dropdown-row .submenu-label {
        font-size: 0.75rem;
        color: #6b7280;
        min-width: 70px;
    }

    .dropdown-row button {
        padding: 0.35rem 0.5rem !important;
        min-width: auto !important;
        width: auto !important;
        font-size: 0.8rem !important;
    }

    .dropdown-menu-right {
        left: auto;
        right: 0;
    }

    .toolbar-right {
        margin-left: auto;
    }

    /* Mode Indicator */
    .mode-indicator {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: #3b82f6;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 2rem;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 100;
    }

    .multi-connect-indicator {
        background: #8b5cf6;
    }

    .chain-indicator {
        background: #3b82f6;
    }

    .shape-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

        .shape-selector label {
            font-weight: 500;
            color: #374151;
        }

    .shape-dropdown, .array-dropdown, .background-dropdown {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .background-dropdown-narrow {
        max-width: 180px;
    }

    .background-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

        .background-selector label {
            font-weight: 500;
            color: #374151;
        }

    .btn-config {
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 0.375rem;
        background: #3b82f6;
        color: white;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
    }

        .btn-config:hover {
            background: #2563eb;
        }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: #f9fafb;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .btn-icon:hover {
            background: #e5e7eb;
            color: #374151;
            border-color: #9ca3af;
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

    .array-controls {
        display: flex;
        gap: 0.5rem;
        padding-left: 0.5rem;
        border-left: 1px solid #d1d5db;
    }

    .align-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 0.75rem;
        border-left: 2px solid #3b82f6;
        margin-left: 0.5rem;
    }

    .align-label {
        font-weight: 600;
        color: #3b82f6;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .align-group {
        display: flex;
        gap: 2px;
        background: #f3f4f6;
        padding: 2px;
        border-radius: 0.375rem;
    }

    .align-group button {
        padding: 0.4rem;
        border: none;
        border-radius: 0.25rem;
        background: transparent;
        color: #4b5563;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .align-group button:hover {
        background: #e5e7eb;
        color: #1f2937;
    }

    .align-group button:active {
        background: #3b82f6;
        color: white;
    }

    .align-group button svg {
        width: 16px;
        height: 16px;
    }

    .toolbar-actions {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
    }

    .btn-undo, .btn-save, .btn-load, .btn-help, .btn-delete, .btn-export, .btn-clear {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        color: white;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-undo {
        background: #8b5cf6;
    }

        .btn-undo:hover:not(:disabled) {
            background: #7c3aed;
        }

    .btn-save {
        background: #0ea5e9;
    }

        .btn-save:hover {
            background: #0284c7;
        }

    .btn-load {
        background: #f59e0b;
    }

        .btn-load:hover {
            background: #d97706;
        }

    .btn-help {
        background: #06b6d4;
    }

        .btn-help:hover {
            background: #0891b2;
        }

    .btn-delete {
        background: #ef4444;
    }

        .btn-delete:hover:not(:disabled) {
            background: #dc2626;
        }

    .btn-export {
        background: #10b981;
    }

        .btn-export:hover {
            background: #059669;
        }

    .btn-clear {
        background: #f97316;
    }

        .btn-clear:hover {
            background: #ea580c;
        }

    .btn-undo:disabled, .btn-delete:disabled {
        background: #d1d5db;
        cursor: not-allowed;
    }

    .instructions {
        background: #eff6ff;
        border-bottom: 1px solid #bfdbfe;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #1e40af;
    }

    .canvas {
        flex: 1;
        position: relative;
        overflow: auto;
        background: white;
        cursor: crosshair;
        min-height: 500px;
        width: 100%;
        height: calc(100vh - 200px);
    }

        .canvas.grid-background {
            background-image: linear-gradient(rgba(156, 163, 175, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(156, 163, 175, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
        }

    .svg-layer {
        position: absolute;
        inset: 0;
        width: 4000px;
        height: 4000px;
        pointer-events: none;
    }

        .svg-layer > * {
            pointer-events: auto;
        }

    .text-editor {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 100;
    }

    .edge-label {
        background: white;
        position: absolute;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

        .edge-label:hover {
            border-color: #93c5fd;
        }

        .edge-label.selected {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: #3b82f6;
        cursor: se-resize;
        border-radius: 0 0 0.375rem 0;
    }

        .resize-handle:hover {
            background: #2563eb;
        }

    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    /* Context Menu Styles */
    .context-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1100;
    }

    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 180px;
        padding: 4px 0;
        z-index: 1101;
    }

    .context-menu-item {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.875rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .context-menu-item:hover {
        background: #f3f4f6;
    }

    .context-menu-item.context-menu-danger {
        color: #dc2626;
    }

    .context-menu-item.context-menu-danger:hover {
        background: #fef2f2;
    }

    .context-menu-separator {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
    }

    .context-menu-submenu {
        position: relative;
    }

    .context-menu-has-submenu::after {
        content: none; /* Arrow is in the text */
    }

    .context-submenu {
        display: none;
        position: absolute;
        left: 100%;
        top: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 100px;
        padding: 4px 0;
        z-index: 1102;
    }

    .context-menu-submenu:hover .context-submenu {
        display: block;
    }

    .dialog-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 600px;
        max-height: 80vh;
        overflow: auto;
    }

        .dialog-content.help-dialog {
            max-width: 700px;
            max-height: 85vh;
        }

        .dialog-content h2 {
            margin-top: 0;
            color: #1f2937;
        }

        .dialog-content h3 {
            color: #3b82f6;
            margin-top: 1.5rem;
        }

        .dialog-content ul {
            line-height: 1.8;
        }

    .dialog-textarea {
        width: 100%;
        height: 300px;
        font-family: monospace;
        font-size: 12px;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 0.375rem;
    }

    .text-edit-dialog {
        min-width: 400px;
        max-width: 500px;
    }

    .text-edit-textarea {
        width: 100%;
        min-height: 120px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        padding: 0.75rem;
        border: 2px solid #3b82f6;
        border-radius: 0.375rem;
        resize: vertical;
        line-height: 1.5;
    }

        .text-edit-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

    .dialog-actions, .dialog-buttons {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn-primary {
        padding: 0.5rem 1rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-primary:hover {
            background: #2563eb;
        }

    .btn-secondary, .btn-close, .btn-cancel {
        padding: 0.5rem 1rem;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-secondary:hover, .btn-close:hover, .btn-cancel:hover {
            background: #4b5563;
        }

    .btn-apply {
        padding: 0.5rem 1rem;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-apply:hover {
            background: #059669;
        }

    .btn-apply-all {
        padding: 0.5rem 1rem;
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-apply-all:hover {
            background: #d97706;
        }

    .error-message {
        color: #ef4444;
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    .edge-style-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 1rem;
        border-left: 2px solid #e5e7eb;
    }

        .edge-style-section label {
            font-weight: 500;
            color: #374151;
        }

    .edge-dropdown {
        padding: 0.4rem 0.6rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .color-picker {
        display: flex;
        gap: 0.25rem;
        padding: 0.25rem;
        background: #f9fafb;
        border-radius: 0.375rem;
    }

    .color-swatch {
        width: 24px;
        height: 24px;
        border: 2px solid #d1d5db;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .color-swatch:hover {
            border-color: #9ca3af;
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #3b82f6;
            border-width: 3px;
            transform: scale(1.15);
        }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
    }

    .apply-button {
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        background: #10b981;
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
        width: 100%;
        transition: all 0.2s;
    }

        .apply-button:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .apply-button:active {
            transform: translateY(0);
        }

    .edge-style-section button {
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 0.375rem;
        background: #e5e7eb;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
    }

        .edge-style-section button:hover:not(:disabled) {
            background: #d1d5db;
        }

        .edge-style-section button.active {
            background: #3b82f6;
            color: white;
        }

        .edge-style-section button:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

    /* Edge Style Panel */
    .edge-style-panel {
        position: fixed;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 100;
        min-width: 300px;
    }

        .edge-style-panel h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

    .panel-row {
        margin-bottom: 1rem;
    }

        .panel-row label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

    .panel-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

        .panel-buttons button {
            width: 100%;
        }

    .connector-preview {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 8px;
        margin: 8px 0 12px 0;
    }

    .connector-preview svg {
        display: block;
    }

    /* Size inputs for dialogs */
    .size-inputs {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

        .size-inputs span {
            color: #6b7280;
            font-size: 0.875rem;
        }

    .size-input {
        width: 70px;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    /* Config sections */
    .config-section {
        margin-bottom: 1.5rem;
    }

        .config-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

    .config-dropdown {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151;
        cursor: pointer;
    }

    .label-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
    }

    .selected-edge {
        stroke: #3b82f6 !important;
        stroke-width: 4 !important;
        filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.9));
    }
    .icon-picker-section {
        margin-top: 12px;
    }

    .icon-picker-section > label {
        display: block;
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .icon-picker {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 180px;
        overflow-y: auto;
        padding: 6px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }

    .icon-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        padding: 0;
    }

    .icon-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: scale(1.05);
    }

    .icon-btn.selected {
        background: #eff6ff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .examples-dropdown {
        position: relative;
        display: inline-block;
    }

    .examples-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 200px;
        padding: 4px;
    }

    .examples-menu button {
        display: block;
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
    }

    .examples-menu button:hover {
        background: #f3f4f6;
    }

    /* ===== HELP MODAL STYLES ===== */
    .help-modal {
        background: white;
        border-radius: 12px;
        width: 900px;
        max-width: 95vw;
        height: 75vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .help-header {
        padding: 16px 24px;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 12px 12px 0 0;
    }

    .help-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .modal-close-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
    }

    .modal-close-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .help-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .help-nav {
        width: 200px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        padding: 12px;
        overflow-y: auto;
    }

    .help-nav-btn {
        display: block;
        width: 100%;
        padding: 10px 12px;
        border: none;
        background: transparent;
        text-align: left;
        cursor: pointer;
        border-radius: 6px;
        font-size: 13px;
        color: #475569;
        margin-bottom: 4px;
    }

    .help-nav-btn:hover {
        background: #e2e8f0;
    }

    .help-nav-btn.active {
        background: #3b82f6;
        color: white;
    }

    .help-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        line-height: 1.6;
    }

    .help-content h3 {
        margin: 0 0 16px 0;
        color: #1e40af;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 8px;
    }

    .help-content h4 {
        margin: 20px 0 10px 0;
        color: #334155;
    }

    .help-content p {
        margin: 0 0 12px 0;
        color: #475569;
    }

    .help-content ul, .help-content ol {
        margin: 0 0 16px 0;
        padding-left: 24px;
        color: #475569;
    }

    .help-content li {
        margin-bottom: 6px;
    }

    .help-table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 13px;
    }

    .help-table th, .help-table td {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        text-align: left;
    }

    .help-table th {
        background: #f1f5f9;
        font-weight: 600;
    }

    .help-content kbd {
        background: #1e293b;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
    }

    .help-illustration {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        display: flex;
        justify-content: center;
    }

    .help-illustration svg {
        max-width: 100%;
        height: auto;
    }

    .help-tip {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-left: 4px solid #059669;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 16px 0;
        color: #065f46;
    }

    .help-warning {
        background: #fef3c7;
        border: 1px solid #fde68a;
        border-left: 4px solid #f59e0b;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 16px 0;
        color: #92400e;
    }

    /* ===== EXAMPLE GENERATOR STYLES ===== */
    .example-generator-modal {
        background: white;
        border-radius: 12px;
        width: 800px;
        max-width: 90vw;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .password-section {
        padding: 40px;
        text-align: center;
    }

    .password-section input {
        padding: 10px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        width: 200px;
        margin-right: 10px;
    }

    .password-section input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .generator-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .example-meta {
        background: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
    }

    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .form-row label {
        width: 200px;
        font-weight: 500;
        color: #475569;
    }

    .form-row input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-row input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .code-section {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

    .code-header {
        background: #1e293b;
        color: white;
        padding: 10px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
    }

    .btn-copy {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .btn-copy:hover {
        background: #2563eb;
    }

    .code-output {
        background: #0f172a;
        color: #e2e8f0;
        padding: 16px;
        margin: 0;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 12px;
        line-height: 1.5;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre;
    }

    .example-meta .btn-primary {
        margin-top: 10px;
    }

    /* Layout Dropdown Section Headers */
    .dropdown-section-header {
        padding: 6px 12px 4px;
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    /* Layout Processing Overlay */
    .layout-processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .layout-processing-modal {
        background: white;
        padding: 24px 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 16px;
        font-weight: 500;
        color: #374151;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Collapsible Panel Sections */
    .panel-section {
        margin-bottom: 0.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .section-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: background 0.2s;
    }

    .section-header:hover {
        background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
    }

    .section-header span:first-child {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .collapse-icon {
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s;
    }

    .section-content {
        padding: 10px;
        background: white;
        border-top: 1px solid #e5e7eb;
    }

    /* Hide h3 within collapsible sections since we now use section-header */
    .panel-section h3 {
        display: none;
    }
</style>

<script>
    // High-Quality PDF Export via Print Dialog with optional area selection
    window.downloadPDFViaPrint = function(svgContent, x, y, width, height) {
        try {
            // Parse the SVG to modify if area is selected
            let finalSvgContent = svgContent;
            let svgWidth = 2000;
            let svgHeight = 2000;
            
            if (x !== null && y !== null && width !== null && height !== null) {
                // Create a viewBox that crops to the selected area
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;
                
                // Set viewBox to crop area
                svgElement.setAttribute('viewBox', `${x} ${y} ${width} ${height}`);
                svgElement.setAttribute('width', width);
                svgElement.setAttribute('height', height);
                
                svgWidth = width;
                svgHeight = height;
                
                // Serialize back to string
                finalSvgContent = new XMLSerializer().serializeToString(svgElement);
            }
            
            // Create a new window for printing with high-quality settings
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DFD Export - High Quality Print</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body { 
                            background: white;
                        }
                        
                        .print-container {
                            width: 100%;
                            height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 20px;
                        }
                        
                        svg {
                            max-width: 100%;
                            max-height: 100%;
                            height: auto;
                            border: 1px solid #ccc;
                            /* High-quality rendering hints */
                            shape-rendering: geometricPrecision;
                            text-rendering: geometricPrecision;
                            image-rendering: optimizeQuality;
                        }
                        
                        .print-info {
                            position: fixed;
                            top: 10px;
                            left: 10px;
                            background: #fff;
                            padding: 10px;
                            border: 2px solid #3b82f6;
                            border-radius: 8px;
                            font-family: Arial, sans-serif;
                            font-size: 14px;
                            z-index: 1000;
                        }
                        
                        .print-info strong {
                            color: #3b82f6;
                        }
                        
                        .print-buttons {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            display: flex;
                            gap: 10px;
                            z-index: 1000;
                        }
                        
                        .print-buttons button {
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        
                        .btn-print {
                            background: #3b82f6;
                            color: white;
                        }
                        
                        .btn-print:hover {
                            background: #2563eb;
                        }
                        
                        .btn-svg {
                            background: #10b981;
                            color: white;
                        }
                        
                        .btn-svg:hover {
                            background: #059669;
                        }
                        
                        @@media print {
                            body { 
                                padding: 0;
                            }
                            
                            .print-info,
                            .print-buttons {
                                display: none !important;
                            }
                            
                            .print-container {
                                padding: 0;
                                height: auto;
                                display: block;
                            }
                            
                            svg {
                                border: none;
                                width: 100% !important;
                                max-width: 100% !important;
                                height: auto !important;
                                display: block;
                                /* Maximum quality for print */
                                shape-rendering: geometricPrecision;
                                text-rendering: geometricPrecision;
                                color-rendering: optimizeQuality;
                            }
                            
                            @@page { 
                                margin: 0.5cm;
                                size: ${svgWidth > svgHeight ? 'landscape' : 'portrait'};
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-info">
                        <strong>💡 Pro Tip:</strong> For best quality, use "Save as PDF" instead of printing to a physical printer. 
                        SVG is vector-based and will be crisp at any zoom level!
                    </div>
                    
                    <div class="print-buttons">
                        <button class="btn-print" onclick="window.print()">🖨️ Print/Save PDF</button>
                        <button class="btn-svg" onclick="downloadSVG()">💾 Download SVG</button>
                    </div>
                    
                    <div class="print-container">
                        ${finalSvgContent}
                    </div>
                    
                    <script>
                        function downloadSVG() {
                            const svg = document.querySelector('svg');
                            const serializer = new XMLSerializer();
                            const svgString = serializer.serializeToString(svg);
                            const blob = new Blob([svgString], { type: 'image/svg+xml' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'diagram.svg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                        
                        // Auto-trigger print dialog after a delay
                        window.onload = function() {
                            setTimeout(() => {
                                // Don't auto-print, let user choose
                                console.log('Ready to print. Click the Print button or press Ctrl+P');
                            }, 500);
                        };
                        window.getScrollInfo = function(element) {
        return [element.scrollLeft, element.scrollTop, element.clientWidth, element.clientHeight];
    };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            console.log('Print preview opened with high-quality settings');
        } catch (error) {
            console.error('Error opening print dialog:', error);
            alert('Error opening print dialog: ' + error.message);
        }
    };

    // High-Resolution Print All - No selection required, maximum quality
    window.printAllHighResolution = function(svgContent) {
        try {
            // Parse SVG to get dimensions and enhance quality
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
            const svgElement = svgDoc.documentElement;
            
            // Get original dimensions
            const originalWidth = parseFloat(svgElement.getAttribute('width')) || 2000;
            const originalHeight = parseFloat(svgElement.getAttribute('height')) || 2000;
            
            // Set maximum quality attributes
            svgElement.setAttribute('shape-rendering', 'geometricPrecision');
            svgElement.setAttribute('text-rendering', 'geometricPrecision');
            svgElement.setAttribute('image-rendering', 'optimizeQuality');
            svgElement.setAttribute('color-rendering', 'optimizeQuality');
            
            // Serialize back to string
            const enhancedSvgContent = new XMLSerializer().serializeToString(svgElement);
            
            // Create high-resolution print window
            const printWindow = window.open('', '_blank', 'width=1400,height=900');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DFD Print All - Maximum Resolution</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body { 
                            background: white;
                            font-family: Arial, sans-serif;
                        }
                        
                        .print-container {
                            width: 100%;
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 40px;
                        }
                        
                        svg {
                            max-width: 100%;
                            max-height: 90vh;
                            height: auto;
                            border: 2px solid #e5e7eb;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                            background: white;
                            /* Maximum quality rendering */
                            shape-rendering: geometricPrecision;
                            text-rendering: geometricPrecision;
                            image-rendering: optimizeQuality;
                            color-rendering: optimizeQuality;
                        }
                        
                        .print-header {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 15px 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                            z-index: 1000;
                        }
                        
                        .print-header h1 {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0;
                        }
                        
                        .quality-badge {
                            background: rgba(255, 255, 255, 0.2);
                            padding: 5px 15px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: bold;
                            backdrop-filter: blur(10px);
                        }
                        
                        .print-info {
                            position: fixed;
                            bottom: 20px;
                            left: 20px;
                            background: white;
                            padding: 15px 20px;
                            border: 2px solid #10b981;
                            border-radius: 12px;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                            max-width: 400px;
                            z-index: 1000;
                        }
                        
                        .print-info h3 {
                            color: #10b981;
                            margin: 0 0 10px 0;
                            font-size: 16px;
                        }
                        
                        .print-info p {
                            margin: 5px 0;
                            font-size: 13px;
                            color: #374151;
                            line-height: 1.5;
                        }
                        
                        .print-buttons {
                            position: fixed;
                            top: 70px;
                            right: 20px;
                            display: flex;
                            flex-direction: column;
                            gap: 10px;
                            z-index: 1000;
                        }
                        
                        .print-buttons button {
                            padding: 12px 24px;
                            border: none;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                        }
                        
                        .btn-print {
                            background: #3b82f6;
                            color: white;
                        }
                        
                        .btn-print:hover {
                            background: #2563eb;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
                        }
                        
                        .btn-svg {
                            background: #10b981;
                            color: white;
                        }
                        
                        .btn-svg:hover {
                            background: #059669;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
                        }
                        
                        .btn-png {
                            background: #8b5cf6;
                            color: white;
                        }
                        
                        .btn-png:hover {
                            background: #7c3aed;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
                        }
                        
                        @@media print {
                            body { 
                                padding: 0;
                                background: white;
                            }
                            
                            .print-header,
                            .print-info,
                            .print-buttons {
                                display: none !important;
                            }
                            
                            .print-container {
                                padding: 0;
                                min-height: 0;
                                display: block;
                            }
                            
                            svg {
                                border: none !important;
                                box-shadow: none !important;
                                width: 100% !important;
                                max-width: 100% !important;
                                height: auto !important;
                                max-height: none !important;
                                display: block;
                                /* Ultra-high quality for print */
                                shape-rendering: geometricPrecision !important;
                                text-rendering: geometricPrecision !important;
                                color-rendering: optimizeQuality !important;
                                image-rendering: optimizeQuality !important;
                            }
                            
                            @@page { 
                                margin: 1cm;
                                size: ${originalWidth > originalHeight ? 'A3 landscape' : 'A3 portrait'};
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>🖨️ Print All - Maximum Resolution</h1>
                        <div class="quality-badge">⚡ ULTRA HIGH QUALITY</div>
                    </div>
                    
                    <div class="print-info">
                        <h3>💎 Maximum Quality Mode</h3>
                        <p><strong>Canvas size:</strong> ${originalWidth} × ${originalHeight} px</p>
                        <p><strong>Format:</strong> Vector (infinite resolution)</p>
                        <p><strong>Recommended:</strong> Download SVG for perfect quality at any size!</p>
                    </div>
                    
                    <div class="print-buttons">
                        <button class="btn-print" onclick="window.print()">
                            <span>🖨️</span> Print / Save PDF
                        </button>
                        <button class="btn-svg" onclick="downloadSVG()">
                            <span>💾</span> Download SVG
                        </button>
                        <button class="btn-png" onclick="downloadPNG()">
                            <span>🖼️</span> Download PNG (High-Res)
                        </button>
                    </div>
                    
                    <div class="print-container">
                        ${enhancedSvgContent}
                    </div>
<div class="dfd-editor" onkeydown="HandleKeyboardShortcut" tabindex="0">                    
                    <script>
                        function downloadSVG() {
                            const svg = document.querySelector('svg');
                            const serializer = new XMLSerializer();
                            const svgString = serializer.serializeToString(svg);
                            const blob = new Blob([svgString], { type: 'image/svg+xml' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'diagram-full-resolution.svg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                        
                        function downloadPNG() {
                            const svg = document.querySelector('svg');
                            const canvas = document.createElement('canvas');
                            
                            // High resolution: 3x for crisp output
                            const scale = 3;
                            canvas.width = ${originalWidth} * scale;
                            canvas.height = ${originalHeight} * scale;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.scale(scale, scale);
                            
                            const svgString = new XMLSerializer().serializeToString(svg);
                            const img = new Image();
                            const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                            const url = URL.createObjectURL(blob);
                            
                            img.onload = function() {
                                ctx.drawImage(img, 0, 0);
                                canvas.toBlob(function(pngBlob) {
                                    const pngUrl = URL.createObjectURL(pngBlob);
                                    const a = document.createElement('a');
                                    a.href = pngUrl;
                                    a.download = 'diagram-high-resolution.png';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(pngUrl);
                                    URL.revokeObjectURL(url);
                                }, 'image/png', 1.0);
                            };
                            
                            img.src = url;
                        }
                        
                        window.onload = function() {
                            console.log('High-resolution print preview ready');
                            console.log('Canvas size: ${originalWidth} × ${originalHeight} px');
                            console.log('Quality mode: MAXIMUM');
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            console.log('Maximum resolution print window opened');
        } catch (error) {
            console.error('Error in Print All:', error);
            alert('Error in Print All: ' + error.message);
        }
    };

    // Canvas-based PDF Export - Renders SVG to canvas first for reliable PDF output
    window.exportPdfViaCanvas = async function(svgContent) {
        try {
            // Parse and enhance the SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
            const svgElement = svgDoc.documentElement;
            
            // Get dimensions
            const width = parseFloat(svgElement.getAttribute('width')) || 2000;
            const height = parseFloat(svgElement.getAttribute('height')) || 2000;
            
            // Find bounds of actual content
            let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
            const allElements = svgElement.querySelectorAll('rect, ellipse, polygon, path, text');
            allElements.forEach(el => {
                const bbox = {
                    x: parseFloat(el.getAttribute('x') || el.getAttribute('cx') || '0') - (parseFloat(el.getAttribute('rx') || '0')),
                    y: parseFloat(el.getAttribute('y') || el.getAttribute('cy') || '0') - (parseFloat(el.getAttribute('ry') || '0')),
                    width: parseFloat(el.getAttribute('width') || el.getAttribute('rx') || '0') * 2,
                    height: parseFloat(el.getAttribute('height') || el.getAttribute('ry') || '0') * 2
                };
                if (bbox.x < minX) minX = bbox.x;
                if (bbox.y < minY) minY = bbox.y;
                if (bbox.x + bbox.width > maxX) maxX = bbox.x + bbox.width;
                if (bbox.y + bbox.height > maxY) maxY = bbox.y + bbox.height;
            });
            
            // Add padding
            const padding = 50;
            minX = Math.max(0, minX - padding);
            minY = Math.max(0, minY - padding);
            maxX = Math.min(width, maxX + padding);
            maxY = Math.min(height, maxY + padding);
            
            const cropWidth = maxX - minX || width;
            const cropHeight = maxY - minY || height;
            
            // Set viewBox for cropping
            svgElement.setAttribute('viewBox', `${minX} ${minY} ${cropWidth} ${cropHeight}`);
            svgElement.setAttribute('width', cropWidth);
            svgElement.setAttribute('height', cropHeight);
            
            // Ensure proper rendering attributes
            svgElement.setAttribute('shape-rendering', 'geometricPrecision');
            svgElement.setAttribute('text-rendering', 'geometricPrecision');
            
            const finalSvg = new XMLSerializer().serializeToString(svgElement);
            
            // Create canvas with high DPI
            const scale = 2; // 2x for better quality
            const canvas = document.createElement('canvas');
            canvas.width = cropWidth * scale;
            canvas.height = cropHeight * scale;
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, cropWidth, cropHeight);
            
            // Create image from SVG
            return new Promise((resolve, reject) => {
                const img = new Image();
                const blob = new Blob([finalSvg], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, cropWidth, cropHeight);
                    URL.revokeObjectURL(url);
                    
                    // Generate PDF using canvas data URL
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    
                    // Calculate PDF page size (fit to A4 or custom)
                    const pdfWidth = 297; // A4 landscape width in mm
                    const pdfHeight = 210; // A4 landscape height in mm
                    const imgAspect = cropWidth / cropHeight;
                    const pdfAspect = pdfWidth / pdfHeight;
                    
                    let finalWidth, finalHeight, offsetX, offsetY;
                    if (imgAspect > pdfAspect) {
                        finalWidth = pdfWidth - 20;
                        finalHeight = finalWidth / imgAspect;
                        offsetX = 10;
                        offsetY = (pdfHeight - finalHeight) / 2;
                    } else {
                        finalHeight = pdfHeight - 20;
                        finalWidth = finalHeight * imgAspect;
                        offsetX = (pdfWidth - finalWidth) / 2;
                        offsetY = 10;
                    }
                    
                    // Create download link with PNG (works as fallback)
                    const a = document.createElement('a');
                    a.href = imgData;
                    a.download = 'diagram-export.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    console.log('PNG exported successfully');
                    resolve();
                };
                
                img.onerror = function(e) {
                    URL.revokeObjectURL(url);
                    console.error('Error loading SVG:', e);
                    reject(new Error('Failed to render SVG'));
                };
                
                img.src = url;
            });
        } catch (error) {
            console.error('Error in canvas PDF export:', error);
            alert('Error exporting: ' + error.message);
        }
    };

    // Get scroll info for minimap viewport tracking
    window.getScrollInfo = function(element) {
        if (!element) return [0, 0, 800, 600];
        return [element.scrollLeft, element.scrollTop, element.clientWidth, element.clientHeight];
    };

    // Get canvas bounding rect for coordinate conversion
    window.getCanvasBounds = function(element) {
        if (!element) return [0, 0, 800, 600];
        var rect = element.getBoundingClientRect();
        return [rect.left, rect.top, rect.width, rect.height];
    };

    // Scroll canvas to specific position
    window.scrollCanvasTo = function(element, x, y) {
        if (!element) return;
        element.scrollLeft = x;
        element.scrollTop = y;
    };

    // Scroll canvas horizontally by delta amount (for wheel events)
    window.scrollCanvasHorizontal = function(element, delta) {
        if (!element) return;
        element.scrollLeft += delta;
    };

    // Get minimap element bounds for coordinate conversion
    window.getMinimapBounds = function(element) {
        if (!element) return [0, 0, 150, 150];
        var rect = element.getBoundingClientRect();
        return [rect.left, rect.top, rect.width, rect.height];
    };
</script>

